<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rovigoal - Area Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #f0f2f5; padding: 20px; }
        
        .btn-home {
            position: fixed; top: 20px; right: 20px; background: #1e3c72; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .btn-home:hover { background: #2a5298; }
        
        .header {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%); color: white; padding: 20px;
            border-radius: 10px; margin-bottom: 30px; text-align: center;
        }
        
        .menu-admin {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
            max-width: 800px; margin: 0 auto 40px;
        }
        
        .menu-btn {
            background: white; padding: 60px 20px; border-radius: 15px; text-align: center; font-size: 1.5em;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease; border: 3px solid transparent;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .menu-btn:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .menu-btn:nth-child(1) { background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%); color: white; }
        .menu-btn:nth-child(2) { background: linear-gradient(135deg, #32CD32 0%, #228B22 100%); color: white; }
        .icona { font-size: 3em; display: block; margin-bottom: 15px; }
        
        .sezione {
            background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px; display: none;
        }
        .sezione.attiva { display: block; }
        
        h2 { color: #333; margin-bottom: 20px; border-bottom: 2px solid #FF4500; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        
        .btn {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%); color: white; border: none;
            padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
            margin-top: 10px; transition: all 0.3s ease;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-full { width: 100%; }
        .btn-back { background: #1e3c72; margin: 20px auto; display: block; padding: 12px 30px; }
        .btn-green { background: linear-gradient(135deg, #32CD32 0%, #228B22 100%); }
        .btn-blue { background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%); }
        .btn-red { background: linear-gradient(135deg, #FF0000 0%, #DC143C 100%); }
        .btn-yellow { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #333; }
        
        .giocatori-partita { border: 2px solid #ddd; padding: 15px; border-radius: 8px; margin-top: 15px; background: #f9f9f9; }
        .giocatore-item { margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #eee; }
        .giocatore-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .eventi-giocatore { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-evento { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .btn-gol { background: #32CD32; color: white; }
        .btn-amm { background: #FFD700; color: #333; }
        .btn-esp { background: #DC143C; color: white; }
        
        .eventi-salvati { margin-top: 20px; padding: 15px; background: #e8f4ff; border-radius: 8px; border: 1px solid #b3d9ff; }
        .evento-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #cce0ff; }
        .evento-item:last-child { border-bottom: none; }
        .btn-rimuovi { background: #ff6666; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        
        .selezione-migliori { 
            margin-top: 20px; padding: 20px; 
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%); 
            border-radius: 10px; border: 2px solid #4dabf7; 
            box-shadow: 0 5px 15px rgba(77, 171, 247, 0.2); 
        }
        .migliori-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        @media (max-width: 768px) { .migliori-row { grid-template-columns: 1fr; } }
        
        .voto-container { margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd; }
        .voto-stelle { display: flex; gap: 5px; margin-top: 5px; }
        .stella { font-size: 24px; cursor: pointer; color: #ddd; transition: color 0.2s; }
        .stella.selezionata { color: #FFD700; }
        
        .hidden { display: none; }
        .avviso { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .avviso.errore { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        
        .gestione-partite { margin-top: 30px; }
        .partita-item { 
            background: white; padding: 15px; border-radius: 8px; 
            margin-bottom: 10px; border: 1px solid #ddd; 
            transition: all 0.3s ease; 
        }
        .partita-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .partita-header { display: flex; justify-content: space-between; align-items: center; }
        .partita-azioni { display: flex; gap: 10px; margin-top: 10px; }
        .btn-modifica { background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .btn-elimina { background: #ff6666; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 50px auto; padding: 20px; border-radius: 10px; max-width: 600px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        
        .selezione-obbligatoria {
            border: 2px solid #ff6b6b;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: #ff6b6b; }
            50% { border-color: #ffa8a8; }
            100% { border-color: #ff6b6b; }
        }
        
        .conferma-eliminazione {
            background: #fff5f5;
            border: 2px solid #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .riepilogo-gol {
            margin-top: 10px;
            padding: 10px;
            background: #f0fff0;
            border-radius: 5px;
            border: 1px solid #32CD32;
        }
        
        .counter-display {
            display: inline-block;
            margin: 0 5px;
            padding: 2px 8px;
            background: #333;
            color: white;
            border-radius: 3px;
            min-width: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <button class="btn-home" onclick="tornaHome()">üè† HOME</button>
    
    <div class="header">
        <h1>üîß AREA ADMIN ROVIGOAL</h1>
        <p>Gestione completa del torneo</p>
    </div>
    
    <!-- MENU PRINCIPALE -->
    <div class="menu-admin" id="menuPrincipale">
        <div class="menu-btn" onclick="mostraSezione('gestione')"><span class="icona">üë•</span>GESTIONE SQUADRE & GIOCATORI</div>
        <div class="menu-btn" onclick="mostraSezione('partite')"><span class="icona">‚öΩ</span>GESTIONE PARTITE</div>
        <div class="menu-btn" onclick="mostraSezione('gestionePartite')"><span class="icona">üìã</span>GESTISCI PARTITE SALVATE</div>
    </div>
    
    <!-- SEZIONE 1: GESTIONE SQUADRE E GIOCATORI -->
    <div id="gestione" class="sezione">
        <h2>üë• GESTIONE SQUADRE & GIOCATORI</h2>
        
        <div class="form-group">
            <h3>‚ûï AGGIUNGI SQUADRA</h3>
            <input type="text" id="nomeSquadra" placeholder="Nome Squadra (Es: Rovigo FC)">
            <input type="text" id="allenatore" placeholder="Allenatore">
            <input type="text" id="colori" placeholder="Colori (Es: Rosso-Blu)">
            <button class="btn btn-green btn-full" onclick="aggiungiSquadra()">AGGIUNGI SQUADRA</button>
        </div>
        
        <div class="form-group">
            <h3>üë§ AGGIUNGI GIOCATORE</h3>
            <select id="squadraGiocatore"><option value="">Seleziona Squadra</option></select>
            <input type="text" id="nomeGiocatore" placeholder="Nome e Cognome">
            <input type="number" id="numeroMaglia" placeholder="Numero Maglia">
            <select id="ruolo"><option value="Portiere">Portiere</option><option value="Giocatore">Giocatore</option></select>
            <button class="btn btn-blue btn-full" onclick="aggiungiGiocatore()">AGGIUNGI GIOCATORE</button>
        </div>
        
        <div class="form-group">
            <h3>üóëÔ∏è ELIMINA DATI</h3>
            <select id="tipoElimina" onchange="mostraOpzioniElimina()">
                <option value="">Cosa vuoi eliminare?</option>
                <option value="giocatore">Elimina Giocatore</option>
                <option value="squadra">Elimina Squadra</option>
                <option value="tutto">Elimina TUTTO</option>
            </select>
            <div id="opzioniElimina" class="hidden"></div>
            <button class="btn btn-red btn-full hidden" id="btnElimina" onclick="eseguiEliminazione()">ELIMINA</button>
        </div>
        
        <button class="btn btn-back" onclick="tornaMenu()">‚Üê TORNA AL MENU</button>
    </div>
    
    <!-- SEZIONE 2: GESTIONE PARTITE -->
    <div id="partite" class="sezione">
        <h2>‚öΩ GESTIONE PARTITE</h2>
        
        <div class="form-group">
            <h3>üèüÔ∏è SELEZIONA PARTITA</h3>
            <select id="squadraCasa" onchange="caricaGiocatoriPartita()"><option value="">Squadra Casa</option></select>
            <select id="squadraOspite" onchange="caricaGiocatoriPartita()"><option value="">Squadra Ospite</option></select>
        </div>
        
        <div class="form-group">
            <h3>üìä RISULTATO PARTITA</h3>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div style="flex: 1;"><label>Gol Casa:</label><input type="number" id="golCasa" min="0" value="0" style="font-size: 24px; text-align: center;"></div>
                <div style="font-size: 24px; font-weight: bold;">-</div>
                <div style="flex: 1;"><label>Gol Ospite:</label><input type="number" id="golOspite" min="0" value="0" style="font-size: 24px; text-align: center;"></div>
            </div>
        </div>
        
        <!-- LISTA GIOCATORI CASA -->
        <div id="giocatoriCasaContainer" class="hidden">
            <h3>üë• GIOCATORI CASA</h3>
            <div id="giocatoriCasa" class="giocatori-partita"></div>
        </div>
        
        <!-- LISTA GIOCATORI OSPITE -->
        <div id="giocatoriOspiteContainer" class="hidden">
            <h3>üë• GIOCATORI OSPITE</h3>
            <div id="giocatoriOspite" class="giocatori-partita"></div>
        </div>
        
        <!-- SELEZIONE MIGLIORI -->
        <div id="selezioneMiglioriContainer" class="selezione-migliori hidden">
            <h3>üèÜ SELEZIONA I MIGLIORI</h3>
            <div class="avviso">
                <strong>‚ö†Ô∏è IMPORTANTE:</strong> Seleziona SOLO UN miglior giocatore e SOLO UN miglior portiere (se presente)
            </div>
            <div class="migliori-row">
                <div>
                    <label>Miglior Giocatore (obbligatorio):</label>
                    <select id="migliorGiocatore">
                        <option value="">-- Seleziona miglior giocatore --</option>
                    </select>
                    <div class="voto-container">
                        <label>Voto (1-10):</label>
                        <div class="voto-stelle" id="voto-miglior-giocatore"></div>
                        <span>Voto: <span id="voto-miglior-giocatore-attuale">N/A</span></span>
                    </div>
                </div>
                <div>
                    <label>Miglior Portiere (se presente):</label>
                    <select id="migliorPortiere">
                        <option value="">-- Seleziona miglior portiere --</option>
                    </select>
                    <div class="voto-container">
                        <label>Voto (1-10):</label>
                        <div class="voto-stelle" id="voto-miglior-portiere"></div>
                        <span>Voto: <span id="voto-miglior-portiere-attuale">N/A</span></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- EVENTI SALVATI -->
        <div id="eventiSalvatiContainer" class="hidden">
            <h3>üìù EVENTI REGISTRATI</h3>
            <div id="eventiSalvati" class="eventi-salvati">Nessun evento registrato</div>
            <div class="avviso" id="avvisoGol">‚ö†Ô∏è Controlla che il totale gol dei giocatori corrisponda al risultato</div>
        </div>
        
        <!-- BOTTONI AZIONE -->
        <div style="margin-top: 20px;">
            <button class="btn btn-yellow" onclick="resetPartita()">üîÑ RESET PARTITA</button>
            <button class="btn btn-green" onclick="salvaPartita()">üíæ SALVA PARTITA</button>
        </div>
        
        <button class="btn btn-back" onclick="tornaMenu()">‚Üê TORNA AL MENU</button>
    </div>
    
    <!-- SEZIONE 3: GESTIONE PARTITE SALVATE -->
    <div id="gestionePartite" class="sezione">
        <h2>üìã GESTISCI PARTITE SALVATE</h2>
        <div id="listaPartite" class="gestione-partite"></div>
        <button class="btn btn-back" onclick="tornaMenu()">‚Üê TORNA AL MENU</button>
    </div>

    <!-- MODAL MODIFICA PARTITA -->
    <div id="modalModifica" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è MODIFICA PARTITA</h2>
                <button class="close-modal" onclick="chiudiModal()">√ó</button>
            </div>
            <div id="modalContenuto"></div>
        </div>
    </div>

    <script>
        // DATABASE
        let database = {
            squadre: JSON.parse(localStorage.getItem('rovigoal_squadre')) || [],
            giocatori: JSON.parse(localStorage.getItem('rovigoal_giocatori')) || [],
            partite: JSON.parse(localStorage.getItem('rovigoal_partite')) || []
        };
        
        // PARTITA IN CORSO
        let partitaInCorso = {
            eventi: [], // Array di oggetti: {giocatoreId, tipo: 'gol'/'amm'/'esp', squadra}
            migliori: { giocatore: null, votoGiocatore: 0, portiere: null, votoPortiere: 0 }
        };
        
        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            caricaSquadreNeiSelect();
            inizializzaVoti();
        });
        
        function inizializzaVoti() {
            // Stelle per miglior giocatore
            const stelleGiocatore = document.getElementById('voto-miglior-giocatore');
            stelleGiocatore.innerHTML = [1,2,3,4,5,6,7,8,9,10].map(v => 
                `<span class="stella" onclick="assegnaVoto('giocatore', ${v})">‚òÖ</span>`
            ).join('');
            
            // Stelle per miglior portiere
            const stellePortiere = document.getElementById('voto-miglior-portiere');
            stellePortiere.innerHTML = [1,2,3,4,5,6,7,8,9,10].map(v => 
                `<span class="stella" onclick="assegnaVoto('portiere', ${v})">‚òÖ</span>`
            ).join('');
        }
        
        function assegnaVoto(tipo, voto) {
            const stelle = document.querySelectorAll(`#voto-miglior-${tipo} .stella`);
            stelle.forEach((stella, index) => stella.classList.toggle('selezionata', index < voto));
            document.getElementById(`voto-miglior-${tipo}-attuale`).textContent = voto;
            
            if (tipo === 'giocatore') {
                partitaInCorso.migliori.votoGiocatore = voto;
            } else {
                partitaInCorso.migliori.votoPortiere = voto;
            }
        }
        
        function tornaHome() { window.location.href = 'main.html'; }
        
        function mostraSezione(sezione) {
            document.getElementById('menuPrincipale').style.display = 'none';
            document.getElementById('gestione').classList.remove('attiva');
            document.getElementById('partite').classList.remove('attiva');
            document.getElementById('gestionePartite').classList.remove('attiva');
            document.getElementById(sezione).classList.add('attiva');
            
            if(sezione === 'gestione') {
                caricaSquadreNeiSelect();
            } else if(sezione === 'gestionePartite') {
                caricaPartiteSalvate();
            }
        }
        
        function tornaMenu() {
            document.getElementById('menuPrincipale').style.display = 'grid';
            document.getElementById('gestione').classList.remove('attiva');
            document.getElementById('partite').classList.remove('attiva');
            document.getElementById('gestionePartite').classList.remove('attiva');
        }
        
        function caricaSquadreNeiSelect() {
            const selects = ['squadraGiocatore', 'squadraCasa', 'squadraOspite'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if(!select) return;
                
                const valoreSalvato = select.value;
                select.innerHTML = '<option value="">Seleziona Squadra</option>';
                
                database.squadre.forEach(squadra => {
                    const option = document.createElement('option');
                    option.value = squadra.nome;
                    option.textContent = squadra.nome;
                    select.appendChild(option);
                });
                
                if(valoreSalvato && database.squadre.some(s => s.nome === valoreSalvato)) {
                    select.value = valoreSalvato;
                }
            });
        }
        
        function aggiungiSquadra() {
            const nome = document.getElementById('nomeSquadra').value.trim();
            const allenatore = document.getElementById('allenatore').value.trim();
            const colori = document.getElementById('colori').value.trim();
            
            if(!nome) { alert("Inserisci il nome della squadra!"); return; }
            if(database.squadre.some(s => s.nome.toLowerCase() === nome.toLowerCase())) {
                alert(`La squadra "${nome}" esiste gi√†!`); return;
            }
            
            database.squadre.push({
                id: Date.now(), nome: nome, allenatore: allenatore || "Non specificato",
                colori: colori || "Non specificati", punti: 0, partiteGiocate: 0,
                vittorie: 0, pareggi: 0, sconfitte: 0, golFatti: 0, golSubiti: 0
            });
            
            salvaDatabase();
            caricaSquadreNeiSelect();
            document.getElementById('nomeSquadra').value = '';
            document.getElementById('allenatore').value = '';
            document.getElementById('colori').value = '';
            alert(`Squadra "${nome}" aggiunta con successo!`);
        }
        
        function aggiungiGiocatore() {
            const squadra = document.getElementById('squadraGiocatore').value;
            const nome = document.getElementById('nomeGiocatore').value.trim();
            const numero = document.getElementById('numeroMaglia').value;
            const ruolo = document.getElementById('ruolo').value;
            
            if(!squadra || !nome) { alert("Compila tutti i campi obbligatori!"); return; }
            
            database.giocatori.push({
                id: Date.now(), nome: nome, numero: numero || null, ruolo: ruolo, squadra: squadra,
                gol: 0, ammonizioni: 0, espulsioni: 0, punteggioTotale: 0,
                premiMigliorGiocatore: 0, premiMigliorPortiere: 0
            });
            
            salvaDatabase();
            document.getElementById('nomeGiocatore').value = '';
            document.getElementById('numeroMaglia').value = '';
            alert(`Giocatore "${nome}" aggiunto alla squadra ${squadra}!`);
        }
        
        function caricaGiocatoriPartita() {
            const squadraCasa = document.getElementById('squadraCasa').value;
            const squadraOspite = document.getElementById('squadraOspite').value;
            
            if (!squadraCasa || !squadraOspite) {
                document.getElementById('giocatoriCasaContainer').classList.add('hidden');
                document.getElementById('giocatoriOspiteContainer').classList.add('hidden');
                document.getElementById('selezioneMiglioriContainer').classList.add('hidden');
                return;
            }
            
            // Carica giocatori casa
            caricaListaGiocatori('Casa', squadraCasa, 'giocatoriCasa');
            document.getElementById('giocatoriCasaContainer').classList.remove('hidden');
            
            // Carica giocatori ospite
            caricaListaGiocatori('Ospite', squadraOspite, 'giocatoriOspite');
            document.getElementById('giocatoriOspiteContainer').classList.remove('hidden');
            
            // Carica selezione migliori
            caricaSelezioneMigliori(squadraCasa, squadraOspite);
            document.getElementById('selezioneMiglioriContainer').classList.remove('hidden');
            
            // Mostra eventi salvati
            document.getElementById('eventiSalvatiContainer').classList.remove('hidden');
        }
        
        function caricaListaGiocatori(tipo, nomeSquadra, containerId) {
            const giocatoriSquadra = database.giocatori.filter(g => g.squadra === nomeSquadra);
            const container = document.getElementById(containerId);
            
            if(giocatoriSquadra.length === 0) {
                container.innerHTML = '<p class="avviso">Nessun giocatore registrato per questa squadra</p>';
                return;
            }
            
            let html = '';
            giocatoriSquadra.forEach(giocatore => {
                // Conta eventi per questo giocatore
                const golCount = partitaInCorso.eventi.filter(e => 
                    e.giocatoreId === giocatore.id && e.tipo === 'gol' && e.squadra === tipo.toLowerCase()
                ).length;
                
                const ammCount = partitaInCorso.eventi.filter(e => 
                    e.giocatoreId === giocatore.id && e.tipo === 'amm' && e.squadra === tipo.toLowerCase()
                ).length;
                
                const espCount = partitaInCorso.eventi.filter(e => 
                    e.giocatoreId === giocatore.id && e.tipo === 'esp' && e.squadra === tipo.toLowerCase()
                ).length;
                
                html += `
                    <div class="giocatore-item">
                        <div class="giocatore-header">
                            <div>
                                <strong>${giocatore.nome}</strong>
                                <small>(${giocatore.ruolo} #${giocatore.numero || 'N/A'})</small>
                            </div>
                            <div>
                                <span class="counter-display">‚öΩ ${golCount}</span>
                                <span class="counter-display">üü® ${ammCount}</span>
                                <span class="counter-display">üü• ${espCount}</span>
                            </div>
                        </div>
                        <div class="eventi-giocatore">
                            <button class="btn-evento btn-gol" onclick="aggiungiEvento(${giocatore.id}, 'gol', '${tipo.toLowerCase()}')">+ Gol</button>
                            <button class="btn-evento btn-amm" onclick="aggiungiEvento(${giocatore.id}, 'amm', '${tipo.toLowerCase()}')">+ Ammonizione</button>
                            <button class="btn-evento btn-esp" onclick="aggiungiEvento(${giocatore.id}, 'esp', '${tipo.toLowerCase()}')">+ Espulsione</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function caricaSelezioneMigliori(squadraCasa, squadraOspite) {
            const giocatoriPartita = database.giocatori.filter(g => 
                g.squadra === squadraCasa || g.squadra === squadraOspite
            );
            
            // Popola miglior giocatore (solo giocatori di campo)
            const selectGiocatore = document.getElementById('migliorGiocatore');
            selectGiocatore.innerHTML = '<option value="">-- Seleziona miglior giocatore --</option>';
            
            const giocatoriCampo = giocatoriPartita.filter(g => g.ruolo === 'Giocatore');
            giocatoriCampo.forEach(g => {
                const option = document.createElement('option');
                option.value = g.id;
                option.textContent = `${g.nome} (${g.squadra})`;
                selectGiocatore.appendChild(option);
            });
            
            // Popola miglior portiere (solo portieri)
            const selectPortiere = document.getElementById('migliorPortiere');
            selectPortiere.innerHTML = '<option value="">-- Seleziona miglior portiere --</option>';
            
            const portieri = giocatoriPartita.filter(g => g.ruolo === 'Portiere');
            portieri.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.nome} (${p.squadra})`;
                selectPortiere.appendChild(option);
            });
            
            // Reset voti
            partitaInCorso.migliori = { giocatore: null, votoGiocatore: 0, portiere: null, votoPortiere: 0 };
            document.getElementById('voto-miglior-giocatore-attuale').textContent = 'N/A';
            document.getElementById('voto-miglior-portiere-attuale').textContent = 'N/A';
            document.querySelectorAll('.stella.selezionata').forEach(s => s.classList.remove('selezionata'));
        }
        
        // Gestione cambio selezioni migliori
        document.getElementById('migliorGiocatore').addEventListener('change', function() {
            partitaInCorso.migliori.giocatore = this.value ? parseInt(this.value) : null;
        });
        
        document.getElementById('migliorPortiere').addEventListener('change', function() {
            partitaInCorso.migliori.portiere = this.value ? parseInt(this.value) : null;
        });
        
        function aggiungiEvento(giocatoreId, tipo, squadra) {
            const giocatore = database.giocatori.find(g => g.id === giocatoreId);
            if (!giocatore) return;
            
            partitaInCorso.eventi.push({
                id: Date.now(),
                giocatoreId: giocatoreId,
                giocatoreNome: giocatore.nome,
                tipo: tipo,
                squadra: squadra,
                timestamp: new Date().toLocaleTimeString()
            });
            
            aggiornaEventiSalvati();
            caricaGiocatoriPartita(); // Ricarica per aggiornare i contatori
            controllaCorrispondenzaGol();
        }
        
        function aggiornaEventiSalvati() {
            const container = document.getElementById('eventiSalvati');
            
            if(partitaInCorso.eventi.length === 0) {
                container.innerHTML = '<p>Nessun evento registrato</p>';
                return;
            }
            
            let html = '';
            partitaInCorso.eventi.forEach((evento, index) => {
                let icona = '', testo = '';
                switch(evento.tipo) {
                    case 'gol': icona = '‚öΩ'; testo = `Gol di ${evento.giocatoreNome}`; break;
                    case 'amm': icona = 'üü®'; testo = `Ammonizione per ${evento.giocatoreNome}`; break;
                    case 'esp': icona = 'üü•'; testo = `Espulsione di ${evento.giocatoreNome}`; break;
                }
                html += `
                    <div class="evento-item">
                        <span>${icona} ${testo} (${evento.squadra})</span>
                        <button class="btn-rimuovi" onclick="rimuoviEvento(${index})">Rimuovi</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function rimuoviEvento(index) {
            partitaInCorso.eventi.splice(index, 1);
            aggiornaEventiSalvati();
            caricaGiocatoriPartita();
            controllaCorrispondenzaGol();
        }
        
        function controllaCorrispondenzaGol() {
            const golCasa = parseInt(document.getElementById('golCasa').value) || 0;
            const golOspite = parseInt(document.getElementById('golOspite').value) || 0;
            
            const golAssegnatiCasa = partitaInCorso.eventi.filter(e => 
                e.tipo === 'gol' && e.squadra === 'casa'
            ).length;
            
            const golAssegnatiOspite = partitaInCorso.eventi.filter(e => 
                e.tipo === 'gol' && e.squadra === 'ospite'
            ).length;
            
            const avviso = document.getElementById('avvisoGol');
            if(golAssegnatiCasa !== golCasa || golAssegnatiOspite !== golOspite) {
                avviso.textContent = `‚ö†Ô∏è ATTENZIONE: Gol assegnati non corrispondono! Casa: ${golAssegnatiCasa}/${golCasa} - Ospite: ${golAssegnatiOspite}/${golOspite}`;
                avviso.classList.add('errore');
            } else {
                avviso.textContent = '‚úÖ Gol assegnati correttamente!';
                avviso.classList.remove('errore');
            }
        }
        
        function resetPartita() {
            if(confirm("Vuoi resettare tutti i dati della partita in corso?")) {
                partitaInCorso = {
                    eventi: [],
                    migliori: { giocatore: null, votoGiocatore: 0, portiere: null, votoPortiere: 0 }
                };
                
                document.getElementById('golCasa').value = 0;
                document.getElementById('golOspite').value = 0;
                document.getElementById('squadraCasa').value = '';
                document.getElementById('squadraOspite').value = '';
                document.getElementById('giocatoriCasaContainer').classList.add('hidden');
                document.getElementById('giocatoriOspiteContainer').classList.add('hidden');
                document.getElementById('selezioneMiglioriContainer').classList.add('hidden');
                document.getElementById('eventiSalvatiContainer').classList.add('hidden');
                
                document.getElementById('voto-miglior-giocatore-attuale').textContent = 'N/A';
                document.getElementById('voto-miglior-portiere-attuale').textContent = 'N/A';
                document.querySelectorAll('.stella.selezionata').forEach(s => s.classList.remove('selezionata'));
                
                alert("Partita resettata!");
            }
        }
        
        function salvaPartita() {
            const squadraCasa = document.getElementById('squadraCasa').value;
            const squadraOspite = document.getElementById('squadraOspite').value;
            const golCasa = parseInt(document.getElementById('golCasa').value) || 0;
            const golOspite = parseInt(document.getElementById('golOspite').value) || 0;
            
            if(!squadraCasa || !squadraOspite) { alert("Seleziona entrambe le squadre!"); return; }
            if(squadraCasa === squadraOspite) { alert("Seleziona due squadre diverse!"); return; }
            
            // Controllo gol assegnati
            const golAssegnatiCasa = partitaInCorso.eventi.filter(e => 
                e.tipo === 'gol' && e.squadra === 'casa'
            ).length;
            
            const golAssegnatiOspite = partitaInCorso.eventi.filter(e => 
                e.tipo === 'gol' && e.squadra === 'ospite'
            ).length;
            
            if(golAssegnatiCasa !== golCasa || golAssegnatiOspite !== golOspite) {
                alert(`Gol assegnati non corrispondono!\nCasa: ${golAssegnatiCasa}/${golCasa}\nOspite: ${golAssegnatiOspite}/${golOspite}`);
                return;
            }
            
            // Controllo miglior giocatore
            if(!partitaInCorso.migliori.giocatore) {
                alert("Devi selezionare un miglior giocatore!"); 
                document.getElementById('migliorGiocatore').classList.add('selezione-obbligatoria');
                return;
            }
            
            if(partitaInCorso.migliori.votoGiocatore === 0) {
                alert("Devi assegnare un voto al miglior giocatore!"); 
                return;
            }
            
            // Calcola punti squadre
            let puntiCasa = 0, puntiOspite = 0;
            if(golCasa > golOspite) { puntiCasa = 3; }
            else if(golCasa < golOspite) { puntiOspite = 3; }
            else { puntiCasa = 1; puntiOspite = 1; }
            
            // Aggiorna squadre
            database.squadre.forEach(s => {
                if(s.nome === squadraCasa) {
                    s.punti += puntiCasa; s.partiteGiocate++; 
                    s.golFatti += golCasa; s.golSubiti += golOspite;
                    if(puntiCasa === 3) s.vittorie++; 
                    else if(puntiCasa === 1) s.pareggi++; 
                    else s.sconfitte++;
                }
                if(s.nome === squadraOspite) {
                    s.punti += puntiOspite; s.partiteGiocate++; 
                    s.golFatti += golOspite; s.golSubiti += golCasa;
                    if(puntiOspite === 3) s.vittorie++; 
                    else if(puntiOspite === 1) s.pareggi++; 
                    else s.sconfitte++;
                }
            });
            
            // Aggiorna statistiche giocatori
            partitaInCorso.eventi.forEach(evento => {
                const g = database.giocatori.find(gi => gi.id === evento.giocatoreId);
                if(!g) return;
                
                switch(evento.tipo) {
                    case 'gol': g.gol = (g.gol || 0) + 1; break;
                    case 'amm': g.ammonizioni = (g.ammonizioni || 0) + 1; break;
                    case 'esp': g.espulsioni = (g.espulsioni || 0) + 1; break;
                }
            });
            
            // Aggiungi voto al miglior giocatore
            const migliorGiocatore = database.giocatori.find(g => 
                g.id === partitaInCorso.migliori.giocatore
            );
            
            if(migliorGiocatore) {
                migliorGiocatore.punteggioTotale = (migliorGiocatore.punteggioTotale || 0) + 
                                                  partitaInCorso.migliori.votoGiocatore;
                migliorGiocatore.premiMigliorGiocatore = (migliorGiocatore.premiMigliorGiocatore || 0) + 1;
            }
            
            // Aggiungi voto al miglior portiere (se selezionato)
            if(partitaInCorso.migliori.portiere && partitaInCorso.migliori.votoPortiere > 0) {
                const migliorPortiere = database.giocatori.find(g => 
                    g.id === partitaInCorso.migliori.portiere
                );
                
                if(migliorPortiere) {
                    migliorPortiere.punteggioTotale = (migliorPortiere.punteggioTotale || 0) + 
                                                     partitaInCorso.migliori.votoPortiere;
                    migliorPortiere.premiMigliorPortiere = (migliorPortiere.premiMigliorPortiere || 0) + 1;
                }
            }
            
            // Salva partita
            const partitaId = Date.now();
            database.partite.push({
                id: partitaId,
                data: new Date().toLocaleDateString('it-IT'),
                ora: new Date().toLocaleTimeString('it-IT'),
                squadraCasa: squadraCasa,
                squadraOspite: squadraOspite,
                golCasa: golCasa,
                golOspite: golOspite,
                eventi: [...partitaInCorso.eventi],
                migliorGiocatore: partitaInCorso.migliori.giocatore,
                votoMigliorGiocatore: partitaInCorso.migliori.votoGiocatore,
                migliorPortiere: partitaInCorso.migliori.portiere,
                votoMigliorPortiere: partitaInCorso.migliori.votoPortiere
            });
            
            salvaDatabase();
            resetPartita();
            alert(`Partita salvata con successo!\n${squadraCasa} ${golCasa}-${golOspite} ${squadraOspite}`);
        }
        
        function caricaPartiteSalvate() {
            const container = document.getElementById('listaPartite');
            
            if(database.partite.length === 0) {
                container.innerHTML = '<p class="avviso">Nessuna partita salvata</p>';
                return;
            }
            
            let html = '';
            database.partite.slice().reverse().forEach((partita, index) => {
                const realIndex = database.partite.length - 1 - index;
                
                // Trova nomi giocatori
                const migliorGiocatoreNome = database.giocatori.find(g => 
                    g.id === partita.migliorGiocatore
                )?.nome || 'N/A';
                
                const migliorPortiereNome = partita.migliorPortiere ? 
                    database.giocatori.find(g => g.id === partita.migliorPortiere)?.nome || 'N/A' : 'Nessuno';
                
                // Conta eventi
                const gol = partita.eventi.filter(e => e.tipo === 'gol').length;
                const ammonizioni = partita.eventi.filter(e => e.tipo === 'amm').length;
                const espulsioni = partita.eventi.filter(e => e.tipo === 'esp').length;
                
                html += `
                    <div class="partita-item">
                        <div class="partita-header">
                            <div>
                                <strong>${partita.data} ${partita.ora}</strong><br>
                                ${partita.squadraCasa} ${partita.golCasa}-${partita.golOspite} ${partita.squadraOspite}
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 10px;">
    <button class="btn-elimina" onclick="eliminaPartita(${realIndex})">üóëÔ∏è Elimina Partita</button>
</div>
                        <div style="margin-top: 10px; font-size: 0.9em;">
                            <p>‚öΩ Gol giocatori: ${gol} | üü® Ammonizioni: ${ammonizioni} | üü• Espulsioni: ${espulsioni}</p>
                            <p>üèÜ <strong>Miglior Giocatore:</strong> ${migliorGiocatoreNome} (Voto: ${partita.votoMigliorGiocatore}/10)</p>
                            ${partita.migliorPortiere ? 
                                `<p>ü•Ö <strong>Miglior Portiere:</strong> ${migliorPortiereNome} (Voto: ${partita.votoMigliorPortiere}/10)</p>` : 
                                '<p>ü•Ö <strong>Miglior Portiere:</strong> Nessuno selezionato</p>'
                            }
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function apriModificaPartita(index) {
            const partita = database.partite[index];
            
            let html = `
                <h3>Modifica Partita: ${partita.squadraCasa} vs ${partita.squadraOspite}</h3>
                <div class="form-group">
                    <label>Gol Casa:</label>
                    <input type="number" id="modificaGolCasa" value="${partita.golCasa}" min="0">
                </div>
                <div class="form-group">
                    <label>Gol Ospite:</label>
                    <input type="number" id="modificaGolOspite" value="${partita.golOspite}" min="0">
                </div>
                <div class="conferma-eliminazione">
                    <p><strong>‚ö†Ô∏è Attenzione:</strong> Modificando il risultato verranno aggiornati automaticamente i punti delle squadre.</p>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-blue" onclick="applicaModifichePartita(${index})">üíæ Salva Modifiche</button>
                    <button class="btn" onclick="chiudiModal()">‚ùå Annulla</button>
                </div>
            `;
            
            document.getElementById('modalContenuto').innerHTML = html;
            document.getElementById('modalModifica').style.display = 'block';
        }
        
        function applicaModifichePartita(index) {
            const partita = database.partite[index];
            const nuovoGolCasa = parseInt(document.getElementById('modificaGolCasa').value) || 0;
            const nuovoGolOspite = parseInt(document.getElementById('modificaGolOspite').value) || 0;
            
            if (nuovoGolCasa === partita.golCasa && nuovoGolOspite === partita.golOspite) {
                chiudiModal();
                return;
            }
            
            // Calcola vecchi e nuovi punti
            let vecchiPuntiCasa = 0, vecchiPuntiOspite = 0;
            if(partita.golCasa > partita.golOspite) vecchiPuntiCasa = 3;
            else if(partita.golCasa < partita.golOspite) vecchiPuntiOspite = 3;
            else { vecchiPuntiCasa = 1; vecchiPuntiOspite = 1; }
            
            let nuoviPuntiCasa = 0, nuoviPuntiOspite = 0;
            if(nuovoGolCasa > nuovoGolOspite) nuoviPuntiCasa = 3;
            else if(nuovoGolCasa < nuovoGolOspite) nuoviPuntiOspite = 3;
            else { nuoviPuntiCasa = 1; nuoviPuntiOspite = 1; }
            
            // Aggiorna squadre
            database.squadre.forEach(s => {
                if(s.nome === partita.squadraCasa) {
                    s.punti = s.punti - vecchiPuntiCasa + nuoviPuntiCasa;
                    s.golFatti = s.golFatti - partita.golCasa + nuovoGolCasa;
                    s.golSubiti = s.golSubiti - partita.golOspite + nuovoGolOspite;
                    
                    // Aggiorna vittorie/pareggi/sconfitte
                    if(vecchiPuntiCasa === 3) s.vittorie--;
                    else if(vecchiPuntiCasa === 1) s.pareggi--;
                    else s.sconfitte--;
                    
                    if(nuoviPuntiCasa === 3) s.vittorie++;
                    else if(nuoviPuntiCasa === 1) s.pareggi++;
                    else s.sconfitte++;
                }
                
                if(s.nome === partita.squadraOspite) {
                    s.punti = s.punti - vecchiPuntiOspite + nuoviPuntiOspite;
                    s.golFatti = s.golFatti - partita.golOspite + nuovoGolOspite;
                    s.golSubiti = s.golSubiti - partita.golCasa + nuovoGolCasa;
                    
                    if(vecchiPuntiOspite === 3) s.vittorie--;
                    else if(vecchiPuntiOspite === 1) s.pareggi--;
                    else s.sconfitte--;
                    
                    if(nuoviPuntiOspite === 3) s.vittorie++;
                    else if(nuoviPuntiOspite === 1) s.pareggi++;
                    else s.sconfitte++;
                }
            });
            
            // Aggiorna partita
            partita.golCasa = nuovoGolCasa;
            partita.golOspite = nuovoGolOspite;
            
            salvaDatabase();
            chiudiModal();
            caricaPartiteSalvate();
            alert("Partita modificata con successo!");
        }
        
        function chiudiModal() {
            document.getElementById('modalModifica').style.display = 'none';
        }
        
        function eliminaPartita(index) {
            if(!confirm("‚ö†Ô∏è ATTENZIONE: Eliminando questa partita verranno rimossi tutti i punti assegnati.\n\nSei sicuro di voler procedere?")) return;
            
            const partita = database.partite[index];
            
            // Rimuovi punti squadre
            let puntiCasa = 0, puntiOspite = 0;
            if(partita.golCasa > partita.golOspite) puntiCasa = 3;
            else if(partita.golCasa < partita.golOspite) puntiOspite = 3;
            else { puntiCasa = 1; puntiOspite = 1; }
            
            database.squadre.forEach(s => {
                if(s.nome === partita.squadraCasa) {
                    s.punti -= puntiCasa; s.partiteGiocate--; 
                    s.golFatti -= partita.golCasa; s.golSubiti -= partita.golOspite;
                    if(puntiCasa === 3) s.vittorie--; 
                    else if(puntiCasa === 1) s.pareggi--; 
                    else s.sconfitte--;
                }
                if(s.nome === partita.squadraOspite) {
                    s.punti -= puntiOspite; s.partiteGiocate--; 
                    s.golFatti -= partita.golOspite; s.golSubiti -= partita.golCasa;
                    if(puntiOspite === 3) s.vittorie--; 
                    else if(puntiOspite === 1) s.pareggi--; 
                    else s.sconfitte--;
                }
            });
            
            // Rimuovi statistiche giocatori
            partita.eventi.forEach(evento => {
                const g = database.giocatori.find(gi => gi.id === evento.giocatoreId);
                if(!g) return;
                
                switch(evento.tipo) {
                    case 'gol': g.gol = Math.max(0, g.gol - 1); break;
                    case 'amm': g.ammonizioni = Math.max(0, g.ammonizioni - 1); break;
                    case 'esp': g.espulsioni = Math.max(0, g.espulsioni - 1); break;
                }
            });
            
            // Rimuovi voto miglior giocatore
            if(partita.migliorGiocatore) {
                const mg = database.giocatori.find(g => g.id === partita.migliorGiocatore);
                if(mg) {
                    mg.punteggioTotale = Math.max(0, mg.punteggioTotale - partita.votoMigliorGiocatore);
                    mg.premiMigliorGiocatore = Math.max(0, mg.premiMigliorGiocatore - 1);
                }
            }
            
            // Rimuovi voto miglior portiere
            if(partita.migliorPortiere && partita.votoMigliorPortiere > 0) {
                const mp = database.giocatori.find(g => g.id === partita.migliorPortiere);
                if(mp) {
                    mp.punteggioTotale = Math.max(0, mp.punteggioTotale - partita.votoMigliorPortiere);
                    mp.premiMigliorPortiere = Math.max(0, mp.premiMigliorPortiere - 1);
                }
            }
            
            // Elimina partita
            database.partite.splice(index, 1);
            salvaDatabase();
            caricaPartiteSalvate();
            alert("Partita eliminata con successo!");
        }
        
        // Funzioni eliminazione dati (esistenti)
        function mostraOpzioniElimina() {
            const tipo = document.getElementById('tipoElimina').value;
            const container = document.getElementById('opzioniElimina');
            const btnElimina = document.getElementById('btnElimina');
            
            if(!tipo) { container.classList.add('hidden'); btnElimina.classList.add('hidden'); return; }
            
            let html = '';
            switch(tipo) {
                case 'giocatore':
                    html = `<select id="giocatoreDaEliminare"><option value="">Seleziona giocatore</option>${database.giocatori.map(g => `<option value="${g.id}">${g.nome} (${g.squadra})</option>`).join('')}</select>`;
                    break;
                case 'squadra':
                    html = `<select id="squadraDaEliminare"><option value="">Seleziona squadra</option>${database.squadre.map(s => `<option value="${s.id}">${s.nome}</option>`).join('')}</select><p><small>Attenzione: Verranno eliminati anche tutti i giocatori della squadra!</small></p>`;
                    break;
                case 'tutto':
                    html = `<div style="background: #ffcccc; padding: 15px; border-radius: 5px;"><h3>‚ö†Ô∏è PERICOLO ‚ö†Ô∏è</h3><p>Stai per eliminare TUTTI i dati:</p><ul><li>${database.squadre.length} squadre</li><li>${database.giocatori.length} giocatori</li><li>${database.partite.length} partite</li></ul><p>Questa operazione √® IRREVERSIBILE!</p><label><input type="checkbox" id="confermaEliminaTutto"> Confermo di voler eliminare TUTTI i dati</label></div>`;
                    break;
            }
            
            container.innerHTML = html;
            container.classList.remove('hidden');
            btnElimina.classList.remove('hidden');
        }
        
        function eseguiEliminazione() {
            const tipo = document.getElementById('tipoElimina').value;
            switch(tipo) {
                case 'giocatore':
                    const giocatoreId = parseInt(document.getElementById('giocatoreDaEliminare').value);
                    if(giocatoreId && confirm("Eliminare questo giocatore?")) {
                        database.giocatori = database.giocatori.filter(g => g.id !== giocatoreId);
                        salvaDatabase();
                        alert("Giocatore eliminato!");
                        mostraOpzioniElimina();
                    }
                    break;
                case 'squadra':
                    const squadraId = parseInt(document.getElementById('squadraDaEliminare').value);
                    if(squadraId && confirm("ATTENZIONE: Eliminando una squadra verranno eliminati anche tutti i suoi giocatori. Continuare?")) {
                        const squadra = database.squadre.find(s => s.id === squadraId);
                        if(squadra) {
                            database.squadre = database.squadre.filter(s => s.id !== squadraId);
                            database.giocatori = database.giocatori.filter(g => g.squadra !== squadra.nome);
                            salvaDatabase();
                            caricaSquadreNeiSelect();
                            alert("Squadra e giocatori eliminati!");
                            mostraOpzioniElimina();
                        }
                    }
                    break;
                case 'tutto':
                    const conferma = document.getElementById('confermaEliminaTutto');
                    if(!conferma || !conferma.checked) { alert("Devi selezionare la casella di conferma!"); return; }
                    if(confirm("‚ö†Ô∏è SEI SICURO DI VOLER ELIMINARE TUTTI I DATI? ‚ö†Ô∏è\nQuesta operazione non pu√≤ essere annullata!")) {
                        database = { squadre: [], giocatori: [], partite: [] };
                        salvaDatabase();
                        caricaSquadreNeiSelect();
                        alert("Tutti i dati sono stati eliminati!");
                        document.getElementById('tipoElimina').value = '';
                        document.getElementById('opzioniElimina').innerHTML = '';
                        document.getElementById('opzioniElimina').classList.add('hidden');
                        document.getElementById('btnElimina').classList.add('hidden');
                    }
                    break;
            }
        }
        
        function salvaDatabase() {
            localStorage.setItem('rovigoal_squadre', JSON.stringify(database.squadre));
            localStorage.setItem('rovigoal_giocatori', JSON.stringify(database.giocatori));
            localStorage.setItem('rovigoal_partite', JSON.stringify(database.partite));
        }
        
        // Controllo password all'entrata
        if(!localStorage.getItem('admin_accesso') || localStorage.getItem('admin_accesso') !== 'true') {
            const password = prompt("Inserisci la password ADMIN:");
            if(password !== "1246912.!!") {
                alert("Accesso negato!");
                window.location.href = 'main.html';
            } else {
                localStorage.setItem('admin_accesso', 'true');
            }
        }
    </script>
</body>
</html>


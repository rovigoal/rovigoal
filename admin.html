<script type="module">
    // Importa Supabase direttamente
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/+esm'
    
    // Configurazione Supabase
    const supabaseUrl = 'https://jgcjhawtmwfsovuegryz.supabase.co'
    const supabaseAnonKey = 'sb_publishable_X6PIatMpCblUcS487cOMfQ_HfP2GpUq'
    const supabase = createClient(supabaseUrl, supabaseAnonKey)
    
    // DATABASE IN MEMORIA (sincronizzato con Supabase in tempo reale)
    let databaseData = {
        squadre: [],
        giocatori: [],
        partite: [],
        finale: null
    };
    
    // PARTITE IN CORSO - STRUTTURA MODIFICATA
    let partitaInCorso = {
        eventi: [],
        migliorGiocatore: null,
        votoGiocatore: 0,
        portiereCasa: null,
        portiereOspite: null,
        votoPortiereCasa: 0,
        votoPortiereOspite: 0
    };
    
    let finaleInCorso = {
        eventi: [],
        migliorGiocatore: null,
        votoGiocatore: 0,
        portiereCasa: null,
        portiereOspite: null,
        votoPortiereCasa: 0,
        votoPortiereOspite: 0
    };
    
    // INIZIALIZZAZIONE
    document.addEventListener('DOMContentLoaded', async function() {
        console.log("Admin page caricata!");
        inizializzaVoti();
        
        // Carica dati iniziali da Supabase
        try {
            await caricaDatiIniziali();
            console.log("Dati iniziali caricati:", {
                squadre: databaseData.squadre.length,
                giocatori: databaseData.giocatori.length,
                partite: databaseData.partite.length
            });
        } catch (error) {
            console.error("Errore caricamento dati:", error);
            alert("Errore nel caricamento dei dati dal database");
        }
        
        // Imposta listener per aggiornamenti in tempo reale
        setupRealtimeListeners();
        
        // Controllo password
        if(!localStorage.getItem('admin_accesso') || localStorage.getItem('admin_accesso') !== 'true') {
            const password = prompt("Password ADMIN:");
            if(password !== "1246912.!!") {
                alert("Accesso negato!");
                window.location.href = 'main.html';
            } else {
                localStorage.setItem('admin_accesso', 'true');
            }
        }
    });
    
    // FUNZIONI PER SUPABASE
    async function caricaDatiIniziali() {
        try {
            // Carica squadre
            const { data: squadre, error: errorSquadre } = await supabase
                .from('squadre')
                .select('*')
                .order('punti', { ascending: false });
            
            if (errorSquadre) throw errorSquadre;
            databaseData.squadre = squadre || [];
            
            // Carica giocatori
            const { data: giocatori, error: errorGiocatori } = await supabase
                .from('giocatori')
                .select('*');
            
            if (errorGiocatori) throw errorGiocatori;
            databaseData.giocatori = giocatori || [];
            
            // Carica partite
            const { data: partite, error: errorPartite } = await supabase
                .from('partite')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (errorPartite) throw errorPartite;
            databaseData.partite = partite || [];
            
            // Carica finale
            const { data: finale, error: errorFinale } = await supabase
                .from('finale')
                .select('*')
                .limit(1)
                .single();
            
            if (errorFinale && errorFinale.code !== 'PGRST116') {
                throw errorFinale;
            }
            databaseData.finale = finale || null;
            
        } catch (error) {
            console.error('Errore caricamento dati:', error);
            throw error;
        }
    }
    
    function setupRealtimeListeners() {
        // Ascolta aggiornamenti in tempo reale
        supabase.channel('squadre-channel')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'squadre' }, 
                async () => {
                    const { data } = await supabase.from('squadre').select('*');
                    databaseData.squadre = data || [];
                    caricaSquadreSelect();
                    console.log("Squadre aggiornate in tempo reale");
                }
            )
            .subscribe();
        
        supabase.channel('giocatori-channel')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'giocatori' }, 
                async () => {
                    const { data } = await supabase.from('giocatori').select('*');
                    databaseData.giocatori = data || [];
                    console.log("Giocatori aggiornati in tempo reale");
                }
            )
            .subscribe();
    }
    
    function aggiornaStatoConnessione(connesso) {
        const statusElement = document.getElementById('connessioneStatus');
        if(connesso) {
            statusElement.textContent = '‚úì Connesso a Supabase';
            statusElement.className = 'connessione-status connessione-ok';
        } else {
            statusElement.textContent = '‚úó Disconnesso';
            statusElement.className = 'connessione-status connessione-ko';
        }
    }
    
    function caricaSquadreSelect() {
        const selects = [
            'squadraGiocatore', 'squadraCasa', 'squadraOspite', 
            'finaleSquadraCasa', 'finaleSquadraOspite'
        ];
        
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if(!select) return;
            
            // Salva valore selezionato se esiste
            const valoreCorrente = select.value;
            
            select.innerHTML = '<option value="">Seleziona Squadra</option>';
            databaseData.squadre.forEach(squadra => {
                const option = document.createElement('option');
                option.value = squadra.nome;
                option.textContent = squadra.nome;
                select.appendChild(option);
            });
            
            // Ripristina valore selezionato
            if (valoreCorrente) {
                select.value = valoreCorrente;
            }
        });
    }
    
    function inizializzaVoti() {
        // Stelle per partite normali
        inizializzaStelle('voto-miglior-giocatore', 'giocatore');
        inizializzaStelle('voto-portiere-casa', 'portiere-casa');
        inizializzaStelle('voto-portiere-ospite', 'portiere-ospite');
        
        // Stelle per finale
        inizializzaStelle('finale-voto-miglior-giocatore', 'finale-giocatore');
        inizializzaStelle('finale-voto-portiere-casa', 'finale-portiere-casa');
        inizializzaStelle('finale-voto-portiere-ospite', 'finale-portiere-ospite');
    }
    
    function inizializzaStelle(elementId, tipo) {
        const container = document.getElementById(elementId);
        if(!container) return;
        
        container.innerHTML = '';
        for(let i = 1; i <= 10; i++) {
            const stella = document.createElement('span');
            stella.className = 'stella';
            stella.textContent = '‚òÖ';
            stella.onclick = () => assegnaVoto(tipo, i);
            container.appendChild(stella);
        }
    }
    
    function assegnaVoto(tipo, voto) {
        let stelleId, attualeId, oggetto;
        let campo;
        
        if(tipo === 'giocatore') {
            stelleId = 'voto-miglior-giocatore';
            attualeId = 'voto-miglior-giocatore-attuale';
            oggetto = partitaInCorso;
            campo = 'votoGiocatore';
        } else if(tipo === 'portiere-casa') {
            stelleId = 'voto-portiere-casa';
            attualeId = 'voto-portiere-casa-attuale';
            oggetto = partitaInCorso;
            campo = 'votoPortiereCasa';
        } else if(tipo === 'portiere-ospite') {
            stelleId = 'voto-portiere-ospite';
            attualeId = 'voto-portiere-ospite-attuale';
            oggetto = partitaInCorso;
            campo = 'votoPortiereOspite';
        } else if(tipo === 'finale-giocatore') {
            stelleId = 'finale-voto-miglior-giocatore';
            attualeId = 'finale-voto-miglior-giocatore-attuale';
            oggetto = finaleInCorso;
            campo = 'votoGiocatore';
        } else if(tipo === 'finale-portiere-casa') {
            stelleId = 'finale-voto-portiere-casa';
            attualeId = 'finale-voto-portiere-casa-attuale';
            oggetto = finaleInCorso;
            campo = 'votoPortiereCasa';
        } else if(tipo === 'finale-portiere-ospite') {
            stelleId = 'finale-voto-portiere-ospite';
            attualeId = 'finale-voto-portiere-ospite-attuale';
            oggetto = finaleInCorso;
            campo = 'votoPortiereOspite';
        }
        
        const stelle = document.querySelectorAll(`#${stelleId} .stella`);
        stelle.forEach((stella, index) => {
            stella.classList.toggle('selezionata', index < voto);
        });
        
        if(document.getElementById(attualeId)) {
            document.getElementById(attualeId).textContent = voto;
        }
        
        oggetto[campo] = voto;
    }
    
    function aggiornaNomePortiere(tipo) {
        let selectId, campoNome, oggetto;
        
        if(tipo === 'casa') {
            selectId = 'portiereCasa';
            campoNome = 'nome-portiere-casa';
            oggetto = partitaInCorso;
        } else if(tipo === 'ospite') {
            selectId = 'portiereOspite';
            campoNome = 'nome-portiere-ospite';
            oggetto = partitaInCorso;
        } else if(tipo === 'finale-casa') {
            selectId = 'finalePortiereCasa';
            campoNome = 'finale-nome-portiere-casa';
            oggetto = finaleInCorso;
        } else if(tipo === 'finale-ospite') {
            selectId = 'finalePortiereOspite';
            campoNome = 'finale-nome-portiere-ospite';
            oggetto = finaleInCorso;
        }
        
        const select = document.getElementById(selectId);
        const selectedOption = select.options[select.selectedIndex];
        
        if(selectedOption && selectedOption.value) {
            // Salva l'ID del portiere nell'oggetto
            const campoId = tipo.includes('casa') ? 'portiereCasa' : 'portiereOspite';
            oggetto[campoId] = parseInt(selectedOption.value);
            
            // Mostra il nome
            if(document.getElementById(campoNome)) {
                document.getElementById(campoNome).textContent = selectedOption.text;
            }
        }
    }
    
    function tornaHome() { 
        window.location.href = 'main.html'; 
    }
    
    function mostraSezione(sezione) {
        document.getElementById('menuPrincipale').style.display = 'none';
        document.getElementById('gestione').classList.remove('attiva');
        document.getElementById('partite').classList.remove('attiva');
        document.getElementById('finale').classList.remove('attiva');
        document.getElementById('gestionePartite').classList.remove('attiva');
        document.getElementById(sezione).classList.add('attiva');
        
        if(sezione === 'gestione') {
            caricaSquadreSelect();
        } else if(sezione === 'gestionePartite') {
            caricaPartiteSalvate();
        }
    }
    
    function tornaMenu() {
        document.getElementById('menuPrincipale').style.display = 'grid';
        document.getElementById('gestione').classList.remove('attiva');
        document.getElementById('partite').classList.remove('attiva');
        document.getElementById('finale').classList.remove('attiva');
        document.getElementById('gestionePartite').classList.remove('attiva');
    }
    
    // AGGIUNGI SQUADRA (VERSIONE CORRETTA)
    async function aggiungiSquadra() {
        const nome = document.getElementById('nomeSquadra').value.trim();
        const allenatore = document.getElementById('allenatore').value.trim();
        const colori = document.getElementById('colori').value.trim();
        
        if(!nome) { 
            alert("Inserisci il nome della squadra!"); 
            return; 
        }
        
        // Controlla se esiste gi√†
        const esiste = databaseData.squadre.some(s => s.nome.toLowerCase() === nome.toLowerCase());
        if(esiste) {
            alert(`La squadra "${nome}" esiste gi√†!`);
            return;
        }
        
        try {
            const { data, error } = await supabase
                .from('squadre')
                .insert([{
                    nome: nome,
                    allenatore: allenatore || "Non specificato",
                    colori: colori || "Non specificati",
                    punti: 0,
                    partite_giocate: 0,
                    vittorie: 0,
                    pareggi: 0,
                    sconfitte: 0,
                    gol_fatti: 0,
                    gol_subiti: 0
                }])
                .select()
                .single();
            
            if (error) throw error;
            
            // Pulisci i campi
            document.getElementById('nomeSquadra').value = '';
            document.getElementById('allenatore').value = '';
            document.getElementById('colori').value = '';
            
            alert(`‚úÖ Squadra "${nome}" aggiunta con successo!`);
            
        } catch (error) {
            console.error("Errore:", error);
            alert("‚ùå Errore nell'aggiunta della squadra: " + error.message);
        }
    }
    
    // AGGIUNGI GIOCATORE (VERSIONE CORRETTA)
    async function aggiungiGiocatore() {
        const squadra = document.getElementById('squadraGiocatore').value;
        const nome = document.getElementById('nomeGiocatore').value.trim();
        const numero = document.getElementById('numeroMaglia').value;
        const ruolo = document.getElementById('ruolo').value;
        
        if(!squadra || !nome) { 
            alert("Compila tutti i campi obbligatori!"); 
            return; 
        }
        
        try {
            const { data, error } = await supabase
                .from('giocatori')
                .insert([{
                    nome: nome,
                    numero: numero ? parseInt(numero) : null,
                    ruolo: ruolo,
                    squadra: squadra,
                    gol: 0,
                    ammonizioni: 0,
                    espulsioni: 0,
                    punteggio_totale: 0,
                    premi_miglior_giocatore: 0,
                    premi_miglior_portiere: 0
                }])
                .select()
                .single();
            
            if (error) throw error;
            
            // Pulisci i campi
            document.getElementById('nomeGiocatore').value = '';
            document.getElementById('numeroMaglia').value = '';
            
            alert(`‚úÖ Giocatore "${nome}" aggiunto alla squadra ${squadra}!`);
            
        } catch (error) {
            console.error("Errore:", error);
            alert("‚ùå Errore nell'aggiunta del giocatore: " + error.message);
        }
    }
    
    // Mantengo le tue funzioni originali ma aggiungo solo le modifiche necessarie
    function caricaGiocatoriPartita(tipo) {
        // ... (mantieni la tua logica originale)
    }
    
    function nascondiSezioniPartita(tipo) {
        // ... (mantieni la tua logica originale)
    }
    
    function caricaListaGiocatori(tipoSquadra, nomeSquadra, containerId, modalita) {
        // ... (mantieni la tua logica originale)
    }
    
    function caricaSelezioneMigliori(squadraCasa, squadraOspite, modalita) {
        // ... (mantieni la tua logica originale)
    }
    
    function popolaPortieri(selectId, nomeSquadra) {
        // ... (mantieni la tua logica originale)
    }
    
    function modificaEvento(giocatoreId, tipo, squadra, modifica, modalita) {
        // ... (mantieni la tua logica originale)
    }
    
    function aggiornaRiepilogoEventi(modalita) {
        // ... (mantieni la tua logica originale)
    }
    
    function controllaGol(modalita) {
        // ... (mantieni la tua logica originale)
    }
    
    function cancellaEventi(modalita) {
        // ... (mantieni la tua logica originale)
    }
    
    async function salvaPartita(modalita) {
        // ... (mantieni la tua logica originale ma aggiorna le chiamate supabase)
    }
    
    async function caricaPartiteSalvate() {
        try {
            const { data, error } = await supabase
                .from('partite')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            const container = document.getElementById('listaPartite');
            if(!container) return;
            
            if(!data || data.length === 0) {
                container.innerHTML = '<p class="avviso">Nessuna partita salvata</p>';
                return;
            }
            
            let html = '';
            data.forEach(partita => {
                html += `
                    <div class="partita-item">
                        <div class="partita-header">
                            <div>
                                <strong>${partita.data || 'N/D'} ${partita.ora || ''}</strong><br>
                                <span style="font-size: 1.2em; font-weight: bold;">
                                    ${partita.squadra_casa} ${partita.gol_casa || 0}-${partita.gol_ospite || 0} ${partita.squadra_ospite}
                                </span>
                            </div>
                        </div>
                        <button class="btn-elimina" onclick="eliminaPartita('${partita.id}')">üóëÔ∏è Elimina Partita</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        } catch (error) {
            console.error('Errore caricamento partite:', error);
        }
    }
    
    async function eliminaPartita(partitaId) {
        if(!confirm("‚ö†Ô∏è Eliminare questa partita?")) return;
        
        try {
            const { error } = await supabase
                .from('partite')
                .delete()
                .eq('id', partitaId);
            
            if (error) throw error;
            
            alert("Partita eliminata!");
            caricaPartiteSalvate();
        } catch (error) {
            console.error('Errore eliminazione partita:', error);
            alert("Errore: " + error.message);
        }
    }
    
    function mostraOpzioniElimina() {
        // ... (mantieni la tua logica originale)
    }
    
    async function eseguiEliminazione() {
        const tipo = document.getElementById('tipoElimina').value;
        
        if(tipo === 'giocatore') {
            const giocatoreId = document.getElementById('giocatoreDaEliminare').value;
            if(!giocatoreId) {
                alert("Seleziona un giocatore!");
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('giocatori')
                    .delete()
                    .eq('id', giocatoreId);
                
                if (error) throw error;
                
                alert("Giocatore eliminato!");
                mostraOpzioniElimina();
            } catch (error) {
                alert("Errore: " + error.message);
            }
            
        } else if(tipo === 'squadra') {
            const squadraId = document.getElementById('squadraDaEliminare').value;
            if(!squadraId) {
                alert("Seleziona una squadra!");
                return;
            }
            
            try {
                // Prima elimina i giocatori della squadra
                const squadra = databaseData.squadre.find(s => s.id == squadraId);
                if(squadra) {
                    const { error: errorGiocatori } = await supabase
                        .from('giocatori')
                        .delete()
                        .eq('squadra', squadra.nome);
                    
                    if (errorGiocatori) throw errorGiocatori;
                }
                
                // Poi elimina la squadra
                const { error } = await supabase
                    .from('squadre')
                    .delete()
                    .eq('id', squadraId);
                
                if (error) throw error;
                
                alert("Squadra eliminata!");
                mostraOpzioniElimina();
            } catch (error) {
                alert("Errore: " + error.message);
            }
            
        } else if(tipo === 'tutto') {
            const conferma = document.getElementById('confermaEliminaTutto');
            if(!conferma || !conferma.checked) { 
                alert("Devi selezionare la casella!"); 
                return; 
            }
            
            if(confirm("‚ö†Ô∏è SEI SICURO? ‚ö†Ô∏è\nTutti i dati verranno cancellati!")) {
                try {
                    // Elimina in ordine
                    await supabase.from('partite').delete().neq('id', 0);
                    await supabase.from('finale').delete().neq('id', 0);
                    await supabase.from('giocatori').delete().neq('id', 0);
                    await supabase.from('squadre').delete().neq('id', 0);
                    
                    alert("Tutti i dati eliminati!");
                    
                    // Reset
                    document.getElementById('tipoElimina').value = '';
                    document.getElementById('opzioniElimina').innerHTML = '';
                    document.getElementById('opzioniElimina').classList.add('hidden');
                    document.getElementById('btnElimina').classList.add('hidden');
                    
                } catch (error) {
                    alert("Errore: " + error.message);
                }
            }
        }
    }
    
    // Esporta funzioni per essere chiamate da HTML
    window.tornaHome = tornaHome;
    window.mostraSezione = mostraSezione;
    window.tornaMenu = tornaMenu;
    window.aggiungiSquadra = aggiungiSquadra;
    window.aggiungiGiocatore = aggiungiGiocatore;
    window.caricaGiocatoriPartita = caricaGiocatoriPartita;
    window.aggiornaNomePortiere = aggiornaNomePortiere;
    window.modificaEvento = modificaEvento;
    window.cancellaEventi = cancellaEventi;
    window.salvaPartita = salvaPartita;
    window.caricaPartiteSalvate = caricaPartiteSalvate;
    window.eliminaPartita = eliminaPartita;
    window.mostraOpzioniElimina = mostraOpzioniElimina;
    window.eseguiEliminazione = eseguiEliminazione;
</script>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rovigoal - Area Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #f0f2f5; padding: 20px; }
        
        .btn-home {
            position: fixed; top: 20px; right: 20px; background: #1e3c72; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .btn-home:hover { background: #2a5298; }
        
        .header {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%); color: white; padding: 20px;
            border-radius: 10px; margin-bottom: 30px; text-align: center;
        }
        
        .menu-admin {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
            max-width: 800px; margin: 0 auto 40px;
        }
        
        .menu-btn {
            background: white; padding: 60px 20px; border-radius: 15px; text-align: center; font-size: 1.5em;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease; border: 3px solid transparent;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .menu-btn:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .menu-btn:nth-child(1) { background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%); color: white; }
        .menu-btn:nth-child(2) { background: linear-gradient(135deg, #32CD32 0%, #228B22 100%); color: white; }
        .icona { font-size: 3em; display: block; margin-bottom: 15px; }
        
        .sezione {
            background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px; display: none;
        }
        .sezione.attiva { display: block; }
        
        h2 { color: #333; margin-bottom: 20px; border-bottom: 2px solid #FF4500; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        
        .btn {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%); color: white; border: none;
            padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
            margin-top: 10px; transition: all 0.3s ease;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-full { width: 100%; }
        .btn-back { background: #1e3c72; margin: 20px auto; display: block; padding: 12px 30px; }
        .btn-green { background: linear-gradient(135deg, #32CD32 0%, #228B22 100%); }
        .btn-blue { background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%); }
        .btn-red { background: linear-gradient(135deg, #FF0000 0%, #DC143C 100%); }
        .btn-yellow { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #333; }
        
        .giocatori-partita { border: 2px solid #ddd; padding: 15px; border-radius: 8px; margin-top: 15px; background: #f9f9f9; }
        .giocatore-item { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        .giocatore-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .contatore-row { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
        .contatore-label { font-weight: bold; min-width: 120px; }
        .contatore-btn { 
            width: 35px; height: 35px; border-radius: 50%; border: none; 
            font-weight: bold; font-size: 18px; cursor: pointer; 
        }
        .contatore-valore { 
            min-width: 40px; text-align: center; font-weight: bold; 
            font-size: 1.2em; padding: 5px 10px; 
        }
        .btn-gol { background: #32CD32; color: white; }
        .btn-amm { background: #FFD700; color: #333; }
        .btn-esp { background: #DC143C; color: white; }
        
        .eventi-salvati { margin-top: 20px; padding: 15px; background: #e8f4ff; border-radius: 8px; border: 1px solid #b3d9ff; }
        .evento-item { padding: 8px; border-bottom: 1px solid #cce0ff; }
        .evento-item:last-child { border-bottom: none; }
        
        .selezione-migliori { 
            margin-top: 20px; padding: 20px; 
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%); 
            border-radius: 10px; border: 2px solid #4dabf7; 
        }
        .migliori-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        @media (max-width: 768px) { .migliori-row { grid-template-columns: 1fr; } }
        
        .voto-container { margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd; }
        .voto-stelle { display: flex; gap: 5px; margin-top: 5px; }
        .stella { font-size: 24px; cursor: pointer; color: #ddd; transition: color 0.2s; }
        .stella.selezionata { color: #FFD700; }
        
        .hidden { display: none; }
        .avviso { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .avviso.errore { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        
        .gestione-partite { margin-top: 30px; }
        .partita-item { 
            background: white; padding: 20px; border-radius: 8px; 
            margin-bottom: 15px; border: 1px solid #ddd; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .partita-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .btn-elimina { 
            background: #ff6666; color: white; border: none; 
            padding: 8px 15px; border-radius: 5px; cursor: pointer; 
            font-weight: bold; margin-top: 10px;
        }
        
        .selezione-obbligatoria {
            border: 2px solid #ff6b6b;
        }
    </style>
</head>
<body>
    <button class="btn-home" onclick="tornaHome()">üè† HOME</button>
    
    <div class="header">
        <h1>üîß AREA ADMIN ROVIGOAL</h1>
        <p>Gestione completa del torneo</p>
    </div>
    
    <!-- MENU PRINCIPALE -->
    <div class="menu-admin" id="menuPrincipale">
        <div class="menu-btn" onclick="mostraSezione('gestione')"><span class="icona">üë•</span>GESTIONE SQUADRE & GIOCATORI</div>
        <div class="menu-btn" onclick="mostraSezione('partite')"><span class="icona">‚öΩ</span>GESTIONE PARTITE</div>
        <div class="menu-btn" onclick="mostraSezione('gestionePartite')"><span class="icona">üìã</span>GESTISCI PARTITE SALVATE</div>
    </div>
    
    <!-- SEZIONE 1: GESTIONE SQUADRE E GIOCATORI -->
    <div id="gestione" class="sezione">
        <h2>üë• GESTIONE SQUADRE & GIOCATORI</h2>
        
        <div class="form-group">
            <h3>‚ûï AGGIUNGI SQUADRA</h3>
            <input type="text" id="nomeSquadra" placeholder="Nome Squadra (Es: Rovigo FC)">
            <input type="text" id="allenatore" placeholder="Allenatore">
            <input type="text" id="colori" placeholder="Colori (Es: Rosso-Blu)">
            <button class="btn btn-green btn-full" onclick="aggiungiSquadra()">AGGIUNGI SQUADRA</button>
        </div>
        
        <div class="form-group">
            <h3>üë§ AGGIUNGI GIOCATORE</h3>
            <select id="squadraGiocatore"><option value="">Seleziona Squadra</option></select>
            <input type="text" id="nomeGiocatore" placeholder="Nome e Cognome">
            <input type="number" id="numeroMaglia" placeholder="Numero Maglia">
            <select id="ruolo"><option value="Portiere">Portiere</option><option value="Giocatore">Giocatore</option></select>
            <button class="btn btn-blue btn-full" onclick="aggiungiGiocatore()">AGGIUNGI GIOCATORE</button>
        </div>
        
        <div class="form-group">
            <h3>üóëÔ∏è ELIMINA DATI</h3>
            <select id="tipoElimina" onchange="mostraOpzioniElimina()">
                <option value="">Cosa vuoi eliminare?</option>
                <option value="giocatore">Elimina Giocatore</option>
                <option value="squadra">Elimina Squadra</option>
                <option value="tutto">Elimina TUTTO</option>
            </select>
            <div id="opzioniElimina" class="hidden"></div>
            <button class="btn btn-red btn-full hidden" id="btnElimina" onclick="eseguiEliminazione()">ELIMINA</button>
        </div>
        
        <button class="btn btn-back" onclick="tornaMenu()">‚Üê TORNA AL MENU</button>
    </div>
    
    <!-- SEZIONE 2: GESTIONE PARTITE -->
    <div id="partite" class="sezione">
        <h2>‚öΩ GESTIONE PARTITE</h2>
        
        <div class="form-group">
            <h3>üèüÔ∏è SELEZIONA PARTITA</h3>
            <select id="squadraCasa" onchange="caricaGiocatoriPartita()"><option value="">Squadra Casa</option></select>
            <select id="squadraOspite" onchange="caricaGiocatoriPartita()"><option value="">Squadra Ospite</option></select>
        </div>
        
        <div class="form-group">
            <h3>üìä RISULTATO PARTITA</h3>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div style="flex: 1;"><label>Gol Casa:</label><input type="number" id="golCasa" min="0" value="0" style="font-size: 24px; text-align: center;"></div>
                <div style="font-size: 24px; font-weight: bold;">-</div>
                <div style="flex: 1;"><label>Gol Ospite:</label><input type="number" id="golOspite" min="0" value="0" style="font-size: 24px; text-align: center;"></div>
            </div>
        </div>
        
        <div id="giocatoriCasaContainer" class="hidden">
            <h3>üë• GIOCATORI CASA</h3>
            <div id="giocatoriCasa" class="giocatori-partita"></div>
        </div>
        
        <div id="giocatoriOspiteContainer" class="hidden">
            <h3>üë• GIOCATORI OSPITE</h3>
            <div id="giocatoriOspite" class="giocatori-partita"></div>
        </div>
        
        <div id="selezioneMiglioriContainer" class="selezione-migliori hidden">
            <h3>üèÜ SELEZIONA I MIGLIORI</h3>
            <div class="avviso">
                <strong>IMPORTANTE:</strong> Seleziona 1 miglior giocatore e 1 miglior portiere
            </div>
            <div class="migliori-row">
                <div>
                    <label>Miglior Giocatore:</label>
                    <select id="migliorGiocatore">
                        <option value="">-- Seleziona --</option>
                    </select>
                    <div class="voto-container">
                        <label>Voto (1-10):</label>
                        <div class="voto-stelle" id="voto-miglior-giocatore"></div>
                        <span>Voto: <span id="voto-miglior-giocatore-attuale">N/A</span></span>
                    </div>
                </div>
                <div>
                    <label>Miglior Portiere:</label>
                    <select id="migliorPortiere">
                        <option value="">-- Seleziona --</option>
                    </select>
                    <div class="voto-container">
                        <label>Voto (1-10):</label>
                        <div class="voto-stelle" id="voto-miglior-portiere"></div>
                        <span>Voto: <span id="voto-miglior-portiere-attuale">N/A</span></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="eventiSalvatiContainer" class="hidden">
            <h3>üìù RIEPILOGO EVENTI</h3>
            <div id="eventiSalvati" class="eventi-salvati">Nessun evento registrato</div>
            <div class="avviso" id="avvisoGol">‚ö†Ô∏è Controlla che i gol assegnati corrispondano al risultato</div>
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn btn-yellow" onclick="cancellaEventi()">üóëÔ∏è CANCELLA EVENTI</button>
            <button class="btn btn-green" onclick="salvaPartita()">üíæ SALVA PARTITA</button>
        </div>
        
        <button class="btn btn-back" onclick="tornaMenu()">‚Üê TORNA AL MENU</button>
    </div>
    
    <!-- SEZIONE 3: GESTIONE PARTITE SALVATE -->
    <div id="gestionePartite" class="sezione">
        <h2>üìã PARTITE SALVATE</h2>
        <div id="listaPartite" class="gestione-partite"></div>
        <button class="btn btn-back" onclick="tornaMenu()">‚Üê TORNA AL MENU</button>
    </div>

    <script>
        // DATABASE
        let database = {
            squadre: JSON.parse(localStorage.getItem('rovigoal_squadre')) || [],
            giocatori: JSON.parse(localStorage.getItem('rovigoal_giocatori')) || [],
            partite: JSON.parse(localStorage.getItem('rovigoal_partite')) || []
        };
        
        // PARTITA IN CORSO
        let partitaInCorso = {
            eventi: [],
            migliorGiocatore: null,
            votoGiocatore: 0,
            migliorPortiere: null,
            votoPortiere: 0
        };
        
        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            caricaSquadre();
            inizializzaVoti();
        });
        
        function inizializzaVoti() {
            // Stelle per giocatore
            const stelleGiocatore = document.getElementById('voto-miglior-giocatore');
            stelleGiocatore.innerHTML = '';
            for(let i = 1; i <= 10; i++) {
                const stella = document.createElement('span');
                stella.className = 'stella';
                stella.textContent = '‚òÖ';
                stella.onclick = () => assegnaVoto('giocatore', i);
                stelleGiocatore.appendChild(stella);
            }
            
            // Stelle per portiere
            const stellePortiere = document.getElementById('voto-miglior-portiere');
            stellePortiere.innerHTML = '';
            for(let i = 1; i <= 10; i++) {
                const stella = document.createElement('span');
                stella.className = 'stella';
                stella.textContent = '‚òÖ';
                stella.onclick = () => assegnaVoto('portiere', i);
                stellePortiere.appendChild(stella);
            }
        }
        
        function assegnaVoto(tipo, voto) {
            const stelle = document.querySelectorAll(`#voto-miglior-${tipo} .stella`);
            stelle.forEach((stella, index) => {
                stella.classList.toggle('selezionata', index < voto);
            });
            
            document.getElementById(`voto-miglior-${tipo}-attuale`).textContent = voto;
            
            if(tipo === 'giocatore') {
                partitaInCorso.votoGiocatore = voto;
            } else {
                partitaInCorso.votoPortiere = voto;
            }
        }
        
        function tornaHome() { 
            window.location.href = 'main.html'; 
        }
        
        function mostraSezione(sezione) {
            document.getElementById('menuPrincipale').style.display = 'none';
            document.getElementById('gestione').classList.remove('attiva');
            document.getElementById('partite').classList.remove('attiva');
            document.getElementById('gestionePartite').classList.remove('attiva');
            document.getElementById(sezione).classList.add('attiva');
            
            if(sezione === 'gestione') {
                caricaSquadre();
            } else if(sezione === 'gestionePartite') {
                caricaPartiteSalvate();
            }
        }
        
        function tornaMenu() {
            document.getElementById('menuPrincipale').style.display = 'grid';
            document.getElementById('gestione').classList.remove('attiva');
            document.getElementById('partite').classList.remove('attiva');
            document.getElementById('gestionePartite').classList.remove('attiva');
        }
        
        function caricaSquadre() {
            // Per selezioni squadre
            const selects = ['squadraGiocatore', 'squadraCasa', 'squadraOspite'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if(!select) return;
                
                select.innerHTML = '<option value="">Seleziona Squadra</option>';
                database.squadre.forEach(squadra => {
                    const option = document.createElement('option');
                    option.value = squadra.nome;
                    option.textContent = squadra.nome;
                    select.appendChild(option);
                });
            });
        }
        
        function aggiungiSquadra() {
            const nome = document.getElementById('nomeSquadra').value.trim();
            const allenatore = document.getElementById('allenatore').value.trim();
            const colori = document.getElementById('colori').value.trim();
            
            if(!nome) { alert("Inserisci il nome della squadra!"); return; }
            
            database.squadre.push({
                id: Date.now(), nome: nome, allenatore: allenatore || "Non specificato",
                colori: colori || "Non specificati", punti: 0, partiteGiocate: 0,
                vittorie: 0, pareggi: 0, sconfitte: 0, golFatti: 0, golSubiti: 0
            });
            
            salvaDatabase();
            caricaSquadre();
            document.getElementById('nomeSquadra').value = '';
            document.getElementById('allenatore').value = '';
            document.getElementById('colori').value = '';
            alert(`Squadra "${nome}" aggiunta!`);
        }
        
        function aggiungiGiocatore() {
            const squadra = document.getElementById('squadraGiocatore').value;
            const nome = document.getElementById('nomeGiocatore').value.trim();
            const numero = document.getElementById('numeroMaglia').value;
            const ruolo = document.getElementById('ruolo').value;
            
            if(!squadra || !nome) { alert("Compila tutti i campi!"); return; }
            
            database.giocatori.push({
                id: Date.now(), nome: nome, numero: numero || null, ruolo: ruolo, squadra: squadra,
                gol: 0, ammonizioni: 0, espulsioni: 0, punteggioTotale: 0,
                premiMigliorGiocatore: 0, premiMigliorPortiere: 0
            });
            
            salvaDatabase();
            document.getElementById('nomeGiocatore').value = '';
            document.getElementById('numeroMaglia').value = '';
            alert(`Giocatore "${nome}" aggiunto!`);
        }
        
        function caricaGiocatoriPartita() {
            const squadraCasa = document.getElementById('squadraCasa').value;
            const squadraOspite = document.getElementById('squadraOspite').value;
            
            if(!squadraCasa || !squadraOspite) {
                document.getElementById('giocatoriCasaContainer').classList.add('hidden');
                document.getElementById('giocatoriOspiteContainer').classList.add('hidden');
                document.getElementById('selezioneMiglioriContainer').classList.add('hidden');
                document.getElementById('eventiSalvatiContainer').classList.add('hidden');
                return;
            }
            
            caricaListaGiocatori('casa', squadraCasa, 'giocatoriCasa');
            document.getElementById('giocatoriCasaContainer').classList.remove('hidden');
            
            caricaListaGiocatori('ospite', squadraOspite, 'giocatoriOspite');
            document.getElementById('giocatoriOspiteContainer').classList.remove('hidden');
            
            caricaSelezioneMigliori(squadraCasa, squadraOspite);
            document.getElementById('selezioneMiglioriContainer').classList.remove('hidden');
            document.getElementById('eventiSalvatiContainer').classList.remove('hidden');
        }
        
        function caricaListaGiocatori(tipo, nomeSquadra, containerId) {
            const giocatoriSquadra = database.giocatori.filter(g => g.squadra === nomeSquadra);
            const container = document.getElementById(containerId);
            
            if(giocatoriSquadra.length === 0) {
                container.innerHTML = '<p class="avviso">Nessun giocatore in squadra</p>';
                return;
            }
            
            let html = '';
            giocatoriSquadra.forEach(giocatore => {
                // Conta eventi di questo giocatore
                const gol = partitaInCorso.eventi.filter(e => 
                    e.giocatoreId === giocatore.id && e.tipo === 'gol' && e.squadra === tipo
                ).length;
                
                const amm = partitaInCorso.eventi.filter(e => 
                    e.giocatoreId === giocatore.id && e.tipo === 'amm' && e.squadra === tipo
                ).length;
                
                const esp = partitaInCorso.eventi.filter(e => 
                    e.giocatoreId === giocatore.id && e.tipo === 'esp' && e.squadra === tipo
                ).length;
                
                html += `
                    <div class="giocatore-item">
                        <div class="giocatore-header">
                            <strong>${giocatore.nome}</strong>
                            <small>(${giocatore.ruolo} #${giocatore.numero || 'N/A'})</small>
                        </div>
                        
                        <div class="contatore-row">
                            <span class="contatore-label" style="color: #32CD32;">‚öΩ Gol:</span>
                            <button class="contatore-btn btn-gol" onclick="modificaEvento(${giocatore.id}, 'gol', '${tipo}', -1)">-</button>
                            <span class="contatore-valore" id="gol-${giocatore.id}-${tipo}">${gol}</span>
                            <button class="contatore-btn btn-gol" onclick="modificaEvento(${giocatore.id}, 'gol', '${tipo}', 1)">+</button>
                        </div>
                        
                        <div class="contatore-row">
                            <span class="contatore-label" style="color: #FFD700;">üü® Ammonizioni:</span>
                            <button class="contatore-btn btn-amm" onclick="modificaEvento(${giocatore.id}, 'amm', '${tipo}', -1)">-</button>
                            <span class="contatore-valore" id="amm-${giocatore.id}-${tipo}">${amm}</span>
                            <button class="contatore-btn btn-amm" onclick="modificaEvento(${giocatore.id}, 'amm', '${tipo}', 1)">+</button>
                        </div>
                        
                        <div class="contatore-row">
                            <span class="contatore-label" style="color: #DC143C;">üü• Espulsioni:</span>
                            <button class="contatore-btn btn-esp" onclick="modificaEvento(${giocatore.id}, 'esp', '${tipo}', -1)">-</button>
                            <span class="contatore-valore" id="esp-${giocatore.id}-${tipo}">${esp}</span>
                            <button class="contatore-btn btn-esp" onclick="modificaEvento(${giocatore.id}, 'esp', '${tipo}', 1)">+</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function caricaSelezioneMigliori(squadraCasa, squadraOspite) {
            const giocatoriPartita = database.giocatori.filter(g => 
                g.squadra === squadraCasa || g.squadra === squadraOspite
            );
            
            // Popola miglior giocatore
            const selectGiocatore = document.getElementById('migliorGiocatore');
            selectGiocatore.innerHTML = '<option value="">-- Seleziona --</option>';
            
            giocatoriPartita.forEach(g => {
                if(g.ruolo === 'Giocatore') {
                    const option = document.createElement('option');
                    option.value = g.id;
                    option.textContent = `${g.nome} (${g.squadra})`;
                    selectGiocatore.appendChild(option);
                }
            });
            
            // Popola miglior portiere
            const selectPortiere = document.getElementById('migliorPortiere');
            selectPortiere.innerHTML = '<option value="">-- Seleziona --</option>';
            
            giocatoriPartita.forEach(g => {
                if(g.ruolo === 'Portiere') {
                    const option = document.createElement('option');
                    option.value = g.id;
                    option.textContent = `${g.nome} (${g.squadra})`;
                    selectPortiere.appendChild(option);
                }
            });
            
            // Reset
            partitaInCorso.migliorGiocatore = null;
            partitaInCorso.votoGiocatore = 0;
            partitaInCorso.migliorPortiere = null;
            partitaInCorso.votoPortiere = 0;
            
            document.getElementById('voto-miglior-giocatore-attuale').textContent = 'N/A';
            document.getElementById('voto-miglior-portiere-attuale').textContent = 'N/A';
            document.querySelectorAll('.stella.selezionata').forEach(s => s.classList.remove('selezionata'));
        }
        
        // Gestione selezione migliori
        document.getElementById('migliorGiocatore').addEventListener('change', function() {
            partitaInCorso.migliorGiocatore = this.value ? parseInt(this.value) : null;
        });
        
        document.getElementById('migliorPortiere').addEventListener('change', function() {
            partitaInCorso.migliorPortiere = this.value ? parseInt(this.value) : null;
        });
        
        function modificaEvento(giocatoreId, tipo, squadra, modifica) {
            const giocatore = database.giocatori.find(g => g.id === giocatoreId);
            if(!giocatore) return;
            
            const counterId = `${tipo}-${giocatoreId}-${squadra}`;
            const counterElement = document.getElementById(counterId);
            let valore = parseInt(counterElement.textContent) || 0;
            let nuovoValore = valore + modifica;
            
            if(nuovoValore < 0) nuovoValore = 0;
            
            // Controllo gol massimi
            if(tipo === 'gol' && modifica === 1) {
                const golCasa = parseInt(document.getElementById('golCasa').value) || 0;
                const golOspite = parseInt(document.getElementById('golOspite').value) || 0;
                const golMassimi = squadra === 'casa' ? golCasa : golOspite;
                
                const golAssegnati = partitaInCorso.eventi.filter(e => 
                    e.tipo === 'gol' && e.squadra === squadra
                ).length;
                
                if(golAssegnati >= golMassimi) {
                    alert(`Massimo ${golMassimi} gol per la squadra ${squadra}!`);
                    return;
                }
            }
            
            // Aggiorna o rimuovi eventi
            if(modifica === 1) {
                // Aggiungi evento
                partitaInCorso.eventi.push({
                    id: Date.now(),
                    giocatoreId: giocatoreId,
                    giocatoreNome: giocatore.nome,
                    tipo: tipo,
                    squadra: squadra
                });
            } else if(modifica === -1 && valore > 0) {
                // Trova e rimuovi l'ultimo evento
                for(let i = partitaInCorso.eventi.length - 1; i >= 0; i--) {
                    if(partitaInCorso.eventi[i].giocatoreId === giocatoreId && 
                       partitaInCorso.eventi[i].tipo === tipo && 
                       partitaInCorso.eventi[i].squadra === squadra) {
                        partitaInCorso.eventi.splice(i, 1);
                        break;
                    }
                }
            }
            
            counterElement.textContent = nuovoValore;
            aggiornaRiepilogoEventi();
            controllaGol();
        }
        
        function aggiornaRiepilogoEventi() {
            const container = document.getElementById('eventiSalvati');
            
            if(partitaInCorso.eventi.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Nessun evento registrato</p>';
                return;
            }
            
            const gol = partitaInCorso.eventi.filter(e => e.tipo === 'gol');
            const ammonizioni = partitaInCorso.eventi.filter(e => e.tipo === 'amm');
            const espulsioni = partitaInCorso.eventi.filter(e => e.tipo === 'esp');
            
            let html = '';
            
            if(gol.length > 0) {
                html += '<p><strong>‚öΩ Gol:</strong> ' + gol.length + '</p>';
            }
            
            if(ammonizioni.length > 0) {
                html += '<p><strong>üü® Ammonizioni:</strong> ' + ammonizioni.length + '</p>';
            }
            
            if(espulsioni.length > 0) {
                html += '<p><strong>üü• Espulsioni:</strong> ' + espulsioni.length + '</p>';
            }
            
            container.innerHTML = html;
        }
        
        function controllaGol() {
            const golCasa = parseInt(document.getElementById('golCasa').value) || 0;
            const golOspite = parseInt(document.getElementById('golOspite').value) || 0;
            
            const golAssegnatiCasa = partitaInCorso.eventi.filter(e => 
                e.tipo === 'gol' && e.squadra === 'casa'
            ).length;
            
            const golAssegnatiOspite = partitaInCorso.eventi.filter(e => 
                e.tipo === 'gol' && e.squadra === 'ospite'
            ).length;
            
            const avviso = document.getElementById('avvisoGol');
            if(golAssegnatiCasa !== golCasa || golAssegnatiOspite !== golOspite) {
                avviso.textContent = `‚ö†Ô∏è Gol assegnati: Casa ${golAssegnatiCasa}/${golCasa} - Ospite ${golAssegnatiOspite}/${golOspite}`;
                avviso.classList.add('errore');
            } else {
                avviso.textContent = '‚úÖ Gol assegnati correttamente!';
                avviso.classList.remove('errore');
            }
        }
        
        function cancellaEventi() {
            if(confirm("Vuoi cancellare TUTTI gli eventi di questa partita?")) {
                partitaInCorso.eventi = [];
                caricaGiocatoriPartita();
                aggiornaRiepilogoEventi();
                alert("Eventi cancellati!");
            }
        }
        
        function salvaPartita() {
            const squadraCasa = document.getElementById('squadraCasa').value;
            const squadraOspite = document.getElementById('squadraOspite').value;
            const golCasa = parseInt(document.getElementById('golCasa').value) || 0;
            const golOspite = parseInt(document.getElementById('golOspite').value) || 0;
            
            if(!squadraCasa || !squadraOspite) { 
                alert("Seleziona entrambe le squadre!"); 
                return; 
            }
            
            if(squadraCasa === squadraOspite) { 
                alert("Seleziona due squadre diverse!"); 
                return; 
            }
            
            // Controllo gol
            const golAssegnatiCasa = partitaInCorso.eventi.filter(e => e.tipo === 'gol' && e.squadra === 'casa').length;
            const golAssegnatiOspite = partitaInCorso.eventi.filter(e => e.tipo === 'gol' && e.squadra === 'ospite').length;
            
            if(golAssegnatiCasa !== golCasa || golAssegnatiOspite !== golOspite) {
                alert(`Gol assegnati non corrispondono!\nCasa: ${golAssegnatiCasa}/${golCasa}\nOspite: ${golAssegnatiOspite}/${golOspite}`);
                return;
            }
            
            // Controllo miglior giocatore
            if(!partitaInCorso.migliorGiocatore) {
                alert("Devi selezionare un miglior giocatore!");
                document.getElementById('migliorGiocatore').classList.add('selezione-obbligatoria');
                return;
            }
            
            if(partitaInCorso.votoGiocatore === 0) {
                alert("Devi dare un voto al miglior giocatore!");
                return;
            }
            
            if(!confirm(`Salvare la partita?\n${squadraCasa} ${golCasa}-${golOspite} ${squadraOspite}`)) {
                return;
            }
            
            // Calcola punti
            let puntiCasa = 0, puntiOspite = 0;
            if(golCasa > golOspite) puntiCasa = 3;
            else if(golCasa < golOspite) puntiOspite = 3;
            else { puntiCasa = 1; puntiOspite = 1; }
            
            // Aggiorna squadre
            database.squadre.forEach(s => {
                if(s.nome === squadraCasa) {
                    s.punti += puntiCasa;
                    s.partiteGiocate++;
                    s.golFatti += golCasa;
                    s.golSubiti += golOspite;
                    if(puntiCasa === 3) s.vittorie++;
                    else if(puntiCasa === 1) s.pareggi++;
                    else s.sconfitte++;
                }
                if(s.nome === squadraOspite) {
                    s.punti += puntiOspite;
                    s.partiteGiocate++;
                    s.golFatti += golOspite;
                    s.golSubiti += golCasa;
                    if(puntiOspite === 3) s.vittorie++;
                    else if(puntiOspite === 1) s.pareggi++;
                    else s.sconfitte++;
                }
            });
            
            // Aggiorna statistiche giocatori
            partitaInCorso.eventi.forEach(evento => {
                const g = database.giocatori.find(gi => gi.id === evento.giocatoreId);
                if(!g) return;
                
                if(evento.tipo === 'gol') g.gol = (g.gol || 0) + 1;
                else if(evento.tipo === 'amm') g.ammonizioni = (g.ammonizioni || 0) + 1;
                else if(evento.tipo === 'esp') g.espulsioni = (g.espulsioni || 0) + 1;
            });
            
            // Aggiungi voti migliori
            const migliorGiocatore = database.giocatori.find(g => g.id === partitaInCorso.migliorGiocatore);
            if(migliorGiocatore) {
                migliorGiocatore.punteggioTotale = (migliorGiocatore.punteggioTotale || 0) + partitaInCorso.votoGiocatore;
                migliorGiocatore.premiMigliorGiocatore = (migliorGiocatore.premiMigliorGiocatore || 0) + 1;
            }
            
            if(partitaInCorso.migliorPortiere && partitaInCorso.votoPortiere > 0) {
                const migliorPortiere = database.giocatori.find(g => g.id === partitaInCorso.migliorPortiere);
                if(migliorPortiere) {
                    migliorPortiere.punteggioTotale = (migliorPortiere.punteggioTotale || 0) + partitaInCorso.votoPortiere;
                    migliorPortiere.premiMigliorPortiere = (migliorPortiere.premiMigliorPortiere || 0) + 1;
                }
            }
            
            // Salva partita
            database.partite.push({
                id: Date.now(),
                data: new Date().toLocaleDateString('it-IT'),
                ora: new Date().toLocaleTimeString('it-IT'),
                squadraCasa: squadraCasa,
                squadraOspite: squadraOspite,
                golCasa: golCasa,
                golOspite: golOspite,
                eventi: [...partitaInCorso.eventi],
                migliorGiocatore: partitaInCorso.migliorGiocatore,
                votoMigliorGiocatore: partitaInCorso.votoGiocatore,
                migliorPortiere: partitaInCorso.migliorPortiere,
                votoMigliorPortiere: partitaInCorso.votoPortiere
            });
            
            salvaDatabase();
            alert(`‚úÖ Partita salvata!\n${squadraCasa} ${golCasa}-${golOspite} ${squadraOspite}`);
            
            // Reset solo dati partita
            partitaInCorso = {
                eventi: [],
                migliorGiocatore: null,
                votoGiocatore: 0,
                migliorPortiere: null,
                votoPortiere: 0
            };
            
            document.getElementById('golCasa').value = 0;
            document.getElementById('golOspite').value = 0;
            document.getElementById('voto-miglior-giocatore-attuale').textContent = 'N/A';
            document.getElementById('voto-miglior-portiere-attuale').textContent = 'N/A';
            document.querySelectorAll('.stella.selezionata').forEach(s => s.classList.remove('selezionata'));
            document.getElementById('migliorGiocatore').value = '';
            document.getElementById('migliorPortiere').value = '';
            
            caricaGiocatoriPartita();
            aggiornaRiepilogoEventi();
        }
        
        function caricaPartiteSalvate() {
            const container = document.getElementById('listaPartite');
            
            if(database.partite.length === 0) {
                container.innerHTML = '<p class="avviso">Nessuna partita salvata</p>';
                return;
            }
            
            let html = '';
            database.partite.slice().reverse().forEach((partita, index) => {
                const realIndex = database.partite.length - 1 - index;
                
                const migliorGiocatoreNome = database.giocatori.find(g => g.id === partita.migliorGiocatore)?.nome || 'N/A';
                const migliorPortiereNome = partita.migliorPortiere ? 
                    database.giocatori.find(g => g.id === partita.migliorPortiere)?.nome || 'N/A' : 'Nessuno';
                
                const gol = partita.eventi.filter(e => e.tipo === 'gol').length;
                const ammonizioni = partita.eventi.filter(e => e.tipo === 'amm').length;
                const espulsioni = partita.eventi.filter(e => e.tipo === 'esp').length;
                
                html += `
                    <div class="partita-item">
                        <div class="partita-header">
                            <div>
                                <strong>${partita.data} ${partita.ora}</strong><br>
                                <span style="font-size: 1.2em; font-weight: bold;">
                                    ${partita.squadraCasa} ${partita.golCasa}-${partita.golOspite} ${partita.squadraOspite}
                                </span>
                            </div>
                        </div>
                        
                        <p>‚öΩ Gol giocatori: ${gol} | üü® Ammonizioni: ${ammonizioni} | üü• Espulsioni: ${espulsioni}</p>
                        <p>üèÜ <strong>Miglior Giocatore:</strong> ${migliorGiocatoreNome} (Voto: ${partita.votoMigliorGiocatore}/10)</p>
                        <p>ü•Ö <strong>Miglior Portiere:</strong> ${migliorPortiereNome} ${partita.votoMigliorPortiere > 0 ? '(Voto: ' + partita.votoMigliorPortiere + '/10)' : ''}</p>
                        
                        <button class="btn-elimina" onclick="eliminaPartita(${realIndex})">üóëÔ∏è Elimina Partita</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function eliminaPartita(index) {
            if(!confirm("‚ö†Ô∏è Eliminare questa partita?\nVerranno rimossi tutti i punti e statistiche.")) return;
            
            const partita = database.partite[index];
            
            // Rimuovi punti squadre
            let puntiCasa = 0, puntiOspite = 0;
            if(partita.golCasa > partita.golOspite) puntiCasa = 3;
            else if(partita.golCasa < partita.golOspite) puntiOspite = 3;
            else { puntiCasa = 1; puntiOspite = 1; }
            
            database.squadre.forEach(s => {
                if(s.nome === partita.squadraCasa) {
                    s.punti -= puntiCasa;
                    s.partiteGiocate--;
                    s.golFatti -= partita.golCasa;
                    s.golSubiti -= partita.golOspite;
                    if(puntiCasa === 3) s.vittorie--;
                    else if(puntiCasa === 1) s.pareggi--;
                    else s.sconfitte--;
                }
                if(s.nome === partita.squadraOspite) {
                    s.punti -= puntiOspite;
                    s.partiteGiocate--;
                    s.golFatti -= partita.golOspite;
                    s.golSubiti -= partita.golCasa;
                    if(puntiOspite === 3) s.vittorie--;
                    else if(puntiOspite === 1) s.pareggi--;
                    else s.sconfitte--;
                }
            });
            
            // Rimuovi statistiche giocatori
            partita.eventi.forEach(evento => {
                const g = database.giocatori.find(gi => gi.id === evento.giocatoreId);
                if(!g) return;
                
                if(evento.tipo === 'gol') g.gol = Math.max(0, g.gol - 1);
                else if(evento.tipo === 'amm') g.ammonizioni = Math.max(0, g.ammonizioni - 1);
                else if(evento.tipo === 'esp') g.espulsioni = Math.max(0, g.espulsioni - 1);
            });
            
            // Rimuovi voti migliori
            if(partita.migliorGiocatore) {
                const mg = database.giocatori.find(g => g.id === partita.migliorGiocatore);
                if(mg) {
                    mg.punteggioTotale = Math.max(0, mg.punteggioTotale - partita.votoMigliorGiocatore);
                    mg.premiMigliorGiocatore = Math.max(0, mg.premiMigliorGiocatore - 1);
                }
            }
            
            if(partita.migliorPortiere && partita.votoMigliorPortiere > 0) {
                const mp = database.giocatori.find(g => g.id === partita.migliorPortiere);
                if(mp) {
                    mp.punteggioTotale = Math.max(0, mp.punteggioTotale - partita.votoMigliorPortiere);
                    mp.premiMigliorPortiere = Math.max(0, mp.premiMigliorPortiere - 1);
                }
            }
            
            database.partite.splice(index, 1);
            salvaDatabase();
            caricaPartiteSalvate();
            alert("Partita eliminata!");
        }
        
        // Funzioni eliminazione (solo per gestione)
        function mostraOpzioniElimina() {
            const tipo = document.getElementById('tipoElimina').value;
            const container = document.getElementById('opzioniElimina');
            const btnElimina = document.getElementById('btnElimina');
            
            if(!tipo) { 
                container.classList.add('hidden'); 
                btnElimina.classList.add('hidden'); 
                return; 
            }
            
            let html = '';
            if(tipo === 'giocatore') {
                html = `<select id="giocatoreDaEliminare"><option value="">Seleziona giocatore</option>`;
                database.giocatori.forEach(g => {
                    html += `<option value="${g.id}">${g.nome} (${g.squadra})</option>`;
                });
                html += `</select>`;
            } else if(tipo === 'squadra') {
                html = `<select id="squadraDaEliminare"><option value="">Seleziona squadra</option>`;
                database.squadre.forEach(s => {
                    html += `<option value="${s.id}">${s.nome}</option>`;
                });
                html += `</select><p><small>Attenzione: Verranno eliminati anche tutti i giocatori!</small></p>`;
            } else if(tipo === 'tutto') {
                html = `<div style="background: #ffcccc; padding: 15px; border-radius: 5px;">
                    <p><strong>‚ö†Ô∏è PERICOLO</strong></p>
                    <p>Questa operazione canceller√† TUTTO!</p>
                    <label><input type="checkbox" id="confermaEliminaTutto"> Confermo</label>
                </div>`;
            }
            
            container.innerHTML = html;
            container.classList.remove('hidden');
            btnElimina.classList.remove('hidden');
        }
        
        function eseguiEliminazione() {
            const tipo = document.getElementById('tipoElimina').value;
            
            if(tipo === 'giocatore') {
                const giocatoreId = parseInt(document.getElementById('giocatoreDaEliminare').value);
                if(giocatoreId && confirm("Eliminare questo giocatore?")) {
                    database.giocatori = database.giocatori.filter(g => g.id !== giocatoreId);
                    salvaDatabase();
                    alert("Giocatore eliminato!");
                    mostraOpzioniElimina();
                }
            } else if(tipo === 'squadra') {
                const squadraId = parseInt(document.getElementById('squadraDaEliminare').value);
                if(squadraId && confirm("Eliminare questa squadra e tutti i suoi giocatori?")) {
                    const squadra = database.squadre.find(s => s.id === squadraId);
                    if(squadra) {
                        database.squadre = database.squadre.filter(s => s.id !== squadraId);
                        database.giocatori = database.giocatori.filter(g => g.squadra !== squadra.nome);
                        salvaDatabase();
                        caricaSquadre();
                        alert("Squadra eliminata!");
                        mostraOpzioniElimina();
                    }
                }
            } else if(tipo === 'tutto') {
                const conferma = document.getElementById('confermaEliminaTutto');
                if(!conferma || !conferma.checked) { 
                    alert("Devi selezionare la casella!"); 
                    return; 
                }
                if(confirm("‚ö†Ô∏è SEI SICURO? ‚ö†Ô∏è\nTutti i dati verranno cancellati!")) {
                    database = { squadre: [], giocatori: [], partite: [] };
                    salvaDatabase();
                    caricaSquadre();
                    alert("Tutti i dati eliminati!");
                    document.getElementById('tipoElimina').value = '';
                    document.getElementById('opzioniElimina').innerHTML = '';
                    document.getElementById('opzioniElimina').classList.add('hidden');
                    document.getElementById('btnElimina').classList.add('hidden');
                }
            }
        }
        
        function salvaDatabase() {
            localStorage.setItem('rovigoal_squadre', JSON.stringify(database.squadre));
            localStorage.setItem('rovigoal_giocatori', JSON.stringify(database.giocatori));
            localStorage.setItem('rovigoal_partite', JSON.stringify(database.partite));
        }
        
        // Controllo password
        if(!localStorage.getItem('admin_accesso') || localStorage.getItem('admin_accesso') !== 'true') {
            const password = prompt("Password ADMIN:");
            if(password !== "1246912.!!") {
                alert("Accesso negato!");
                window.location.href = 'main.html';
            } else {
                localStorage.setItem('admin_accesso', 'true');
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rovigoal - Area Admin</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .btn-home {
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white; 
            border: none;
            padding: 12px 25px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-home:hover { 
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        
        .header {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%); 
            color: white; 
            padding: 25px;
            border-radius: 15px; 
            margin-bottom: 30px; 
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            max-width: 1400px;
            margin: 0 auto 30px;
        }
        
        .admin-tab {
            padding: 15px 25px;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
            text-align: center;
            font-size: 1.1em;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .admin-tab:hover {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .admin-tab.active {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%);
            box-shadow: 0 0 15px rgba(255,69,0,0.5);
        }
        
        .admin-tab .icona {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .sezione {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
            margin-bottom: 30px;
            max-width: 1400px;
            margin: 0 auto 30px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sezione.attiva {
            display: block;
        }
        
        h2 { 
            color: #1e3c72; 
            margin-bottom: 25px; 
            border-bottom: 3px solid #FF4500; 
            padding-bottom: 15px; 
            font-size: 1.8em;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #2a5298;
        }
        
        .form-section h3 {
            color: #1e3c72;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.9em;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.2);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #218838 0%, #28a745 100%);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #DC143C 0%, #FF4500 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%);
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #FFA500 0%, #FFD700 100%);
            transform: translateY(-2px);
        }
        
        .btn-full { 
            width: 100%; 
        }
        
        .btn-back { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            margin: 20px auto; 
            display: block; 
            padding: 12px 30px; 
        }
        
        .btn-gold { 
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); 
            color: #333; 
            font-weight: bold; 
        }
        
        .giocatori-partita { 
            border: 2px solid #ddd; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 15px; 
            background: #f9f9f9; 
        }
        
        .giocatore-item { 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 1px solid #eee; 
            border-radius: 5px; 
            background: white;
        }
        
        .giocatore-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        
        .contatore-row { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin: 10px 0; 
        }
        
        .contatore-label { 
            font-weight: bold; 
            min-width: 120px; 
        }
        
        .contatore-btn { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            border: none; 
            font-weight: bold; 
            font-size: 18px; 
            cursor: pointer; 
        }
        
        .contatore-valore { 
            min-width: 40px; 
            text-align: center; 
            font-weight: bold; 
            font-size: 1.2em; 
            padding: 5px 10px; 
        }
        
        .btn-gol { background: #28a745; color: white; }
        .btn-amm { background: #ffc107; color: #333; }
        .btn-esp { background: #dc3545; color: white; }
        
        .eventi-salvati { 
            margin-top: 20px; 
            padding: 15px; 
            background: #e8f4ff; 
            border-radius: 8px; 
            border: 1px solid #b3d9ff; 
        }
        
        .evento-item { 
            padding: 8px; 
            border-bottom: 1px solid #cce0ff; 
        }
        
        .evento-item:last-child { 
            border-bottom: none; 
        }
        
        .selezione-migliori { 
            margin-top: 20px; 
            padding: 20px; 
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%); 
            border-radius: 10px; 
            border: 2px solid #4dabf7; 
        }
        
        .migliori-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-top: 15px; 
        }
        
        .voto-container { 
            margin-top: 10px; 
            padding: 10px; 
            background: white; 
            border-radius: 5px; 
            border: 1px solid #ddd; 
        }
        
        .voto-stelle { 
            display: flex; 
            gap: 5px; 
            margin-top: 5px; 
        }
        
        .stella { 
            font-size: 24px; 
            cursor: pointer; 
            color: #ddd; 
            transition: color 0.2s; 
        }
        
        .stella.selezionata { 
            color: #FFD700; 
        }
        
        .hidden { 
            display: none; 
        }
        
        .avviso { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            color: #856404; 
            padding: 10px; 
            border-radius: 5px; 
            margin-top: 10px; 
        }
        
        .avviso.errore { 
            background: #f8d7da; 
            border-color: #f5c6cb; 
            color: #721c24; 
        }
        
        .finale-avviso {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: 3px solid #FFD700;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .portieri-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .portiere-section {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #87CEEB;
        }
        
        .danger-zone {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 3px solid #dc3545;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .danger-zone h3 {
            color: #dc3545;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .danger-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 300px;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            display: block;
        }
        
        .connessione-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connessione-ok {
            background: #28a745;
            color: white;
            border: 2px solid #218838;
        }
        
        .connessione-caricamento {
            background: #ffc107;
            color: white;
            border: 2px solid #e0a800;
        }
        
        .connessione-ko {
            background: #dc3545;
            color: white;
            border: 2px solid #c82333;
        }
        
        .partite-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .partita-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .partita-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .btn-elimina {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* MEDIA QUERIES */
        @media (max-width: 1200px) {
            .sezione, .admin-tabs {
                margin-left: 20px;
                margin-right: 20px;
            }
        }
        
        @media (max-width: 992px) {
            .admin-tab {
                min-width: 180px;
                padding: 12px 20px;
            }
            
            .migliori-row, .portieri-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .admin-tabs {
                flex-direction: column;
            }
            
            .admin-tab {
                min-width: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .btn-home {
                top: 10px;
                right: 10px;
                padding: 10px 20px;
                font-size: 0.9em;
            }
            
            .connessione-status {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 10px;
                display: inline-flex;
            }
            
            .stats-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .stats-panel {
                grid-template-columns: 1fr;
            }
            
            .sezione {
                padding: 20px 15px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .danger-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- MESSAGGI -->
    <div id="messageContainer"></div>
    
    <button class="btn-home" onclick="tornaHome()">üè† HOME</button>
    
    <div class="header">
        <h1>üîß AREA ADMIN ROVIGOAL</h1>
        <p>Gestione completa del torneo</p>
        <div id="connessioneStatus" class="connessione-status connessione-caricamento">
            <div class="loading"></div> Connessione...
        </div>
    </div>
    
    <!-- TABS PRINCIPALI -->
    <div class="admin-tabs" id="menuPrincipale">
        <button class="admin-tab active" onclick="apriTab('dashboard')">
            <span class="icona">üìä</span>
            DASHBOARD
        </button>
        <button class="admin-tab" onclick="apriTab('gestione')">
            <span class="icona">üë•</span>
            GESTIONE SQUADRE & GIOCATORI
        </button>
        <button class="admin-tab" onclick="apriTab('partite')">
            <span class="icona">‚öΩ</span>
            GESTIONE PARTITE
        </button>
        <button class="admin-tab" onclick="apriTab('finale')">
            <span class="icona">üèÜ</span>
            GESTIONE FINALE
        </button>
        <button class="admin-tab" onclick="apriTab('gestionePartite')">
            <span class="icona">üìã</span>
            PARTITE SALVATE
        </button>
    </div>
    
    <!-- SEZIONE 1: DASHBOARD -->
    <div id="dashboard" class="sezione attiva">
        <h2>üìä Dashboard di Controllo</h2>
        
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-value" id="statSquadre">0</div>
                <div class="stat-label">Squadre Registrate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statGiocatori">0</div>
                <div class="stat-label">Giocatori Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statPartite">0</div>
                <div class="stat-label">Partite Giocate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statGol">0</div>
                <div class="stat-label">Gol Totali</div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>üìà Statistiche Live</h3>
            <div id="liveStats">
                <p>Caricamento statistiche in tempo reale...</p>
            </div>
        </div>
        
        <div class="form-section">
            <h3>üîÑ Azioni Rapide</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="caricaDati()">
                    üîÑ Ricarica Tutti i Dati
                </button>
                <button class="btn btn-success" onclick="apriTab('partite')">
                    ‚ûï Nuova Partita
                </button>
                <button class="btn btn-warning" onclick="apriTab('finale')">
                    üèÜ Imposta Finale
                </button>
            </div>
        </div>
    </div>
    
    <!-- SEZIONE 2: GESTIONE SQUADRE E GIOCATORI -->
    <div id="gestione" class="sezione">
        <h2>üë• GESTIONE SQUADRE & GIOCATORI</h2>
        
        <div class="form-section">
            <h3>‚ûï AGGIUNGI SQUADRA</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Nome Squadra:</label>
                    <input type="text" id="nomeSquadra" placeholder="Es: Rovigo FC" required>
                </div>
                <div class="form-group">
                    <label>Allenatore:</label>
                    <input type="text" id="allenatore" placeholder="Es: Mario Rossi">
                </div>
                <div class="form-group">
                    <label>Colori:</label>
                    <input type="text" id="colori" placeholder="Es: Rosso-Blu">
                </div>
            </div>
            <button class="btn btn-success btn-full" onclick="aggiungiSquadra()">‚ûï AGGIUNGI SQUADRA</button>
        </div>
        
        <div class="form-section">
            <h3>üë§ AGGIUNGI GIOCATORE</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Squadra:</label>
                    <select id="squadraGiocatore" required>
                        <option value="">Seleziona Squadra</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nome Giocatore:</label>
                    <input type="text" id="nomeGiocatore" placeholder="Nome e Cognome" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Numero Maglia:</label>
                    <input type="number" id="numeroMaglia" placeholder="Es: 10">
                </div>
                <div class="form-group">
                    <label>Ruolo:</label>
                    <select id="ruolo" required>
                        <option value="Giocatore">Giocatore</option>
                        <option value="Portiere">Portiere</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="aggiungiGiocatore()">‚ûï AGGIUNGI GIOCATORE</button>
        </div>
        
        <div class="form-section">
            <h3>üóëÔ∏è ELIMINA DATI</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Cosa vuoi eliminare?</label>
                    <select id="tipoElimina" onchange="mostraOpzioniElimina()">
                        <option value="">Seleziona...</option>
                        <option value="giocatore">Elimina Giocatore</option>
                        <option value="squadra">Elimina Squadra</option>
                        <option value="tutto">Elimina TUTTO</option>
                    </select>
                </div>
            </div>
            <div id="opzioniElimina" class="hidden"></div>
            <button class="btn btn-danger btn-full hidden" id="btnElimina" onclick="eseguiEliminazione()">üóëÔ∏è ELIMINA</button>
        </div>
        
        <div class="form-section">
            <h3>üìã Lista Giocatori</h3>
            <div id="listaGiocatori" class="partite-list">
                <p>Caricamento giocatori...</p>
            </div>
        </div>
        
        <div class="form-section">
            <h3>üìã Lista Squadre</h3>
            <div id="listaSquadre" class="partite-list">
                <p>Caricamento squadre...</p>
            </div>
        </div>
    </div>
    
    <!-- SEZIONE 3: GESTIONE PARTITE -->
    <div id="partite" class="sezione">
        <h2>‚öΩ GESTIONE PARTITE</h2>
        
        <div class="form-section">
            <h3>üèüÔ∏è CREA NUOVA PARTITA</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Data Partita:</label>
                    <input type="date" id="partitaData" required>
                </div>
                <div class="form-group">
                    <label>Ora Partita:</label>
                    <input type="time" id="partitaOra" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Squadra Casa:</label>
                    <select id="squadraCasa" required onchange="caricaGiocatoriPartita('normale')">
                        <option value="">Seleziona Squadra</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Squadra Ospite:</label>
                    <select id="squadraOspite" required onchange="caricaGiocatoriPartita('normale')">
                        <option value="">Seleziona Squadra</option>
                    </select>
                </div>
            </div>
            
            <h4 style="margin: 20px 0 10px 0; color: #1e3c72;">üìä Risultato Partita</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Gol Casa:</label>
                    <input type="number" id="golCasa" min="0" value="0" required style="font-size: 24px; text-align: center;">
                </div>
                <div style="display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold;">-</div>
                <div class="form-group">
                    <label>Gol Ospite:</label>
                    <input type="number" id="golOspite" min="0" value="0" required style="font-size: 24px; text-align: center;">
                </div>
            </div>
            
            <div id="giocatoriCasaContainer" class="hidden">
                <h4>üë• GIOCATORI CASA</h4>
                <div id="giocatoriCasa" class="giocatori-partita"></div>
            </div>
            
            <div id="giocatoriOspiteContainer" class="hidden">
                <h4>üë• GIOCATORI OSPITE</h4>
                <div id="giocatoriOspite" class="giocatori-partita"></div>
            </div>
            
            <div id="selezioneMiglioriContainer" class="selezione-migliori hidden">
                <h4>üèÜ SELEZIONA I MIGLIORI</h4>
                <div class="avviso">
                    <strong>IMPORTANTE:</strong> Seleziona 1 miglior giocatore (campo) e vota entrambi i portieri
                </div>
                <div class="migliori-row">
                    <div>
                        <label>Miglior Giocatore (campo):</label>
                        <select id="migliorGiocatore">
                            <option value="">-- Seleziona --</option>
                        </select>
                        <div class="voto-container">
                            <label>Voto (1-10):</label>
                            <div class="voto-stelle" id="voto-miglior-giocatore"></div>
                            <span>Voto: <span id="voto-miglior-giocatore-attuale">N/A</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="portieri-row">
                    <div class="portiere-section">
                        <label>Portiere Casa:</label>
                        <select id="portiereCasa" onchange="aggiornaNomePortiere('casa')">
                            <option value="">-- Seleziona Portiere Casa --</option>
                        </select>
                        <div class="voto-container">
                            <label>Voto Portiere Casa (1-10):</label>
                            <div class="voto-stelle" id="voto-portiere-casa"></div>
                            <span>Voto: <span id="voto-portiere-casa-attuale">N/A</span></span>
                            <div><small id="nome-portiere-casa"></small></div>
                        </div>
                    </div>
                    
                    <div class="portiere-section">
                        <label>Portiere Ospite:</label>
                        <select id="portiereOspite" onchange="aggiornaNomePortiere('ospite')">
                            <option value="">-- Seleziona Portiere Ospite --</option>
                        </select>
                        <div class="voto-container">
                            <label>Voto Portiere Ospite (1-10):</label>
                            <div class="voto-stelle" id="voto-portiere-ospite"></div>
                            <span>Voto: <span id="voto-portiere-ospite-attuale">N/A</span></span>
                            <div><small id="nome-portiere-ospite"></small></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="eventiSalvatiContainer" class="hidden">
                <h4>üìù RIEPILOGO EVENTI</h4>
                <div id="eventiSalvati" class="eventi-salvati">Nessun evento registrato</div>
                <div class="avviso" id="avvisoGol">‚ö†Ô∏è Controlla che i gol assegnati corrispondano al risultato</div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-warning" onclick="cancellaEventi('normale')">
                    üóëÔ∏è CANCELLA EVENTI
                </button>
                <button class="btn btn-success" onclick="salvaPartita('normale')">
                    üíæ SALVA PARTITA
                </button>
            </div>
        </div>
        
        <div class="form-section">
            <h3>üóëÔ∏è Elimina Partita</h3>
            <p><strong>Attenzione:</strong> L'eliminazione di una partita rimuover√† anche tutti gli eventi e voti associati.</p>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Seleziona Partita da Eliminare:</label>
                    <select id="partitaDaEliminare">
                        <option value="">Seleziona partita...</option>
                    </select>
                </div>
            </div>
            
            <button class="btn btn-danger" onclick="eliminaPartitaSelezionata()">
                üóëÔ∏è ELIMINA PARTITA SELEZIONATA
            </button>
        </div>
    </div>
    
    <!-- SEZIONE 4: GESTIONE FINALE -->
    <div id="finale" class="sezione">
        <h2>üèÜ GESTIONE PARTITA FINALE</h2>
        
        <div class="finale-avviso">
            ‚ö†Ô∏è ATTENZIONE: Questa partita sar√† visibile nella sezione "FINALE" della pagina principale
        </div>
        
        <div class="form-section">
            <h3>üèüÔ∏è IMPOSTA PARTITA FINALE</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Data Finale:</label>
                    <input type="date" id="finaleData" required>
                </div>
                <div class="form-group">
                    <label>Ora Finale:</label>
                    <input type="time" id="finaleOra" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Squadra Finalista 1:</label>
                    <select id="finaleSquadraCasa" required onchange="caricaGiocatoriPartita('finale')">
                        <option value="">Seleziona Squadra</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Squadra Finalista 2:</label>
                    <select id="finaleSquadraOspite" required onchange="caricaGiocatoriPartita('finale')">
                        <option value="">Seleziona Squadra</option>
                    </select>
                </div>
            </div>
            
            <h4 style="margin: 20px 0 10px 0; color: #1e3c72;">üìä Risultato Finale</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Gol Finalista 1:</label>
                    <input type="number" id="finaleGolCasa" min="0" value="0" required style="font-size: 24px; text-align: center;">
                </div>
                <div style="display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold;">-</div>
                <div class="form-group">
                    <label>Gol Finalista 2:</label>
                    <input type="number" id="finaleGolOspite" min="0" value="0" required style="font-size: 24px; text-align: center;">
                </div>
            </div>
            
            <div id="finaleGiocatoriCasaContainer" class="hidden">
                <h4>üë• FINALISTA 1</h4>
                <div id="finaleGiocatoriCasa" class="giocatori-partita"></div>
            </div>
            
            <div id="finaleGiocatoriOspiteContainer" class="hidden">
                <h4>üë• FINALISTA 2</h4>
                <div id="finaleGiocatoriOspite" class="giocatori-partita"></div>
            </div>
            
            <div id="finaleSelezioneMiglioriContainer" class="selezione-migliori hidden">
                <h4>üèÜ SELEZIONA I MIGLIORI DELLA FINALE</h4>
                <div class="migliori-row">
                    <div>
                        <label>Miglior Giocatore (campo):</label>
                        <select id="finaleMigliorGiocatore">
                            <option value="">-- Seleziona --</option>
                        </select>
                        <div class="voto-container">
                            <label>Voto (1-10):</label>
                            <div class="voto-stelle" id="finale-voto-miglior-giocatore"></div>
                            <span>Voto: <span id="finale-voto-miglior-giocatore-attuale">N/A</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="portieri-row">
                    <div class="portiere-section">
                        <label>Portiere Finalista 1:</label>
                        <select id="finalePortiereCasa" onchange="aggiornaNomePortiere('finale-casa')">
                            <option value="">-- Seleziona Portiere Finalista 1 --</option>
                        </select>
                        <div class="voto-container">
                            <label>Voto Portiere Finalista 1 (1-10):</label>
                            <div class="voto-stelle" id="finale-voto-portiere-casa"></div>
                            <span>Voto: <span id="finale-voto-portiere-casa-attuale">N/A</span></span>
                            <div><small id="finale-nome-portiere-casa"></small></div>
                        </div>
                    </div>
                    
                    <div class="portiere-section">
                        <label>Portiere Finalista 2:</label>
                        <select id="finalePortiereOspite" onchange="aggiornaNomePortiere('finale-ospite')">
                            <option value="">-- Seleziona Portiere Finalista 2 --</option>
                        </select>
                        <div class="voto-container">
                            <label>Voto Portiere Finalista 2 (1-10):</label>
                            <div class="voto-stelle" id="finale-voto-portiere-ospite"></div>
                            <span>Voto: <span id="finale-voto-portiere-ospite-attuale">N/A</span></span>
                            <div><small id="finale-nome-portiere-ospite"></small></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="finaleEventiSalvatiContainer" class="hidden">
                <h4>üìù RIEPILOGO EVENTI FINALE</h4>
                <div id="finaleEventiSalvati" class="eventi-salvati">Nessun evento registrato</div>
                <div class="avviso" id="finaleAvvisoGol">‚ö†Ô∏è Controlla che i gol assegnati corrispondano al risultato</div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-warning" onclick="cancellaEventi('finale')">
                    üóëÔ∏è CANCELLA EVENTI
                </button>
                <button class="btn btn-gold" onclick="salvaPartita('finale')">
                    üèÜ SALVA FINALE
                </button>
                <button class="btn btn-primary" onclick="caricaFinaleEsistente()">
                    üîÑ Carica Finale Esistente
                </button>
            </div>
        </div>
        
        <div class="form-section danger-zone">
            <h3>‚ö†Ô∏è Elimina Partita Finale</h3>
            <p><strong>Attenzione Massima:</strong> Stai per eliminare TUTTI i dati della finale. Questa operazione non pu√≤ essere annullata.</p>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="eliminaFinale()">
                    üóëÔ∏è ELIMINA TUTTA LA FINALE
                </button>
            </div>
        </div>
    </div>
    
    <!-- SEZIONE 5: GESTIONE PARTITE SALVATE -->
    <div id="gestionePartite" class="sezione">
        <h2>üìã PARTITE SALVATE</h2>
        
        <div class="form-section">
            <h3>üìä Elenco Partite</h3>
            <div id="listaPartite" class="partite-list">
                <p>Caricamento partite...</p>
            </div>
        </div>
        
        <div class="form-section danger-zone">
            <h3>‚ö†Ô∏è ZONA PERICOLO - OPERAZIONI IRREVERSIBILI</h3>
            <p><strong>LEGGI ATTENTAMENTE:</strong> Queste operazioni eliminano dati PERMANENTEMENTE dal database. Non c'√® possibilit√† di recupero.</p>
            
            <div class="danger-buttons">
                <button class="btn btn-danger" onclick="eliminaTuttePartite()">
                    üóëÔ∏è Elimina TUTTE le Partite
                </button>
                <button class="btn btn-danger" onclick="resetStatisticheGiocatori()">
                    üîÑ Reset Statistiche Giocatori
                </button>
                <button class="btn btn-danger" onclick="resetClassificaSquadre()">
                    üîÑ Reset Classifica Squadre
                </button>
                <button class="btn btn-danger" onclick="eliminaTuttoDatabase()">
                    üí£ Elimina TUTTO il Database
                </button>
            </div>
            
            <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="esportaBackup()">
                    üíæ Esporta Backup JSON
                </button>
                <button class="btn btn-warning" onclick="importaBackup()">
                    üìÇ Importa Backup
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa il gestore del database Supabase
        import database from './database-supabase.js';
        
        // DATABASE IN MEMORIA (sincronizzato con Supabase in tempo reale)
        let datiTorneo = {
            squadre: [],
            giocatori: [],
            partite: [],
            finale: null
        };
        
        // PARTITE IN CORSO - STRUTTURA MODIFICATA
        let partitaInCorso = {
            eventi: [],
            migliorGiocatore: null,
            votoGiocatore: 0,
            portiereCasa: null,
            portiereOspite: null,
            votoPortiereCasa: 0,
            votoPortiereOspite: 0
        };
        
        let finaleInCorso = {
            eventi: [],
            migliorGiocatore: null,
            votoGiocatore: 0,
            portiereCasa: null,
            portiereOspite: null,
            votoPortiereCasa: 0,
            votoPortiereOspite: 0
        };
        
        let ultimoAggiornamento = null;
        let finaleEventi = [];
        
        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', async function() {
            // Controllo accesso admin
            if (!verificaAccessoAdmin()) {
                return;
            }
            
            inizializzaVoti();
            
            try {
                // Ascolta aggiornamenti dal database in tempo reale
                window.onDatabaseUpdate = function(type, data) {
                    console.log(`üì° Aggiornamento ${type} ricevuto:`, data.length || data);
                    
                    // Aggiorna i dati in memoria
                    datiTorneo[type] = data;
                    
                    // Gestisci aggiornamenti specifici per tipo
                    switch(type) {
                        case 'squadre':
                            caricaSquadreSelect();
                            aggiornaDashboard();
                            break;
                        case 'giocatori':
                            popolaSelectGiocatori();
                            aggiornaListaGiocatori();
                            aggiornaDashboard();
                            break;
                        case 'partite':
                            popolaSelectPartite();
                            aggiornaDashboard();
                            break;
                        case 'finale':
                            if (data && data.eventi) {
                                finaleEventi = data.eventi;
                            }
                            break;
                    }
                    
                    aggiornaStatoConnessione(true);
                };
                
                // Carica dati iniziali
                await caricaDatiIniziali();
                aggiornaDashboard();
                popolaSelectSquadre();
                popolaSelectGiocatori();
                popolaSelectPartite();
                aggiornaListaGiocatori();
                aggiornaListaSquadre();
                
                // Imposta timer per controllare connessione
                setInterval(controllaConnessione, 10000);
                
            } catch (error) {
                console.error('Errore inizializzazione admin:', error);
                mostraMessaggio('Errore nel caricamento dei dati. Riprova.', 'error');
            }
        });
        
        // VERIFICA ACCESSO ADMIN
        function verificaAccessoAdmin() {
            const passwordInserita = sessionStorage.getItem('admin_accesso');
            
            if (passwordInserita !== 'true') {
                const password = prompt("Inserisci la password ADMIN:");
                
                if (password === "1246912.!!") {
                    sessionStorage.setItem('admin_accesso', 'true');
                    return true;
                } else {
                    alert("Password errata! Accesso negato.");
                    window.location.href = 'main.html';
                    return false;
                }
            }
            
            return true;
        }
        
        // CARICA DATI INIZIALI
        async function caricaDatiIniziali() {
            try {
                const [squadre, giocatori, partite, finale] = await Promise.all([
                    database.getSquadre(),
                    database.getGiocatori(),
                    database.getPartite(),
                    database.getFinale()
                ]);
                
                datiTorneo.squadre = squadre || [];
                datiTorneo.giocatori = giocatori || [];
                datiTorneo.partite = partite || [];
                datiTorneo.finale = finale || null;
                
                if (datiTorneo.finale && datiTorneo.finale.eventi) {
                    finaleEventi = datiTorneo.finale.eventi;
                }
                
                ultimoAggiornamento = new Date();
                
                console.log('Dati admin caricati:', {
                    squadre: datiTorneo.squadre.length,
                    giocatori: datiTorneo.giocatori.length,
                    partite: datiTorneo.partite.length,
                    finale: !!datiTorneo.finale
                });
                
                aggiornaStatoConnessione('ok');
                
            } catch (error) {
                console.error('Errore caricamento dati:', error);
                aggiornaStatoConnessione('ko');
                throw error;
            }
        }
        
        function aggiornaStatoConnessione(stato) {
            const statusElement = document.getElementById('connessioneStatus');
            
            switch(stato) {
                case 'caricamento':
                    statusElement.className = 'connessione-status connessione-caricamento';
                    statusElement.innerHTML = '<div class="loading"></div> Connessione...';
                    break;
                    
                case true:
                case 'ok':
                    statusElement.className = 'connessione-status connessione-ok';
                    statusElement.innerHTML = '‚úì Connesso a Supabase';
                    break;
                    
                case false:
                case 'ko':
                    statusElement.className = 'connessione-status connessione-ko';
                    statusElement.innerHTML = '‚úó Disconnesso';
                    break;
            }
        }
        
        function controllaConnessione() {
            if (datiTorneo.squadre.length === 0) {
                aggiornaStatoConnessione(false);
            }
        }
        
        function caricaSquadreSelect() {
            const selects = [
                'squadraGiocatore', 'squadraCasa', 'squadraOspite', 
                'finaleSquadraCasa', 'finaleSquadraOspite'
            ];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if(!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Seleziona Squadra</option>';
                
                datiTorneo.squadre.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(squadra => {
                    const option = document.createElement('option');
                    option.value = squadra.nome;
                    option.textContent = squadra.nome;
                    select.appendChild(option);
                });
                
                if (currentValue && datiTorneo.squadre.some(s => s.nome === currentValue)) {
                    select.value = currentValue;
                }
            });
        }
        
        function popolaSelectGiocatori() {
            const selects = [
                'migliorGiocatore', 'portiereCasa', 'portiereOspite',
                'finaleMigliorGiocatore', 'finalePortiereCasa', 'finalePortiereOspite'
            ];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Seleziona giocatore...</option>';
                
                // Filtra per ruolo se necessario
                let giocatoriFiltrati = [...datiTorneo.giocatori];
                
                if (selectId === 'portiereCasa' || selectId === 'portiereOspite' || 
                    selectId === 'finalePortiereCasa' || selectId === 'finalePortiereOspite') {
                    giocatoriFiltrati = giocatoriFiltrati.filter(g => g.ruolo === 'Portiere');
                }
                
                giocatoriFiltrati.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(giocatore => {
                    const option = document.createElement('option');
                    option.value = giocatore.id;
                    option.textContent = `${giocatore.nome} (${giocatore.squadra})`;
                    select.appendChild(option);
                });
                
                if (currentValue && giocatoriFiltrati.some(g => g.id === currentValue)) {
                    select.value = currentValue;
                }
            });
        }
        
        function popolaSelectPartite() {
            const select = document.getElementById('partitaDaEliminare');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">Seleziona partita...</option>';
            
            datiTorneo.partite.sort((a, b) => new Date(b.data) - new Date(a.data)).forEach(partita => {
                const option = document.createElement('option');
                option.value = partita.id;
                option.textContent = `${partita.data} - ${partita.squadra_casa} vs ${partita.squadra_ospite} (${partita.gol_casa}-${partita.gol_ospite})`;
                select.appendChild(option);
            });
            
            if (currentValue && datiTorneo.partite.some(p => p.id === currentValue)) {
                select.value = currentValue;
            }
        }
        
        function inizializzaVoti() {
            // Stelle per partite normali
            inizializzaStelle('voto-miglior-giocatore', 'giocatore');
            inizializzaStelle('voto-portiere-casa', 'portiere-casa');
            inizializzaStelle('voto-portiere-ospite', 'portiere-ospite');
            
            // Stelle per finale
            inizializzaStelle('finale-voto-miglior-giocatore', 'finale-giocatore');
            inizializzaStelle('finale-voto-portiere-casa', 'finale-portiere-casa');
            inizializzaStelle('finale-voto-portiere-ospite', 'finale-portiere-ospite');
        }
        
        function inizializzaStelle(elementId, tipo) {
            const container = document.getElementById(elementId);
            if(!container) return;
            
            container.innerHTML = '';
            for(let i = 1; i <= 10; i++) {
                const stella = document.createElement('span');
                stella.className = 'stella';
                stella.textContent = '‚òÖ';
                stella.onclick = () => assegnaVoto(tipo, i);
                container.appendChild(stella);
            }
        }
        
        function assegnaVoto(tipo, voto) {
            let stelleId, attualeId, oggetto;
            let campo;
            
            if(tipo === 'giocatore') {
                stelleId = 'voto-miglior-giocatore';
                attualeId = 'voto-miglior-giocatore-attuale';
                oggetto = partitaInCorso;
                campo = 'votoGiocatore';
            } else if(tipo === 'portiere-casa') {
                stelleId = 'voto-portiere-casa';
                attualeId = 'voto-portiere-casa-attuale';
                oggetto = partitaInCorso;
                campo = 'votoPortiereCasa';
            } else if(tipo === 'portiere-ospite') {
                stelleId = 'voto-portiere-ospite';
                attualeId = 'voto-portiere-ospite-attuale';
                oggetto = partitaInCorso;
                campo = 'votoPortiereOspite';
            } else if(tipo === 'finale-giocatore') {
                stelleId = 'finale-voto-miglior-giocatore';
                attualeId = 'finale-voto-miglior-giocatore-attuale';
                oggetto = finaleInCorso;
                campo = 'votoGiocatore';
            } else if(tipo === 'finale-portiere-casa') {
                stelleId = 'finale-voto-portiere-casa';
                attualeId = 'finale-voto-portiere-casa-attuale';
                oggetto = finaleInCorso;
                campo = 'votoPortiereCasa';
            } else if(tipo === 'finale-portiere-ospite') {
                stelleId = 'finale-voto-portiere-ospite';
                attualeId = 'finale-voto-portiere-ospite-attuale';
                oggetto = finaleInCorso;
                campo = 'votoPortiereOspite';
            }
            
            const stelle = document.querySelectorAll(`#${stelleId} .stella`);
            stelle.forEach((stella, index) => {
                stella.classList.toggle('selezionata', index < voto);
            });
            
            if(document.getElementById(attualeId)) {
                document.getElementById(attualeId).textContent = voto;
            }
            
            oggetto[campo] = voto;
        }
        
        function aggiornaNomePortiere(tipo) {
            let selectId, campoNome, oggetto;
            
            if(tipo === 'casa') {
                selectId = 'portiereCasa';
                campoNome = 'nome-portiere-casa';
                oggetto = partitaInCorso;
            } else if(tipo === 'ospite') {
                selectId = 'portiereOspite';
                campoNome = 'nome-portiere-ospite';
                oggetto = partitaInCorso;
            } else if(tipo === 'finale-casa') {
                selectId = 'finalePortiereCasa';
                campoNome = 'finale-nome-portiere-casa';
                oggetto = finaleInCorso;
            } else if(tipo === 'finale-ospite') {
                selectId = 'finalePortiereOspite';
                campoNome = 'finale-nome-portiere-ospite';
                oggetto = finaleInCorso;
            }
            
            const select = document.getElementById(selectId);
            const selectedOption = select.options[select.selectedIndex];
            
            if(selectedOption && selectedOption.value) {
                // Salva l'ID del portiere nell'oggetto
                const campoId = tipo.includes('casa') ? 'portiereCasa' : 'portiereOspite';
                oggetto[campoId] = parseInt(selectedOption.value);
                
                // Mostra il nome
                if(document.getElementById(campoNome)) {
                    document.getElementById(campoNome).textContent = selectedOption.text;
                }
            }
        }
        
        function apriTab(tabName) {
            // Aggiorna tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Aggiorna contenuti
            document.querySelectorAll('.sezione').forEach(content => {
                content.classList.remove('attiva');
            });
            
            // Attiva tab selezionato
            const tabButtons = document.querySelectorAll('.admin-tab');
            for (let tab of tabButtons) {
                if (tab.onclick.toString().includes(`'${tabName}'`)) {
                    tab.classList.add('active');
                    break;
                }
            }
            
            // Mostra sezione corrispondente
            document.getElementById(tabName).classList.add('attiva');
            
            // Aggiorna dati specifici del tab
            if(tabName === 'dashboard') {
                aggiornaDashboard();
            } else if(tabName === 'gestionePartite') {
                caricaPartiteSalvate();
            }
        }
        
        function tornaMenu() {
            document.querySelectorAll('.sezione').forEach(content => {
                content.classList.remove('attiva');
            });
            document.getElementById('dashboard').classList.add('attiva');
            
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector('.admin-tab').classList.add('active');
        }
        
        function tornaHome() { 
            window.location.href = 'main.html'; 
        }
        
        function aggiornaDashboard() {
            // Statistiche
            document.getElementById('statSquadre').textContent = datiTorneo.squadre.length;
            document.getElementById('statGiocatori').textContent = datiTorneo.giocatori.length;
            document.getElementById('statPartite').textContent = datiTorneo.partite.length;
            
            let totGol = 0;
            datiTorneo.partite.forEach(p => {
                totGol += (p.gol_casa || 0) + (p.gol_ospite || 0);
            });
            document.getElementById('statGol').textContent = totGol;
            
            // Statistiche live
            const liveStats = document.getElementById('liveStats');
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.2em; font-weight: bold; color: #1976D2;">${datiTorneo.squadre.length}</div>
                        <div style="color: #666; font-size: 0.9em;">Squadre attive</div>
                    </div>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.2em; font-weight: bold; color: #4CAF50;">${datiTorneo.giocatori.filter(g => g.ruolo === 'Portiere').length}</div>
                        <div style="color: #666; font-size: 0.9em;">Portieri registrati</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.2em; font-weight: bold; color: #FF9800;">${totGol}</div>
                        <div style="color: #666; font-size: 0.9em;">Gol totali torneo</div>
                    </div>
                    <div style="background: #fce4ec; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.2em; font-weight: bold; color: #E91E63;">${datiTorneo.finale ? 'S√¨' : 'No'}</div>
                        <div style="color: #666; font-size: 0.9em;">Finale impostata</div>
                    </div>
                </div>
            `;
            
            if (ultimoAggiornamento) {
                html += `<p style="margin-top: 15px; color: #666; font-size: 0.9em;">Ultimo aggiornamento: ${ultimoAggiornamento.toLocaleTimeString('it-IT')}</p>`;
            }
            
            liveStats.innerHTML = html;
        }
        
        async function aggiungiSquadra() {
            const nome = document.getElementById('nomeSquadra').value.trim();
            const allenatore = document.getElementById('allenatore').value.trim();
            const colori = document.getElementById('colori').value.trim();
            
            if(!nome) { 
                mostraMessaggio("Inserisci il nome della squadra!", "error"); 
                return; 
            }
            
            // Controlla se esiste gi√†
            const esiste = datiTorneo.squadre.some(s => s.nome.toLowerCase() === nome.toLowerCase());
            if(esiste) {
                mostraMessaggio(`La squadra "${nome}" esiste gi√†!`, "error");
                return;
            }
            
            try {
                await database.aggiungiSquadra({
                    nome: nome,
                    allenatore: allenatore || "Non specificato",
                    colori: colori || "Non specificati",
                    punti: 0,
                    partite_giocate: 0,
                    vittorie: 0,
                    pareggi: 0,
                    sconfitte: 0,
                    gol_fatti: 0,
                    gol_subiti: 0
                });
                
                // Pulisci i campi
                document.getElementById('nomeSquadra').value = '';
                document.getElementById('allenatore').value = '';
                document.getElementById('colori').value = '';
                
                mostraMessaggio(`Squadra "${nome}" aggiunta!`, "success");
                
            } catch (error) {
                console.error("Errore:", error);
                mostraMessaggio("Errore nell'aggiunta della squadra: " + error.message, "error");
            }
        }
        
        async function aggiungiGiocatore() {
            const squadra = document.getElementById('squadraGiocatore').value;
            const nome = document.getElementById('nomeGiocatore').value.trim();
            const numero = document.getElementById('numeroMaglia').value;
            const ruolo = document.getElementById('ruolo').value;
            
            if(!squadra || !nome || !ruolo) { 
                mostraMessaggio("Compila tutti i campi obbligatori!", "error"); 
                return; 
            }
            
            // Controlla se esiste gi√†
            const esiste = datiTorneo.giocatori.some(g => 
                g.nome.toLowerCase() === nome.toLowerCase() && g.squadra === squadra
            );
            if(esiste) {
                mostraMessaggio(`Il giocatore "${nome}" √® gi√† registrato in questa squadra!`, "error");
                return;
            }
            
            try {
                await database.aggiungiGiocatore({
                    nome: nome,
                    numero: numero ? parseInt(numero) : null,
                    ruolo: ruolo,
                    squadra: squadra,
                    gol: 0,
                    ammonizioni: 0,
                    espulsioni: 0,
                    punteggio_totale: 0,
                    premi_miglior_giocatore: 0,
                    premi_miglior_portiere: 0
                });
                
                // Pulisci i campi
                document.getElementById('nomeGiocatore').value = '';
                document.getElementById('numeroMaglia').value = '';
                
                mostraMessaggio(`Giocatore "${nome}" aggiunto alla squadra ${squadra}!`, "success");
                
            } catch (error) {
                console.error("Errore:", error);
                mostraMessaggio("Errore nell'aggiunta del giocatore: " + error.message, "error");
            }
        }
        
        function caricaGiocatoriPartita(tipo) {
            let squadraCasa, squadraOspite;
            
            if(tipo === 'normale') {
                squadraCasa = document.getElementById('squadraCasa').value;
                squadraOspite = document.getElementById('squadraOspite').value;
                
                if(!squadraCasa || !squadraOspite) {
                    nascondiSezioniPartita('normale');
                    return;
                }
                
                caricaListaGiocatori('casa', squadraCasa, 'giocatoriCasa', tipo);
                document.getElementById('giocatoriCasaContainer').classList.remove('hidden');
                
                caricaListaGiocatori('ospite', squadraOspite, 'giocatoriOspite', tipo);
                document.getElementById('giocatoriOspiteContainer').classList.remove('hidden');
                
                caricaSelezioneMigliori(squadraCasa, squadraOspite, tipo);
                document.getElementById('selezioneMiglioriContainer').classList.remove('hidden');
                document.getElementById('eventiSalvatiContainer').classList.remove('hidden');
                
            } else if(tipo === 'finale') {
                squadraCasa = document.getElementById('finaleSquadraCasa').value;
                squadraOspite = document.getElementById('finaleSquadraOspite').value;
                
                if(!squadraCasa || !squadraOspite) {
                    nascondiSezioniPartita('finale');
                    return;
                }
                
                caricaListaGiocatori('casa', squadraCasa, 'finaleGiocatoriCasa', tipo);
                document.getElementById('finaleGiocatoriCasaContainer').classList.remove('hidden');
                
                caricaListaGiocatori('ospite', squadraOspite, 'finaleGiocatoriOspite', tipo);
                document.getElementById('finaleGiocatoriOspiteContainer').classList.remove('hidden');
                
                caricaSelezioneMigliori(squadraCasa, squadraOspite, tipo);
                document.getElementById('finaleSelezioneMiglioriContainer').classList.remove('hidden');
                document.getElementById('finaleEventiSalvatiContainer').classList.remove('hidden');
            }
        }
        
        function nascondiSezioniPartita(tipo) {
            if(tipo === 'normale') {
                document.getElementById('giocatoriCasaContainer').classList.add('hidden');
                document.getElementById('giocatoriOspiteContainer').classList.add('hidden');
                document.getElementById('selezioneMiglioriContainer').classList.add('hidden');
                document.getElementById('eventiSalvatiContainer').classList.add('hidden');
            } else {
                document.getElementById('finaleGiocatoriCasaContainer').classList.add('hidden');
                document.getElementById('finaleGiocatoriOspiteContainer').classList.add('hidden');
                document.getElementById('finaleSelezioneMiglioriContainer').classList.add('hidden');
                document.getElementById('finaleEventiSalvatiContainer').classList.add('hidden');
            }
        }
        
        function caricaListaGiocatori(tipoSquadra, nomeSquadra, containerId, modalita) {
            const giocatoriSquadra = datiTorneo.giocatori.filter(g => g.squadra === nomeSquadra);
            const container = document.getElementById(containerId);
            const oggettoEventi = modalita === 'normale' ? partitaInCorso : finaleInCorso;
            
            if(giocatoriSquadra.length === 0) {
                container.innerHTML = '<p class="avviso">Nessun giocatore in squadra</p>';
                return;
            }
            
            let html = '';
            giocatoriSquadra.forEach(giocatore => {
                // Conta eventi di questo giocatore
                const gol = oggettoEventi.eventi.filter(e => 
                    e.giocatoreId === giocatore.id && e.tipo === 'gol' && e.squadra === tipoSquadra
                ).length;
                
                const amm = oggettoEventi.eventi.filter(e => 
                    e.giocatoreId === giocatore.id && e.tipo === 'amm' && e.squadra === tipoSquadra
                ).length;
                
                const esp = oggettoEventi.eventi.filter(e => 
                    e.giocatoreId === giocatore.id && e.tipo === 'esp' && e.squadra === tipoSquadra
                ).length;
                
                html += `
                    <div class="giocatore-item">
                        <div class="giocatore-header">
                            <strong>${giocatore.nome}</strong>
                            <small>(${giocatore.ruolo} #${giocatore.numero || 'N/A'})</small>
                        </div>
                        
                        <div class="contatore-row">
                            <span class="contatore-label" style="color: #28a745;">‚öΩ Gol:</span>
                            <button class="contatore-btn btn-gol" onclick="modificaEvento(${giocatore.id}, 'gol', '${tipoSquadra}', 1, '${modalita}')">+</button>
                            <span class="contatore-valore" id="${modalita}-gol-${giocatore.id}-${tipoSquadra}">${gol}</span>
                            <button class="contatore-btn btn-gol" onclick="modificaEvento(${giocatore.id}, 'gol', '${tipoSquadra}', -1, '${modalita}')">-</button>
                        </div>
                        
                        <div class="contatore-row">
                            <span class="contatore-label" style="color: #ffc107;">üü® Ammonizioni:</span>
                            <button class="contatore-btn btn-amm" onclick="modificaEvento(${giocatore.id}, 'amm', '${tipoSquadra}', 1, '${modalita}')">+</button>
                            <span class="contatore-valore" id="${modalita}-amm-${giocatore.id}-${tipoSquadra}">${amm}</span>
                            <button class="contatore-btn btn-amm" onclick="modificaEvento(${giocatore.id}, 'amm', '${tipoSquadra}', -1, '${modalita}')">-</button>
                        </div>
                        
                        <div class="contatore-row">
                            <span class="contatore-label" style="color: #dc3545;">üü• Espulsioni:</span>
                            <button class="contatore-btn btn-esp" onclick="modificaEvento(${giocatore.id}, 'esp', '${tipoSquadra}', 1, '${modalita}')">+</button>
                            <span class="contatore-valore" id="${modalita}-esp-${giocatore.id}-${tipoSquadra}">${esp}</span>
                            <button class="contatore-btn btn-esp" onclick="modificaEvento(${giocatore.id}, 'esp', '${tipoSquadra}', -1, '${modalita}')">-</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function caricaSelezioneMigliori(squadraCasa, squadraOspite, modalita) {
            const giocatoriPartita = datiTorneo.giocatori.filter(g => 
                g.squadra === squadraCasa || g.squadra === squadraOspite
            );
            
            if(modalita === 'normale') {
                // Popola miglior giocatore (solo giocatori di campo)
                const selectGiocatore = document.getElementById('migliorGiocatore');
                selectGiocatore.innerHTML = '<option value="">-- Seleziona --</option>';
                
                giocatoriPartita.forEach(g => {
                    if(g.ruolo === 'Giocatore') {
                        const option = document.createElement('option');
                        option.value = g.id;
                        option.textContent = `${g.nome} (${g.squadra})`;
                        selectGiocatore.appendChild(option);
                    }
                });
                
                // Aggiungi listener per salvare la selezione
                selectGiocatore.onchange = function() {
                    if(this.value) {
                        partitaInCorso.migliorGiocatore = parseInt(this.value);
                        console.log(`Miglior giocatore selezionato: ID ${partitaInCorso.migliorGiocatore}`);
                    } else {
                        partitaInCorso.migliorGiocatore = null;
                    }
                };
                
                // Popola selezioni portieri
                popolaPortieri('portiereCasa', squadraCasa);
                popolaPortieri('portiereOspite', squadraOspite);
                
                // Reset
                partitaInCorso.migliorGiocatore = null;
                partitaInCorso.votoGiocatore = 0;
                partitaInCorso.portiereCasa = null;
                partitaInCorso.portiereOspite = null;
                partitaInCorso.votoPortiereCasa = 0;
                partitaInCorso.votoPortiereOspite = 0;
                
                document.getElementById('voto-miglior-giocatore-attuale').textContent = 'N/A';
                document.getElementById('voto-portiere-casa-attuale').textContent = 'N/A';
                document.getElementById('voto-portiere-ospite-attuale').textContent = 'N/A';
                document.getElementById('nome-portiere-casa').textContent = '';
                document.getElementById('nome-portiere-ospite').textContent = '';
                
            } else if(modalita === 'finale') {
                // Popola miglior giocatore per finale
                const selectGiocatore = document.getElementById('finaleMigliorGiocatore');
                selectGiocatore.innerHTML = '<option value="">-- Seleziona --</option>';
                
                giocatoriPartita.forEach(g => {
                    if(g.ruolo === 'Giocatore') {
                        const option = document.createElement('option');
                        option.value = g.id;
                        option.textContent = `${g.nome} (${g.squadra})`;
                        selectGiocatore.appendChild(option);
                    }
                });
                
                // Aggiungi listener per salvare la selezione (finale)
                selectGiocatore.onchange = function() {
                    if(this.value) {
                        finaleInCorso.migliorGiocatore = parseInt(this.value);
                        console.log(`Miglior giocatore finale selezionato: ID ${finaleInCorso.migliorGiocatore}`);
                    } else {
                        finaleInCorso.migliorGiocatore = null;
                    }
                };
                
                // Popola selezioni portieri finale
                popolaPortieri('finalePortiereCasa', squadraCasa);
                popolaPortieri('finalePortiereOspite', squadraOspite);
                
                // Reset finale
                finaleInCorso.migliorGiocatore = null;
                finaleInCorso.votoGiocatore = 0;
                finaleInCorso.portiereCasa = null;
                finaleInCorso.portiereOspite = null;
                finaleInCorso.votoPortiereCasa = 0;
                finaleInCorso.votoPortiereOspite = 0;
                
                document.getElementById('finale-voto-miglior-giocatore-attuale').textContent = 'N/A';
                document.getElementById('finale-voto-portiere-casa-attuale').textContent = 'N/A';
                document.getElementById('finale-voto-portiere-ospite-attuale').textContent = 'N/A';
                document.getElementById('finale-nome-portiere-casa').textContent = '';
                document.getElementById('finale-nome-portiere-ospite').textContent = '';
            }
            
            // Reset stelle
            document.querySelectorAll('.stella.selezionata').forEach(s => s.classList.remove('selezionata'));
        }
        
        function popolaPortieri(selectId, nomeSquadra) {
            const select = document.getElementById(selectId);
            if(!select) return;
            
            select.innerHTML = '<option value="">-- Seleziona Portiere --</option>';
            
            const portieriSquadra = datiTorneo.giocatori.filter(g => 
                g.squadra === nomeSquadra && g.ruolo === 'Portiere'
            );
            
            portieriSquadra.forEach(portiere => {
                const option = document.createElement('option');
                option.value = portiere.id;
                option.textContent = `${portiere.nome} (#${portiere.numero || 'N/A'})`;
                select.appendChild(option);
            });
        }
        
        function modificaEvento(giocatoreId, tipo, squadra, modifica, modalita) {
            const giocatore = datiTorneo.giocatori.find(g => g.id === giocatoreId);
            if(!giocatore) {
                mostraMessaggio("Giocatore non trovato!", "error");
                return;
            }
            
            const oggettoEventi = modalita === 'normale' ? partitaInCorso : finaleInCorso;
            const counterId = `${modalita}-${tipo}-${giocatoreId}-${squadra}`;
            const counterElement = document.getElementById(counterId);
            
            if(!counterElement) {
                console.error("Elemento contatore non trovato:", counterId);
                return;
            }
            
            let valore = parseInt(counterElement.textContent) || 0;
            let nuovoValore = valore + modifica;
            
            if(nuovoValore < 0) nuovoValore = 0;
            
            // Controllo gol massimi
            if(tipo === 'gol' && modifica === 1) {
                let golCasa, golOspite;
                if(modalita === 'normale') {
                    golCasa = parseInt(document.getElementById('golCasa').value) || 0;
                    golOspite = parseInt(document.getElementById('golOspite').value) || 0;
                } else {
                    golCasa = parseInt(document.getElementById('finaleGolCasa').value) || 0;
                    golOspite = parseInt(document.getElementById('finaleGolOspite').value) || 0;
                }
                
                const golMassimi = squadra === 'casa' ? golCasa : golOspite;
                const golAssegnati = oggettoEventi.eventi.filter(e => 
                    e.tipo === 'gol' && e.squadra === squadra
                ).length;
                
                if(golAssegnati >= golMassimi) {
                    mostraMessaggio(`Massimo ${golMassimi} gol per questa squadra!`, "warning");
                    return;
                }
            }
            
            // Aggiorna o rimuovi eventi
            if(modifica === 1) {
                // Aggiungi evento
                oggettoEventi.eventi.push({
                    id: Date.now(),
                    giocatoreId: giocatoreId,
                    giocatoreNome: giocatore.nome,
                    tipo: tipo,
                    squadra: squadra
                });
            } else if(modifica === -1 && valore > 0) {
                // Trova e rimuovi l'ultimo evento
                for(let i = oggettoEventi.eventi.length - 1; i >= 0; i--) {
                    if(oggettoEventi.eventi[i].giocatoreId === giocatoreId && 
                       oggettoEventi.eventi[i].tipo === tipo && 
                       oggettoEventi.eventi[i].squadra === squadra) {
                        oggettoEventi.eventi.splice(i, 1);
                        break;
                    }
                }
            }
            
            counterElement.textContent = nuovoValore;
            aggiornaRiepilogoEventi(modalita);
            controllaGol(modalita);
        }
        
        function aggiornaRiepilogoEventi(modalita) {
            let container, oggettoEventi;
            
            if(modalita === 'normale') {
                container = document.getElementById('eventiSalvati');
                oggettoEventi = partitaInCorso;
            } else {
                container = document.getElementById('finaleEventiSalvati');
                oggettoEventi = finaleInCorso;
            }
            
            if(!container) return;
            
            if(oggettoEventi.eventi.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Nessun evento registrato</p>';
                return;
            }
            
            const gol = oggettoEventi.eventi.filter(e => e.tipo === 'gol');
            const ammonizioni = oggettoEventi.eventi.filter(e => e.tipo === 'amm');
            const espulsioni = oggettoEventi.eventi.filter(e => e.tipo === 'esp');
            
            let html = '';
            
            if(gol.length > 0) {
                html += `<p><strong>‚öΩ Gol:</strong> ${gol.length}</p>`;
            }
            
            if(ammonizioni.length > 0) {
                html += `<p><strong>üü® Ammonizioni:</strong> ${ammonizioni.length}</p>`;
            }
            
            if(espulsioni.length > 0) {
                html += `<p><strong>üü• Espulsioni:</strong> ${espulsioni.length}</p>`;
            }
            
            container.innerHTML = html;
        }
        
        function controllaGol(modalita) {
            let golCasa, golOspite, golAssegnatiCasa, golAssegnatiOspite, avviso;
            
            if(modalita === 'normale') {
                golCasa = parseInt(document.getElementById('golCasa').value) || 0;
                golOspite = parseInt(document.getElementById('golOspite').value) || 0;
                golAssegnatiCasa = partitaInCorso.eventi.filter(e => e.tipo === 'gol' && e.squadra === 'casa').length;
                golAssegnatiOspite = partitaInCorso.eventi.filter(e => e.tipo === 'gol' && e.squadra === 'ospite').length;
                avviso = document.getElementById('avvisoGol');
            } else {
                golCasa = parseInt(document.getElementById('finaleGolCasa').value) || 0;
                golOspite = parseInt(document.getElementById('finaleGolOspite').value) || 0;
                golAssegnatiCasa = finaleInCorso.eventi.filter(e => e.tipo === 'gol' && e.squadra === 'casa').length;
                golAssegnatiOspite = finaleInCorso.eventi.filter(e => e.tipo === 'gol' && e.squadra === 'ospite').length;
                avviso = document.getElementById('finaleAvvisoGol');
            }
            
            if(!avviso) return;
            
            if(golAssegnatiCasa !== golCasa || golAssegnatiOspite !== golOspite) {
                avviso.textContent = `‚ö†Ô∏è Gol assegnati: ${golAssegnatiCasa}/${golCasa} - ${golAssegnatiOspite}/${golOspite}`;
                avviso.classList.add('errore');
            } else {
                avviso.textContent = '‚úÖ Gol assegnati correttamente!';
                avviso.classList.remove('errore');
            }
        }
        
        function cancellaEventi(modalita) {
            if(!confirm("Vuoi cancellare TUTTI gli eventi?")) return;
            
            if(modalita === 'normale') {
                partitaInCorso.eventi = [];
                caricaGiocatoriPartita('normale');
                aggiornaRiepilogoEventi('normale');
            } else {
                finaleInCorso.eventi = [];
                caricaGiocatoriPartita('finale');
                aggiornaRiepilogoEventi('finale');
            }
            
            mostraMessaggio("Eventi cancellati!", "success");
        }
        
        async function salvaPartita(modalita) {
            let squadraCasa, squadraOspite, golCasa, golOspite, oggetto;
            let dataPartita, oraPartita;
            
            if(modalita === 'normale') {
                squadraCasa = document.getElementById('squadraCasa').value;
                squadraOspite = document.getElementById('squadraOspite').value;
                golCasa = parseInt(document.getElementById('golCasa').value) || 0;
                golOspite = parseInt(document.getElementById('golOspite').value) || 0;
                dataPartita = document.getElementById('partitaData').value;
                oraPartita = document.getElementById('partitaOra').value;
                oggetto = partitaInCorso;
            } else {
                squadraCasa = document.getElementById('finaleSquadraCasa').value;
                squadraOspite = document.getElementById('finaleSquadraOspite').value;
                golCasa = parseInt(document.getElementById('finaleGolCasa').value) || 0;
                golOspite = parseInt(document.getElementById('finaleGolOspite').value) || 0;
                dataPartita = document.getElementById('finaleData').value;
                oraPartita = document.getElementById('finaleOra').value;
                oggetto = finaleInCorso;
            }
            
            // Validazioni
            if(!squadraCasa || !squadraOspite) { 
                mostraMessaggio("Seleziona entrambe le squadre!", "error"); 
                return; 
            }
            
            if(squadraCasa === squadraOspite) { 
                mostraMessaggio("Seleziona due squadre diverse!", "error"); 
                return; 
            }
            
            if(!dataPartita || !oraPartita) {
                mostraMessaggio("Inserisci data e ora della partita!", "error");
                return;
            }
            
            // Controllo gol
            const golAssegnatiCasa = oggetto.eventi.filter(e => e.tipo === 'gol' && e.squadra === 'casa').length;
            const golAssegnatiOspite = oggetto.eventi.filter(e => e.tipo === 'gol' && e.squadra === 'ospite').length;
            
            if(golAssegnatiCasa !== golCasa || golAssegnatiOspite !== golOspite) {
                mostraMessaggio(`Gol assegnati non corrispondono!\n${golAssegnatiCasa}/${golCasa} - ${golAssegnatiOspite}/${golOspite}`, "error");
                return;
            }
            
            // Controllo miglior giocatore
            if(!oggetto.migliorGiocatore) {
                mostraMessaggio("Devi selezionare un miglior giocatore!", "error");
                return;
            }
            
            if(oggetto.votoGiocatore === 0) {
                mostraMessaggio("Devi dare un voto al miglior giocatore!", "error");
                return;
            }
            
            // Controllo portieri selezionati
            if(!oggetto.portiereCasa) {
                mostraMessaggio("Devi selezionare il portiere della squadra casa!", "error");
                return;
            }
            
            if(!oggetto.portiereOspite) {
                mostraMessaggio("Devi selezionare il portiere della squadra ospite!", "error");
                return;
            }
            
            if(oggetto.votoPortiereCasa === 0) {
                mostraMessaggio("Devi dare un voto al portiere della squadra casa!", "error");
                return;
            }
            
            if(oggetto.votoPortiereOspite === 0) {
                mostraMessaggio("Devi dare un voto al portiere della squadra ospite!", "error");
                return;
            }
            
            if(!confirm(`Salvare la ${modalita === 'normale' ? 'partita' : 'finale'}?\n${squadraCasa} ${golCasa}-${golOspite} ${squadraOspite}`)) {
                return;
            }
            
            try {
                // 1. Trova le squadre nel database
                const squadraCasaData = datiTorneo.squadre.find(s => s.nome === squadraCasa);
                const squadraOspiteData = datiTorneo.squadre.find(s => s.nome === squadraOspite);
                
                if(!squadraCasaData || !squadraOspiteData) {
                    mostraMessaggio("Errore: una delle squadre non √® stata trovata nel database!", "error");
                    return;
                }
                
                // 2. Calcola punti
                let puntiCasa = 0, puntiOspite = 0;
                if(golCasa > golOspite) puntiCasa = 3;
                else if(golCasa < golOspite) puntiOspite = 3;
                else { puntiCasa = 1; puntiOspite = 1; }
                
                // 3. Prepara dati partita per il salvataggio
                const partitaData = {
                    data: dataPartita,
                    ora: oraPartita,
                    squadra_casa: squadraCasa,
                    squadra_ospite: squadraOspite,
                    gol_casa: golCasa,
                    gol_ospite: golOspite,
                    eventi: oggetto.eventi,
                    miglior_giocatore: oggetto.migliorGiocatore,
                    voto_miglior_giocatore: oggetto.votoGiocatore,
                    portiere_casa: oggetto.portiereCasa,
                    portiere_ospite: oggetto.portiereOspite,
                    voto_portiere_casa: oggetto.votoPortiereCasa,
                    voto_portiere_ospite: oggetto.votoPortiereOspite
                };
                
                // 4. Salva partita/finale
                if(modalita === 'normale') {
                    await database.aggiungiPartita(partitaData);
                    
                    // 5. Aggiorna statistiche squadre (solo per partite normali, non per finale)
                    await database.aggiornaSquadra(squadraCasaData.id, {
                        punti: (squadraCasaData.punti || 0) + puntiCasa,
                        partite_giocate: (squadraCasaData.partite_giocate || 0) + 1,
                        gol_fatti: (squadraCasaData.gol_fatti || 0) + golCasa,
                        gol_subiti: (squadraCasaData.gol_subiti || 0) + golOspite,
                        vittorie: (squadraCasaData.vittorie || 0) + (puntiCasa === 3 ? 1 : 0),
                        pareggi: (squadraCasaData.pareggi || 0) + (puntiCasa === 1 ? 1 : 0),
                        sconfitte: (squadraCasaData.sconfitte || 0) + (puntiCasa === 0 ? 1 : 0)
                    });
                    
                    await database.aggiornaSquadra(squadraOspiteData.id, {
                        punti: (squadraOspiteData.punti || 0) + puntiOspite,
                        partite_giocate: (squadraOspiteData.partite_giocate || 0) + 1,
                        gol_fatti: (squadraOspiteData.gol_fatti || 0) + golOspite,
                        gol_subiti: (squadraOspiteData.gol_subiti || 0) + golCasa,
                        vittorie: (squadraOspiteData.vittorie || 0) + (puntiOspite === 3 ? 1 : 0),
                        pareggi: (squadraOspiteData.pareggi || 0) + (puntiOspite === 1 ? 1 : 0),
                        sconfitte: (squadraOspiteData.sconfitte || 0) + (puntiOspite === 0 ? 1 : 0)
                    });
                    
                    // 6. Aggiorna statistiche giocatori (gol, ammonizioni, espulsioni)
                    for(const evento of oggetto.eventi) {
                        const giocatore = datiTorneo.giocatori.find(g => g.id === evento.giocatoreId);
                        if(giocatore) {
                            const updates = {};
                            if(evento.tipo === 'gol') updates.gol = (giocatore.gol || 0) + 1;
                            else if(evento.tipo === 'amm') updates.ammonizioni = (giocatore.ammonizioni || 0) + 1;
                            else if(evento.tipo === 'esp') updates.espulsioni = (giocatore.espulsioni || 0) + 1;
                            
                            if(Object.keys(updates).length > 0) {
                                await database.aggiornaGiocatore(giocatore.id, updates);
                            }
                        }
                    }
                    
                    // 7. Aggiorna miglior giocatore (campo)
                    const migliorGiocatore = datiTorneo.giocatori.find(g => g.id === oggetto.migliorGiocatore);
                    if(migliorGiocatore && migliorGiocatore.ruolo === 'Giocatore') {
                        await database.aggiornaGiocatore(migliorGiocatore.id, {
                            punteggio_totale: (migliorGiocatore.punteggio_totale || 0) + oggetto.votoGiocatore,
                            premi_miglior_giocatore: (migliorGiocatore.premi_miglior_giocatore || 0) + 1
                        });
                    }
                    
                    // 8. Aggiorna portiere casa
                    const portiereCasa = datiTorneo.giocatori.find(g => g.id === oggetto.portiereCasa);
                    if(portiereCasa && portiereCasa.ruolo === 'Portiere') {
                        await database.aggiornaGiocatore(portiereCasa.id, {
                            punteggio_totale: (portiereCasa.punteggio_totale || 0) + oggetto.votoPortiereCasa,
                            premi_miglior_portiere: (portiereCasa.premi_miglior_portiere || 0) + 1
                        });
                    }
                    
                    // 9. Aggiorna portiere ospite
                    const portiereOspite = datiTorneo.giocatori.find(g => g.id === oggetto.portiereOspite);
                    if(portiereOspite && portiereOspite.ruolo === 'Portiere') {
                        await database.aggiornaGiocatore(portiereOspite.id, {
                            punteggio_totale: (portiereOspite.punteggio_totale || 0) + oggetto.votoPortiereOspite,
                            premi_miglior_portiere: (portiereOspite.premi_miglior_portiere || 0) + 1
                        });
                    }
                    
                    mostraMessaggio(`‚úÖ Partita salvata!\n${squadraCasa} ${golCasa}-${golOspite} ${squadraOspite}`, "success");
                    
                    // Reset partita in corso
                    partitaInCorso = {
                        eventi: [],
                        migliorGiocatore: null,
                        votoGiocatore: 0,
                        portiereCasa: null,
                        portiereOspite: null,
                        votoPortiereCasa: 0,
                        votoPortiereOspite: 0
                    };
                    
                    // Reset interfaccia
                    document.getElementById('partitaData').value = '';
                    document.getElementById('partitaOra').value = '';
                    document.getElementById('golCasa').value = 0;
                    document.getElementById('golOspite').value = 0;
                    document.getElementById('voto-miglior-giocatore-attuale').textContent = 'N/A';
                    document.getElementById('voto-portiere-casa-attuale').textContent = 'N/A';
                    document.getElementById('voto-portiere-ospite-attuale').textContent = 'N/A';
                    document.getElementById('migliorGiocatore').value = '';
                    document.getElementById('portiereCasa').value = '';
                    document.getElementById('portiereOspite').value = '';
                    document.getElementById('nome-portiere-casa').textContent = '';
                    document.getElementById('nome-portiere-ospite').textContent = '';
                    
                } else {
                    // Per la finale, salva senza aggiornare statistiche squadre
                    await database.salvaFinale(partitaData);
                    mostraMessaggio(`üèÜ FINALE salvata!\n${squadraCasa} ${golCasa}-${golOspite} ${squadraOspite}`, "success");
                    
                    // Reset finale in corso
                    finaleInCorso = {
                        eventi: [],
                        migliorGiocatore: null,
                        votoGiocatore: 0,
                        portiereCasa: null,
                        portiereOspite: null,
                        votoPortiereCasa: 0,
                        votoPortiereOspite: 0
                    };
                    
                    // Reset interfaccia finale
                    document.getElementById('finaleData').value = '';
                    document.getElementById('finaleOra').value = '';
                    document.getElementById('finaleGolCasa').value = 0;
                    document.getElementById('finaleGolOspite').value = 0;
                    document.getElementById('finale-voto-miglior-giocatore-attuale').textContent = 'N/A';
                    document.getElementById('finale-voto-portiere-casa-attuale').textContent = 'N/A';
                    document.getElementById('finale-voto-portiere-ospite-attuale').textContent = 'N/A';
                    document.getElementById('finaleMigliorGiocatore').value = '';
                    document.getElementById('finalePortiereCasa').value = '';
                    document.getElementById('finalePortiereOspite').value = '';
                    document.getElementById('finale-nome-portiere-casa').textContent = '';
                    document.getElementById('finale-nome-portiere-ospite').textContent = '';
                }
                
                // Ricarica i giocatori per mostrare contatori azzerati
                caricaGiocatoriPartita(modalita);
                aggiornaRiepilogoEventi(modalita);
                
            } catch (error) {
                console.error("Errore nel salvataggio:", error);
                mostraMessaggio("Errore nel salvataggio: " + error.message, "error");
            }
        }
        
        async function caricaPartiteSalvate() {
            const container = document.getElementById('listaPartite');
            
            if(!container) return;
            
            if(datiTorneo.partite.length === 0) {
                container.innerHTML = '<p class="avviso">Nessuna partita salvata</p>';
                return;
            }
            
            let html = '';
            
            // Ordina per data (le pi√π recenti prima)
            const partiteOrdinate = [...datiTorneo.partite].sort((a, b) => {
                return new Date(b.created_at) - new Date(a.created_at);
            });
            
            partiteOrdinate.forEach((partita, index) => {
                const migliorGiocatoreNome = datiTorneo.giocatori.find(g => g.id === partita.miglior_giocatore)?.nome || 'N/A';
                const portiereCasaNome = datiTorneo.giocatori.find(g => g.id === partita.portiere_casa)?.nome || 'N/A';
                const portiereOspiteNome = datiTorneo.giocatori.find(g => g.id === partita.portiere_ospite)?.nome || 'N/A';
                
                const eventi = partita.eventi || [];
                const gol = eventi.filter(e => e.tipo === 'gol').length;
                const ammonizioni = eventi.filter(e => e.tipo === 'amm').length;
                const espulsioni = eventi.filter(e => e.tipo === 'esp').length;
                
                html += `
                    <div class="partita-item">
                        <div class="partita-header">
                            <div>
                                <strong>${partita.data} ${partita.ora}</strong><br>
                                <span style="font-size: 1.2em; font-weight: bold;">
                                    ${partita.squadra_casa} ${partita.gol_casa}-${partita.gol_ospite} ${partita.squadra_ospite}
                                </span>
                            </div>
                        </div>
                        
                        <p>‚öΩ Gol giocatori: ${gol} | üü® Ammonizioni: ${ammonizioni} | üü• Espulsioni: ${espulsioni}</p>
                        <p>üèÜ <strong>Miglior Giocatore:</strong> ${migliorGiocatoreNome} (Voto: ${partita.voto_miglior_giocatore || 0}/10)</p>
                        <p>ü•Ö <strong>Portiere Casa:</strong> ${portiereCasaNome} (Voto: ${partita.voto_portiere_casa || 0}/10)</p>
                        <p>ü•Ö <strong>Portiere Ospite:</strong> ${portiereOspiteNome} (Voto: ${partita.voto_portiere_ospite || 0}/10)</p>
                        
                        <button class="btn-elimina" onclick="eliminaPartita('${partita.id}')">üóëÔ∏è Elimina Partita</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function eliminaPartita(partitaId) {
            if(!confirm("‚ö†Ô∏è Eliminare questa partita?\nVerranno rimossi tutti i punti e statistiche.")) return;
            
            try {
                // Trova la partita da eliminare
                const partita = datiTorneo.partite.find(p => p.id === partitaId);
                if(!partita) {
                    mostraMessaggio("Partita non trovata!", "error");
                    return;
                }
                
                // 1. Trova le squadre
                const squadraCasa = datiTorneo.squadre.find(s => s.nome === partita.squadra_casa);
                const squadraOspite = datiTorneo.squadre.find(s => s.nome === partita.squadra_ospite);
                
                if(!squadraCasa || !squadraOspite) {
                    mostraMessaggio("Errore: una delle squadre non √® stata trovata!", "error");
                    return;
                }
                
                // 2. Calcola punti da rimuovere
                let puntiCasa = 0, puntiOspite = 0;
                if(partita.gol_casa > partita.gol_ospite) puntiCasa = 3;
                else if(partita.gol_casa < partita.gol_ospite) puntiOspite = 3;
                else { puntiCasa = 1; puntiOspite = 1; }
                
                // 3. Aggiorna squadre (rimuovi punti)
                await database.aggiornaSquadra(squadraCasa.id, {
                    punti: Math.max(0, (squadraCasa.punti || 0) - puntiCasa),
                    partite_giocate: Math.max(0, (squadraCasa.partite_giocate || 0) - 1),
                    gol_fatti: Math.max(0, (squadraCasa.gol_fatti || 0) - partita.gol_casa),
                    gol_subiti: Math.max(0, (squadraCasa.gol_subiti || 0) - partita.gol_ospite),
                    vittorie: Math.max(0, (squadraCasa.vittorie || 0) - (puntiCasa === 3 ? 1 : 0)),
                    pareggi: Math.max(0, (squadraCasa.pareggi || 0) - (puntiCasa === 1 ? 1 : 0)),
                    sconfitte: Math.max(0, (squadraCasa.sconfitte || 0) - (puntiCasa === 0 ? 1 : 0))
                });
                
                await database.aggiornaSquadra(squadraOspite.id, {
                    punti: Math.max(0, (squadraOspite.punti || 0) - puntiOspite),
                    partite_giocate: Math.max(0, (squadraOspite.partite_giocate || 0) - 1),
                    gol_fatti: Math.max(0, (squadraOspite.gol_fatti || 0) - partita.gol_ospite),
                    gol_subiti: Math.max(0, (squadraOspite.gol_subiti || 0) - partita.gol_casa),
                    vittorie: Math.max(0, (squadraOspite.vittorie || 0) - (puntiOspite === 3 ? 1 : 0)),
                    pareggi: Math.max(0, (squadraOspite.pareggi || 0) - (puntiOspite === 1 ? 1 : 0)),
                    sconfitte: Math.max(0, (squadraOspite.sconfitte || 0) - (puntiOspite === 0 ? 1 : 0))
                });
                
                // 4. Rimuovi statistiche giocatori
                const eventi = partita.eventi || [];
                for(const evento of eventi) {
                    const giocatore = datiTorneo.giocatori.find(g => g.id === evento.giocatoreId);
                    if(giocatore) {
                        const updates = {};
                        if(evento.tipo === 'gol') updates.gol = Math.max(0, (giocatore.gol || 0) - 1);
                        else if(evento.tipo === 'amm') updates.ammonizioni = Math.max(0, (giocatore.ammonizioni || 0) - 1);
                        else if(evento.tipo === 'esp') updates.espulsioni = Math.max(0, (giocatore.espulsioni || 0) - 1);
                        
                        if(Object.keys(updates).length > 0) {
                            await database.aggiornaGiocatore(giocatore.id, updates);
                        }
                    }
                }
                
                // 5. Rimuovi voti miglior giocatore
                if(partita.miglior_giocatore) {
                    const mg = datiTorneo.giocatori.find(g => g.id === partita.miglior_giocatore);
                    if(mg && mg.ruolo === 'Giocatore') {
                        await database.aggiornaGiocatore(mg.id, {
                            punteggio_totale: Math.max(0, (mg.punteggio_totale || 0) - (partita.voto_miglior_giocatore || 0)),
                            premi_miglior_giocatore: Math.max(0, (mg.premi_miglior_giocatore || 0) - 1)
                        });
                    }
                }
                
                // 6. Rimuovi voti portiere casa
                if(partita.portiere_casa) {
                    const pc = datiTorneo.giocatori.find(g => g.id === partita.portiere_casa);
                    if(pc && pc.ruolo === 'Portiere') {
                        await database.aggiornaGiocatore(pc.id, {
                            punteggio_totale: Math.max(0, (pc.punteggio_totale || 0) - (partita.voto_portiere_casa || 0)),
                            premi_miglior_portiere: Math.max(0, (pc.premi_miglior_portiere || 0) - 1)
                        });
                    }
                }
                
                // 7. Rimuovi voti portiere ospite
                if(partita.portiere_ospite) {
                    const po = datiTorneo.giocatori.find(g => g.id === partita.portiere_ospite);
                    if(po && po.ruolo === 'Portiere') {
                        await database.aggiornaGiocatore(po.id, {
                            punteggio_totale: Math.max(0, (po.punteggio_totale || 0) - (partita.voto_portiere_ospite || 0)),
                            premi_miglior_portiere: Math.max(0, (po.premi_miglior_portiere || 0) - 1)
                        });
                    }
                }
                
                // 8. Elimina la partita dal database
                await database.eliminaPartita(partitaId);
                
                mostraMessaggio("Partita eliminata!", "success");
                
            } catch (error) {
                console.error("Errore eliminazione partita:", error);
                mostraMessaggio("Errore nell'eliminazione: " + error.message, "error");
            }
        }
        
        async function eliminaPartitaSelezionata() {
            const partitaId = document.getElementById('partitaDaEliminare').value;
            if (!partitaId) {
                mostraMessaggio('Seleziona una partita', 'error');
                return;
            }
            
            await eliminaPartita(partitaId);
            document.getElementById('partitaDaEliminare').value = '';
        }
        
        // FUNZIONI ELIMINAZIONE (solo per gestione)
        function mostraOpzioniElimina() {
            const tipo = document.getElementById('tipoElimina').value;
            const container = document.getElementById('opzioniElimina');
            const btnElimina = document.getElementById('btnElimina');
            
            if(!tipo) { 
                container.classList.add('hidden'); 
                btnElimina.classList.add('hidden'); 
                return; 
            }
            
            let html = '';
            if(tipo === 'giocatore') {
                html = `<div class="form-row"><div class="form-group">
                    <label>Seleziona giocatore:</label>
                    <select id="giocatoreDaEliminare">
                        <option value="">Seleziona giocatore</option>`;
                datiTorneo.giocatori.forEach(g => {
                    html += `<option value="${g.id}">${g.nome} (${g.squadra})</option>`;
                });
                html += `</select></div></div>`;
            } else if(tipo === 'squadra') {
                html = `<div class="form-row"><div class="form-group">
                    <label>Seleziona squadra:</label>
                    <select id="squadraDaEliminare">
                        <option value="">Seleziona squadra</option>`;
                datiTorneo.squadre.forEach(s => {
                    html += `<option value="${s.id}">${s.nome}</option>`;
                });
                html += `</select></div></div>
                <p class="avviso"><small>Attenzione: Verranno eliminati anche tutti i giocatori della squadra!</small></p>`;
            } else if(tipo === 'tutto') {
                html = `<div class="danger-zone">
                    <h3>‚ö†Ô∏è PERICOLO</h3>
                    <p>Questa operazione canceller√† TUTTO il database!</p>
                    <label><input type="checkbox" id="confermaEliminaTutto"> Confermo di voler eliminare TUTTO</label>
                </div>`;
            }
            
            container.innerHTML = html;
            container.classList.remove('hidden');
            btnElimina.classList.remove('hidden');
        }
        
        async function eseguiEliminazione() {
            const tipo = document.getElementById('tipoElimina').value;
            
            if(tipo === 'giocatore') {
                const giocatoreId = document.getElementById('giocatoreDaEliminare').value;
                if(!giocatoreId) {
                    mostraMessaggio("Seleziona un giocatore!", "error");
                    return;
                }
                
                const giocatore = datiTorneo.giocatori.find(g => g.id === parseInt(giocatoreId));
                if(!giocatore) {
                    mostraMessaggio("Giocatore non trovato!", "error");
                    return;
                }
                
                if(confirm(`Eliminare il giocatore "${giocatore.nome}" dalla squadra ${giocatore.squadra}?`)) {
                    try {
                        await database.eliminaGiocatore(parseInt(giocatoreId));
                        mostraMessaggio("Giocatore eliminato!", "success");
                        mostraOpzioniElimina();
                    } catch (error) {
                        mostraMessaggio("Errore nell'eliminazione: " + error.message, "error");
                    }
                }
                
            } else if(tipo === 'squadra') {
                const squadraId = document.getElementById('squadraDaEliminare').value;
                if(!squadraId) {
                    mostraMessaggio("Seleziona una squadra!", "error");
                    return;
                }
                
                const squadra = datiTorneo.squadre.find(s => s.id === parseInt(squadraId));
                if(!squadra) {
                    mostraMessaggio("Squadra non trovata!", "error");
                    return;
                }
                
                // Conta giocatori della squadra
                const giocatoriSquadra = datiTorneo.giocatori.filter(g => g.squadra === squadra.nome);
                
                if(confirm(`Eliminare la squadra "${squadra.nome}" con ${giocatoriSquadra.length} giocatori?`)) {
                    try {
                        // Prima elimina tutti i giocatori della squadra
                        for(const giocatore of giocatoriSquadra) {
                            await database.eliminaGiocatore(giocatore.id);
                        }
                        
                        // Poi elimina la squadra
                        await database.eliminaSquadra(parseInt(squadraId));
                        
                        mostraMessaggio("Squadra eliminata!", "success");
                        mostraOpzioniElimina();
                    } catch (error) {
                        mostraMessaggio("Errore nell'eliminazione: " + error.message, "error");
                    }
                }
                
            } else if(tipo === 'tutto') {
                const conferma = document.getElementById('confermaEliminaTutto');
                if(!conferma || !conferma.checked) { 
                    mostraMessaggio("Devi selezionare la casella di conferma!", "error"); 
                    return; 
                }
                
                eliminaTuttoDatabase();
            }
        }
        
        // GESTIONE FINALE
        function caricaFinaleEsistente() {
            if (!datiTorneo.finale) {
                mostraMessaggio('Nessuna finale salvata', 'warning');
                return;
            }
            
            const f = datiTorneo.finale;
            
            document.getElementById('finaleData').value = f.data || '';
            document.getElementById('finaleOra').value = f.ora || '';
            document.getElementById('finaleSquadraCasa').value = f.squadra_casa || '';
            document.getElementById('finaleSquadraOspite').value = f.squadra_ospite || '';
            document.getElementById('finaleGolCasa').value = f.gol_casa || 0;
            document.getElementById('finaleGolOspite').value = f.gol_ospite || 0;
            document.getElementById('finaleMigliorGiocatore').value = f.miglior_giocatore || '';
            document.getElementById('finaleVotoMigliorGiocatore').value = f.voto_miglior_giocatore || '';
            document.getElementById('finalePortiereCasa').value = f.portiere_casa || '';
            document.getElementById('finaleVotoPortiereCasa').value = f.voto_portiere_casa || '';
            document.getElementById('finalePortiereOspite').value = f.portiere_ospite || '';
            document.getElementById('finaleVotoPortiereOspite').value = f.voto_portiere_ospite || '';
            
            finaleEventi = f.eventi || [];
            
            mostraMessaggio('Finale caricata nel form', 'success');
        }
        
        async function eliminaFinale() {
            if(!confirm('ELIMINARE TUTTA LA FINALE?\nTutti i dati della partita finale verranno eliminati permanentemente.')) return;
            
            try {
                // Elimina finale dal database
                await database.eliminaFinale();
                finaleEventi = [];
                
                // Reset form
                document.getElementById('finaleData').value = '';
                document.getElementById('finaleOra').value = '';
                document.getElementById('finaleGolCasa').value = '0';
                document.getElementById('finaleGolOspite').value = '0';
                document.getElementById('finaleMigliorGiocatore').value = '';
                document.getElementById('finaleVotoMigliorGiocatore').value = '';
                document.getElementById('finalePortiereCasa').value = '';
                document.getElementById('finaleVotoPortiereCasa').value = '';
                document.getElementById('finalePortiereOspite').value = '';
                document.getElementById('finaleVotoPortiereOspite').value = '';
                
                mostraMessaggio('Finale eliminata con successo', 'success');
                
            } catch (error) {
                console.error('Errore eliminazione finale:', error);
                mostraMessaggio('Errore nell\'eliminazione della finale', 'error');
            }
        }
        
        // LISTE
        function aggiornaListaGiocatori() {
            const container = document.getElementById('listaGiocatori');
            
            if (datiTorneo.giocatori.length === 0) {
                container.innerHTML = '<p class="avviso">Nessun giocatore registrato.</p>';
                return;
            }
            
            let html = '';
            datiTorneo.giocatori.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(giocatore => {
                html += `
                    <div class="partita-item">
                        <div class="partita-header">
                            <div>
                                <strong>${giocatore.nome}</strong>
                                <div style="color: #666; font-size: 0.9em;">
                                    ${giocatore.squadra} | ${giocatore.ruolo} 
                                    ${giocatore.numero ? `| #${giocatore.numero}` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            ${giocatore.gol > 0 ? `<span style="background: #90EE90; padding: 4px 8px; border-radius: 3px; font-size: 0.9em;">‚öΩ ${giocatore.gol}</span>` : ''}
                            ${giocatore.ammonizioni > 0 ? `<span style="background: #FFFACD; padding: 4px 8px; border-radius: 3px; font-size: 0.9em;">üü® ${giocatore.ammonizioni}</span>` : ''}
                            ${giocatore.espulsioni > 0 ? `<span style="background: #FFB6C1; padding: 4px 8px; border-radius: 3px; font-size: 0.9em;">üü• ${giocatore.espulsioni}</span>` : ''}
                            ${giocatore.punteggio_totale > 0 ? `<span style="background: #e3f2fd; padding: 4px 8px; border-radius: 3px; font-size: 0.9em;">‚≠ê ${giocatore.punteggio_totale}</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function aggiornaListaSquadre() {
            const container = document.getElementById('listaSquadre');
            
            if (datiTorneo.squadre.length === 0) {
                container.innerHTML = '<p class="avviso">Nessuna squadra registrata.</p>';
                return;
            }
            
            let html = '';
            datiTorneo.squadre.sort((a, b) => b.punti - a.punti).forEach(squadra => {
                html += `
                    <div class="partita-item">
                        <div class="partita-header">
                            <div>
                                <strong>${squadra.nome}</strong>
                                <div style="color: #666; font-size: 0.9em;">
                                    ${squadra.allenatore ? `Allenatore: ${squadra.allenatore}` : ''}
                                    ${squadra.colori ? ` | Colori: ${squadra.colori}` : ''}
                                </div>
                            </div>
                        </div>
                        <div>
                            <div style="font-weight: bold; color: #1e3c72; font-size: 1.2em;">${squadra.punti} pt</div>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                Partite: ${squadra.partite_giocate || 0} | 
                                V:${squadra.vittorie || 0} P:${squadra.pareggi || 0} S:${squadra.sconfitte || 0} |
                                GF:${squadra.gol_fatti || 0} GS:${squadra.gol_subiti || 0}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // DANGER ZONE FUNCTIONS
        async function eliminaTuttePartite() {
            if (!confirm('ELIMINARE TUTTE LE PARTITE?\nTutte le partite, eventi e voti verranno eliminati. La classifica verr√† resettata.')) return;
            
            try {
                // Prima resetta statistiche squadre
                for (const squadra of datiTorneo.squadre) {
                    await database.aggiornaSquadra(squadra.id, {
                        partite_giocate: 0,
                        vittorie: 0,
                        pareggi: 0,
                        sconfitte: 0,
                        gol_fatti: 0,
                        gol_subiti: 0,
                        punti: 0
                    });
                }
                
                // Poi elimina tutte le partite
                for (const partita of datiTorneo.partite) {
                    await database.eliminaPartita(partita.id);
                }
                
                mostraMessaggio('Tutte le partite eliminate e classifica resettata', 'success');
                
            } catch (error) {
                console.error('Errore eliminazione partite:', error);
                mostraMessaggio('Errore nell\'eliminazione delle partite', 'error');
            }
        }
        
        async function resetStatisticheGiocatori() {
            if (!confirm('RESETTARE TUTTE LE STATISTICHE DEI GIOCATORI?\nTutti i gol, ammonizioni, espulsioni e voti verranno azzerati.')) return;
            
            try {
                for (const giocatore of datiTorneo.giocatori) {
                    await database.aggiornaGiocatore(giocatore.id, {
                        gol: 0,
                        ammonizioni: 0,
                        espulsioni: 0,
                        punteggio_totale: 0,
                        premi_miglior_giocatore: 0,
                        premi_miglior_portiere: 0
                    });
                }
                
                mostraMessaggio('Statistiche giocatori resettate', 'success');
                
            } catch (error) {
                console.error('Errore reset statistiche:', error);
                mostraMessaggio('Errore nel reset delle statistiche', 'error');
            }
        }
        
        async function resetClassificaSquadre() {
            if (!confirm('RESETTARE LA CLASSIFICA?\nTutti i punti e le statistiche delle squadre verranno azzerati.')) return;
            
            try {
                for (const squadra of datiTorneo.squadre) {
                    await database.aggiornaSquadra(squadra.id, {
                        punti: 0,
                        partite_giocate: 0,
                        vittorie: 0,
                        pareggi: 0,
                        sconfitte: 0,
                        gol_fatti: 0,
                        gol_subiti: 0
                    });
                }
                
                mostraMessaggio('Classifica resettata', 'success');
                
            } catch (error) {
                console.error('Errore reset classifica:', error);
                mostraMessaggio('Errore nel reset della classifica', 'error');
            }
        }
        
        async function eliminaTuttoDatabase() {
            if (!confirm('üí£ ELIMINARE TUTTO IL DATABASE?\nQuesta operazione ELIMINER√Ä TUTTO: squadre, giocatori, partite, finale. NON C\'√à POSSIBILIT√Ä DI RECUPERO!')) {
                return;
            }
            
            // Seconda conferma
            const confermaTesto = prompt('Scrivi "ELIMINA TUTTO" per confermare definitivamente:');
            if (confermaTesto !== 'ELIMINA TUTTO') {
                mostraMessaggio('Operazione annullata', 'warning');
                return;
            }
            
            try {
                await database.eliminaTutto();
                mostraMessaggio('Database completamente eliminato', 'success');
                setTimeout(() => location.reload(), 2000);
                
            } catch (error) {
                console.error('Errore eliminazione database:', error);
                mostraMessaggio('Errore nell\'eliminazione del database', 'error');
            }
        }
        
        // UTILITY FUNCTIONS
        function caricaDati() {
            location.reload();
        }
        
        function esportaBackup() {
            const backup = {
                timestamp: new Date().toISOString(),
                squadre: datiTorneo.squadre,
                giocatori: datiTorneo.giocatori,
                partite: datiTorneo.partite,
                finale: datiTorneo.finale
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rovigoal-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostraMessaggio('Backup esportato', 'success');
        }
        
        function importaBackup() {
            mostraMessaggio('Funzionalit√† di import da implementare', 'warning');
        }
        
        function logoutAdmin() {
            sessionStorage.removeItem('admin_accesso');
            window.location.href = 'main.html';
        }
        
        // MESSAGGI E CONFERME
        function mostraMessaggio(testo, tipo = 'info', durata = 5000) {
            const container = document.getElementById('messageContainer');
            
            const message = document.createElement('div');
            message.className = `message ${tipo}`;
            message.innerHTML = testo;
            
            container.appendChild(message);
            
            // Rimuovi dopo la durata
            setTimeout(() => {
                if (message.parentNode) {
                    message.style.opacity = '0';
                    message.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        if (message.parentNode) {
                            message.parentNode.removeChild(message);
                        }
                    }, 500);
                }
            }, durata);
        }
        
        // ESPORTA FUNZIONI GLOBALI
        window.apriTab = apriTab;
        window.tornaHome = tornaHome;
        window.tornaMenu = tornaMenu;
        window.logoutAdmin = logoutAdmin;
        window.caricaDati = caricaDati;
        window.aggiungiSquadra = aggiungiSquadra;
        window.aggiungiGiocatore = aggiungiGiocatore;
        window.caricaGiocatoriPartita = caricaGiocatoriPartita;
        window.aggiornaNomePortiere = aggiornaNomePortiere;
        window.modificaEvento = modificaEvento;
        window.cancellaEventi = cancellaEventi;
        window.salvaPartita = salvaPartita;
        window.caricaPartiteSalvate = caricaPartiteSalvate;
        window.eliminaPartita = eliminaPartita;
        window.eliminaPartitaSelezionata = eliminaPartitaSelezionata;
        window.mostraOpzioniElimina = mostraOpzioniElimina;
        window.eseguiEliminazione = eseguiEliminazione;
        window.caricaFinaleEsistente = caricaFinaleEsistente;
        window.eliminaFinale = eliminaFinale;
        window.eliminaTuttePartite = eliminaTuttePartite;
        window.resetStatisticheGiocatori = resetStatisticheGiocatori;
        window.resetClassificaSquadre = resetClassificaSquadre;
        window.eliminaTuttoDatabase = eliminaTuttoDatabase;
        window.esportaBackup = esportaBackup;
        window.importaBackup = importaBackup;
        
    </script>
</body>
</html>

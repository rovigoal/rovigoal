<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rovigoal - Area Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #f0f2f5; padding: 20px; }
        
        .btn-home {
            position: fixed; top: 20px; right: 20px; background: #1e3c72; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .btn-home:hover { background: #2a5298; }
        
        .header {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%); color: white; padding: 20px;
            border-radius: 10px; margin-bottom: 30px; text-align: center; position: relative;
        }
        
        .menu-admin {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
            max-width: 1000px; margin: 0 auto 40px;
        }
        
        .menu-btn {
            background: white; padding: 60px 20px; border-radius: 15px; text-align: center; font-size: 1.5em;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease; border: 3px solid transparent;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .menu-btn:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .menu-btn:nth-child(1) { background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%); color: white; }
        .menu-btn:nth-child(2) { background: linear-gradient(135deg, #32CD32 0%, #228B22 100%); color: white; }
        .menu-btn:nth-child(3) { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #333; }
        .menu-btn:nth-child(4) { background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%); color: white; }
        .icona { font-size: 3em; display: block; margin-bottom: 15px; }
        
        .sezione {
            background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px; display: none; max-width: 1200px; margin: 0 auto 30px;
        }
        .sezione.attiva { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 { color: #333; margin-bottom: 20px; border-bottom: 2px solid #FF4500; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        input:focus, select:focus { outline: none; border-color: #FF4500; box-shadow: 0 0 0 2px rgba(255, 69, 0, 0.2); }
        
        .btn {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%); color: white; border: none;
            padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
            margin-top: 10px; transition: all 0.3s ease; display: inline-block;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 69, 0, 0.3); }
        .btn-full { width: 100%; }
        .btn-back { background: #1e3c72; margin: 20px auto; display: block; padding: 12px 30px; }
        .btn-green { background: linear-gradient(135deg, #32CD32 0%, #228B22 100%); }
        .btn-blue { background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%); }
        .btn-red { background: linear-gradient(135deg, #FF0000 0%, #DC143C 100%); }
        .btn-yellow { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #333; }
        .btn-gold { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #333; font-weight: bold; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        
        .giocatori-partita { border: 2px solid #ddd; padding: 15px; border-radius: 8px; margin-top: 15px; background: #f9f9f9; }
        .giocatore-item { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px; background: white; }
        .giocatore-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .contatore-row { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
        .contatore-label { font-weight: bold; min-width: 120px; }
        .contatore-btn { 
            width: 35px; height: 35px; border-radius: 50%; border: none; 
            font-weight: bold; font-size: 18px; cursor: pointer; transition: all 0.2s;
        }
        .contatore-btn:hover { transform: scale(1.1); }
        .contatore-valore { 
            min-width: 40px; text-align: center; font-weight: bold; 
            font-size: 1.2em; padding: 5px 10px; background: #f8f9fa; border-radius: 5px;
        }
        .btn-gol { background: #32CD32; color: white; }
        .btn-amm { background: #FFD700; color: #333; }
        .btn-esp { background: #DC143C; color: white; }
        
        .eventi-salvati { margin-top: 20px; padding: 15px; background: #e8f4ff; border-radius: 8px; border: 1px solid #b3d9ff; }
        .evento-item { padding: 8px; border-bottom: 1px solid #cce0ff; }
        .evento-item:last-child { border-bottom: none; }
        
        .selezione-migliori { 
            margin-top: 20px; padding: 20px; 
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%); 
            border-radius: 10px; border: 2px solid #4dabf7; 
        }
        .migliori-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        @media (max-width: 768px) { .migliori-row { grid-template-columns: 1fr; } }
        
        .voto-container { margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd; }
        .voto-stelle { display: flex; gap: 5px; margin-top: 5px; }
        .stella { font-size: 24px; cursor: pointer; color: #ddd; transition: color 0.2s; }
        .stella:hover { transform: scale(1.2); }
        .stella.selezionata { color: #FFD700; }
        
        .hidden { display: none !important; }
        .avviso { 
            background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; 
            border-radius: 5px; margin-top: 10px; font-size: 0.9em;
        }
        .avviso.errore { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .avviso.successo { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        
        .gestione-partite { margin-top: 30px; }
        .partita-item { 
            background: white; padding: 20px; border-radius: 8px; 
            margin-bottom: 15px; border: 1px solid #ddd; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .partita-item:hover { transform: translateY(-2px); }
        .partita-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .btn-elimina { 
            background: #ff6666; color: white; border: none; 
            padding: 8px 15px; border-radius: 5px; cursor: pointer; 
            font-weight: bold; margin-top: 10px;
        }
        .btn-elimina:hover { background: #ff3333; }
        
        .selezione-obbligatoria {
            border: 2px solid #ff6b6b !important;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: #ff6b6b; }
            50% { border-color: #ff9999; }
            100% { border-color: #ff6b6b; }
        }
        
        .finale-avviso {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: 3px solid #FFD700;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            color: #333;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Stile per sezione portieri */
        .portieri-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        @media (max-width: 768px) { .portieri-row { grid-template-columns: 1fr; } }
        
        .portiere-section {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #87CEEB;
        }
        
        /* Stato connessione */
        .connessione-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .connessione-ok {
            background: #4CAF50;
            color: white;
            border: 2px solid #45a049;
        }
        
        .connessione-caricamento {
            background: #FFA500;
            color: white;
            border: 2px solid #FF8C00;
        }
        
        .connessione-ko {
            background: #f44336;
            color: white;
            border: 2px solid #d32f2f;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Messaggi */
        .messaggio {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 5px;
            z-index: 9999;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
        
        .messaggio.successo { background: #4CAF50; color: white; }
        .messaggio.errore { background: #f44336; color: white; }
        .messaggio.info { background: #2196F3; color: white; }
        
        /* Media query per mobile */
        @media (max-width: 768px) {
            .menu-admin {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .menu-btn {
                padding: 30px 10px;
                font-size: 1.1em;
            }
            
            .icona {
                font-size: 2em;
                margin-bottom: 10px;
            }
            
            .btn-home {
                top: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 0.9em;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .sezione {
                padding: 15px;
            }
            
            .portieri-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .menu-admin {
                grid-template-columns: 1fr;
            }
            
            .menu-btn {
                padding: 25px 10px;
                font-size: 1em;
            }
            
            .icona {
                font-size: 1.8em;
            }
            
            .connessione-status {
                bottom: 5px;
                left: 5px;
                padding: 6px 10px;
                font-size: 0.8em;
            }
        }
        
        /* Scrollbar personalizzata */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #FF4500;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #DC143C;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8em;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <button class="btn-home" onclick="tornaHome()">üè† HOME</button>
    
    <div class="header">
        <h1>üîß AREA ADMIN ROVIGOAL</h1>
        <p>Gestione completa del torneo</p>
        <div id="connessioneStatus" class="connessione-status connessione-caricamento">
            <div class="loading"></div> Connessione...
        </div>
    </div>
    
    <!-- MENU PRINCIPALE -->
    <div class="menu-admin" id="menuPrincipale">
        <div class="menu-btn" onclick="mostraSezione('gestione')"><span class="icona">üë•</span>GESTIONE SQUADRE & GIOCATORI</div>
        <div class="menu-btn" onclick="mostraSezione('partite')"><span class="icona">‚öΩ</span>GESTIONE PARTITE</div>
        <div class="menu-btn" onclick="mostraSezione('finale')"><span class="icona">üèÜ</span>GESTIONE FINALE</div>
        <div class="menu-btn" onclick="mostraSezione('gestionePartite')"><span class="icona">üìã</span>GESTISCI PARTITE SALVATE</div>
    </div>
    
    <!-- SEZIONE 1: GESTIONE SQUADRE E GIOCATORI -->
    <div id="gestione" class="sezione">
        <h2>üë• GESTIONE SQUADRE & GIOCATORI</h2>
        
        <div class="form-group">
            <h3>‚ûï AGGIUNGI SQUADRA</h3>
            <input type="text" id="nomeSquadra" placeholder="Nome Squadra (Es: Rovigo FC)" maxlength="50">
            <input type="text" id="allenatore" placeholder="Allenatore" maxlength="50">
            <input type="text" id="colori" placeholder="Colori (Es: Rosso-Blu)" maxlength="30">
            <button class="btn btn-green btn-full" onclick="aggiungiSquadra()" id="btnAggiungiSquadra">
                AGGIUNGI SQUADRA
            </button>
        </div>
        
        <div class="form-group">
            <h3>üë§ AGGIUNGI GIOCATORE</h3>
            <select id="squadraGiocatore">
                <option value="">Seleziona Squadra</option>
            </select>
            <input type="text" id="nomeGiocatore" placeholder="Nome e Cognome" maxlength="50">
            <input type="number" id="numeroMaglia" placeholder="Numero Maglia" min="1" max="99">
            <select id="ruolo">
                <option value="Portiere">Portiere</option>
                <option value="Giocatore" selected>Giocatore</option>
            </select>
            <button class="btn btn-blue btn-full" onclick="aggiungiGiocatore()" id="btnAggiungiGiocatore">
                AGGIUNGI GIOCATORE
            </button>
        </div>
        
        <div class="form-group">
            <h3>üóëÔ∏è ELIMINA DATI</h3>
            <select id="tipoElimina" onchange="mostraOpzioniElimina()">
                <option value="">Cosa vuoi eliminare?</option>
                <option value="giocatore">Elimina Giocatore</option>
                <option value="squadra">Elimina Squadra</option>
                <option value="tutto">Elimina TUTTO (Reset Database)</option>
            </select>
            <div id="opzioniElimina" class="hidden"></div>
            <button class="btn btn-red btn-full hidden" id="btnElimina" onclick="eseguiEliminazione()">
                CONFERMA ELIMINAZIONE
            </button>
            <div class="avviso errore hidden" id="avvisoEliminazione">
                ‚ö†Ô∏è ATTENZIONE: Questa azione √® irreversibile!
            </div>
        </div>
        
        <div class="form-group">
            <h3>üìä STATISTICHE DATABASE</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                <div style="background: #e8f4ff; padding: 10px; border-radius: 5px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #1e3c72;" id="statSquadre">0</div>
                    <div style="font-size: 0.8em; color: #666;">Squadre</div>
                </div>
                <div style="background: #e8f4ff; padding: 10px; border-radius: 5px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #1e3c72;" id="statGiocatori">0</div>
                    <div style="font-size: 0.8em; color: #666;">Giocatori</div>
                </div>
            </div>
        </div>
        
        <button class="btn btn-back" onclick="tornaMenu()">‚Üê TORNA AL MENU</button>
    </div>
    
    <!-- SEZIONE 2: GESTIONE PARTITE -->
    <div id="partite" class="sezione">
        <h2>‚öΩ GESTIONE PARTITE</h2>
        
        <div class="form-group">
            <h3>üèüÔ∏è SELEZIONA PARTITA</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label>Squadra Casa:</label>
                    <select id="squadraCasa" onchange="caricaGiocatoriPartita('normale')">
                        <option value="">Seleziona Squadra Casa</option>
                    </select>
                </div>
                <div>
                    <label>Squadra Ospite:</label>
                    <select id="squadraOspite" onchange="caricaGiocatoriPartita('normale')">
                        <option value="">Seleziona Squadra Ospite</option>
                    </select>
                </div>
            </div>
            <div class="avviso" id="avvisoSquadreUguali" style="display: none;">
                ‚ö†Ô∏è Non puoi selezionare la stessa squadra per casa e ospite!
            </div>
        </div>
        
        <div class="form-group">
            <h3>üìä RISULTATO PARTITA</h3>
            <div style="display: flex; gap: 20px; align-items: center; justify-content: center;">
                <div style="flex: 1; text-align: center;">
                    <div id="nomeSquadraCasa" style="font-weight: bold; margin-bottom: 5px;">-</div>
                    <input type="number" id="golCasa" min="0" value="0" style="font-size: 24px; text-align: center; width: 80px;">
                </div>
                <div style="font-size: 24px; font-weight: bold; color: #333;">-</div>
                <div style="flex: 1; text-align: center;">
                    <div id="nomeSquadraOspite" style="font-weight: bold; margin-bottom: 5px;">-</div>
                    <input type="number" id="golOspite" min="0" value="0" style="font-size: 24px; text-align: center; width: 80px;">
                </div>
            </div>
        </div>
        
        <div id="giocatoriCasaContainer" class="hidden">
            <h3>üë• GIOCATORI CASA: <span id="nomeSquadraCasaLabel">-</span></h3>
            <div id="giocatoriCasa" class="giocatori-partita"></div>
        </div>
        
        <div id="giocatoriOspiteContainer" class="hidden">
            <h3>üë• GIOCATORI OSPITE: <span id="nomeSquadraOspiteLabel">-</span></h3>
            <div id="giocatoriOspite" class="giocatori-partita"></div>
        </div>
        
        <div id="selezioneMiglioriContainer" class="selezione-migliori hidden">
            <h3>üèÜ SELEZIONA I MIGLIORI</h3>
            <div class="avviso">
                <strong>IMPORTANTE:</strong> Seleziona 1 miglior giocatore (campo) e vota entrambi i portieri
            </div>
            <div class="migliori-row">
                <div>
                    <label>Miglior Giocatore (campo):</label>
                    <select id="migliorGiocatore">
                        <option value="">-- Seleziona miglior giocatore --</option>
                    </select>
                    <div class="voto-container">
                        <label>Voto (1-10):</label>
                        <div class="voto-stelle" id="voto-miglior-giocatore"></div>
                        <span>Voto selezionato: <span id="voto-miglior-giocatore-attuale" style="font-weight: bold;">0</span>/10</span>
                    </div>
                </div>
            </div>
            
            <!-- SEZIONE VOTI PORTIERI -->
            <div class="portieri-row">
                <div class="portiere-section">
                    <label>Portiere Casa:</label>
                    <select id="portiereCasa" onchange="aggiornaNomePortiere('casa')">
                        <option value="">-- Seleziona Portiere Casa --</option>
                    </select>
                    <div class="voto-container">
                        <label>Voto Portiere Casa (1-10):</label>
                        <div class="voto-stelle" id="voto-portiere-casa"></div>
                        <span>Voto: <span id="voto-portiere-casa-attuale" style="font-weight: bold;">0</span>/10</span>
                        <div><small id="nome-portiere-casa">Nessun portiere selezionato</small></div>
                    </div>
                </div>
                
                <div class="portiere-section">
                    <label>Portiere Ospite:</label>
                    <select id="portiereOspite" onchange="aggiornaNomePortiere('ospite')">
                        <option value="">-- Seleziona Portiere Ospite --</option>
                    </select>
                    <div class="voto-container">
                        <label>Voto Portiere Ospite (1-10):</label>
                        <div class="voto-stelle" id="voto-portiere-ospite"></div>
                        <span>Voto: <span id="voto-portiere-ospite-attuale" style="font-weight: bold;">0</span>/10</span>
                        <div><small id="nome-portiere-ospite">Nessun portiere selezionato</small></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="eventiSalvatiContainer" class="hidden">
            <h3>üìù RIEPILOGO EVENTI</h3>
            <div id="eventiSalvati" class="eventi-salvati">Nessun evento registrato</div>
            <div class="avviso" id="avvisoGol">
                ‚ö†Ô∏è Controlla che i gol assegnati ai giocatori corrispondano al risultato della partita
            </div>
            <div class="avviso successo hidden" id="avvisoGolCorretto">
                ‚úì I gol assegnati corrispondono al risultato!
            </div>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-yellow" onclick="cancellaEventi('normale')" id="btnCancellaEventi">
                üóëÔ∏è CANCELLA EVENTI
            </button>
            <button class="btn btn-green" onclick="salvaPartita('normale')" id="btnSalvaPartita" disabled>
                üíæ SALVA PARTITA
            </button>
            <button class="btn" onclick="generaPartitaCasuale()" id="btnGeneraCasuale">
                üé≤ GENERA PARTITA CASUALE (test)
            </button>
        </div>
        
        <button class="btn btn-back" onclick="tornaMenu()">‚Üê TORNA AL MENU</button>
    </div>
    
    <!-- SEZIONE 3: GESTIONE FINALE -->
    <div id="finale" class="sezione">
        <h2>üèÜ GESTIONE PARTITA FINALE</h2>
        
        <div class="finale-avviso">
            ‚ö†Ô∏è ATTENZIONE: Questa partita sar√† visibile nella sezione "FINALE" della pagina principale
        </div>
        
        <div class="form-group">
            <h3>üèüÔ∏è SELEZIONA FINALISTE</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label>Finalista 1:</label>
                    <select id="finaleSquadraCasa" onchange="caricaGiocatoriPartita('finale')">
                        <option value="">Seleziona Finalista 1</option>
                    </select>
                </div>
                <div>
                    <label>Finalista 2:</label>
                    <select id="finaleSquadraOspite" onchange="caricaGiocatoriPartita('finale')">
                        <option value="">Seleziona Finalista 2</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <h3>üìä RISULTATO FINALE</h3>
            <div style="display: flex; gap: 20px; align-items: center; justify-content: center;">
                <div style="flex: 1; text-align: center;">
                    <div id="finaleNomeSquadraCasa" style="font-weight: bold; margin-bottom: 5px;">-</div>
                    <input type="number" id="finaleGolCasa" min="0" value="0" style="font-size: 24px; text-align: center; width: 80px;">
                </div>
                <div style="font-size: 24px; font-weight: bold; color: #333;">-</div>
                <div style="flex: 1; text-align: center;">
                    <div id="finaleNomeSquadraOspite" style="font-weight: bold; margin-bottom: 5px;">-</div>
                    <input type="number" id="finaleGolOspite" min="0" value="0" style="font-size: 24px; text-align: center; width: 80px;">
                </div>
            </div>
        </div>
        
        <div id="finaleGiocatoriCasaContainer" class="hidden">
            <h3>üë• FINALISTA 1: <span id="finaleNomeSquadraCasaLabel">-</span></h3>
            <div id="finaleGiocatoriCasa" class="giocatori-partita"></div>
        </div>
        
        <div id="finaleGiocatoriOspiteContainer" class="hidden">
            <h3>üë• FINALISTA 2: <span id="finaleNomeSquadraOspiteLabel">-</span></h3>
            <div id="finaleGiocatoriOspite" class="giocatori-partita"></div>
        </div>
        
        <div id="finaleSelezioneMiglioriContainer" class="selezione-migliori hidden">
            <h3>üèÜ SELEZIONA I MIGLIORI DELLA FINALE</h3>
            <div class="avviso" style="background: gold; border-color: orange; color: #333;">
                <strong>SPECIALE FINALE:</strong> I premi di questa partita saranno evidenziati nella sezione finale
            </div>
            <div class="migliori-row">
                <div>
                    <label>Miglior Giocatore (campo):</label>
                    <select id="finaleMigliorGiocatore">
                        <option value="">-- Seleziona miglior giocatore finale --</option>
                    </select>
                    <div class="voto-container">
                        <label>Voto (1-10):</label>
                        <div class="voto-stelle" id="finale-voto-miglior-giocatore"></div>
                        <span>Voto: <span id="finale-voto-miglior-giocatore-attuale" style="font-weight: bold;">0</span>/10</span>
                    </div>
                </div>
            </div>
            
            <!-- SEZIONE VOTI PORTIERI FINALE -->
            <div class="portieri-row">
                <div class="portiere-section">
                    <label>Portiere Finalista 1:</label>
                    <select id="finalePortiereCasa" onchange="aggiornaNomePortiere('finale-casa')">
                        <option value="">-- Seleziona Portiere Finalista 1 --</option>
                    </select>
                    <div class="voto-container">
                        <label>Voto Portiere (1-10):</label>
                        <div class="voto-stelle" id="finale-voto-portiere-casa"></div>
                        <span>Voto: <span id="finale-voto-portiere-casa-attuale" style="font-weight: bold;">0</span>/10</span>
                        <div><small id="finale-nome-portiere-casa">Nessun portiere selezionato</small></div>
                    </div>
                </div>
                
                <div class="portiere-section">
                    <label>Portiere Finalista 2:</label>
                    <select id="finalePortiereOspite" onchange="aggiornaNomePortiere('finale-ospite')">
                        <option value="">-- Seleziona Portiere Finalista 2 --</option>
                    </select>
                    <div class="voto-container">
                        <label>Voto Portiere (1-10):</label>
                        <div class="voto-stelle" id="finale-voto-portiere-ospite"></div>
                        <span>Voto: <span id="finale-voto-portiere-ospite-attuale" style="font-weight: bold;">0</span>/10</span>
                        <div><small id="finale-nome-portiere-ospite">Nessun portiere selezionato</small></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="finaleEventiSalvatiContainer" class="hidden">
            <h3>üìù RIEPILOGO EVENTI FINALE</h3>
            <div id="finaleEventiSalvati" class="eventi-salvati">Nessun evento registrato</div>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-yellow" onclick="cancellaEventi('finale')" id="btnCancellaEventiFinale">
                üóëÔ∏è CANCELLA EVENTI FINALE
            </button>
            <button class="btn btn-gold" onclick="salvaPartita('finale')" id="btnSalvaFinale" disabled>
                üèÜ SALVA PARTITA FINALE
            </button>
        </div>
        
        <div class="form-group" style="margin-top: 30px;">
            <h3>‚ö†Ô∏è ELIMINA FINALE</h3>
            <button class="btn btn-red btn-full" onclick="eliminaFinale()" id="btnEliminaFinale">
                üóëÔ∏è ELIMINA PARTITA FINALE
            </button>
            <div class="avviso errore">
                ‚ö†Ô∏è ATTENZIONE: Eliminando la finale, la sezione finale del sito risulter√† vuota
            </div>
        </div>
        
        <button class="btn btn-back" onclick="tornaMenu()">‚Üê TORNA AL MENU</button>
    </div>
    
    <!-- SEZIONE 4: GESTIONE PARTITE SALVATE -->
    <div id="gestionePartite" class="sezione">
        <h2>üìã GESTIONE PARTITE SALVATE</h2>
        
        <div class="form-group">
            <h3>üîç RICERCA E FILTRI</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="filtroRicerca" placeholder="Cerca per squadra..." style="flex: 1;">
                <select id="filtroTipo">
                    <option value="">Tutte le partite</option>
                    <option value="normale">Partite Normali</option>
                    <option value="finale">Partita Finale</option>
                </select>
                <button class="btn btn-blue" onclick="caricaPartiteSalvate()">üîç CERCA</button>
            </div>
        </div>
        
        <div id="listaPartiteContainer">
            <div class="avviso" id="nessunaPartita">
                üì≠ Nessuna partita salvata. Vai in "Gestione Partite" per aggiungere la prima partita.
            </div>
            <div id="listaPartite" class="gestione-partite"></div>
        </div>
        
        <div class="form-group" style="margin-top: 30px;">
            <h3>‚ö†Ô∏è OPERAZIONI BATCH</h3>
            <button class="btn btn-red" onclick="eliminaTuttePartite()" id="btnEliminaTutto">
                üóëÔ∏è ELIMINA TUTTE LE PARTITE (Normali)
            </button>
            <div class="avviso errore">
                ‚ö†Ô∏è ATTENZIONE: Questa operazione eliminer√† TUTTE le partite normali (non la finale)
            </div>
        </div>
        
        <button class="btn btn-back" onclick="tornaMenu()">‚Üê TORNA AL MENU</button>
    </div>

    <script type="module">
        // Importa il gestore database Supabase
        import database from './database-supabase.js';
        
        // VARIABILI GLOBALI
        let datiTorneo = {
            squadre: [],
            giocatori: [],
            partite: [],
            finale: null
        };
        
        let eventiPartitaNormale = [];
        let eventiPartitaFinale = [];
        let partitaCorrente = null;
        let finaleCorrente = null;
        
        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîÑ Inizializzazione Area Admin...');
            aggiornaStatoConnessione('caricamento');
            
            try {
                // Controlla accesso admin
                if (!controllaAccessoAdmin()) {
                    window.location.href = 'main.html';
                    return;
                }
                
                // Carica dati iniziali
                await caricaDatiIniziali();
                
                // Setup interfaccia
                inizializzaInterfaccia();
                
                // Setup listener in tempo reale
                setupRealtimeListeners();
                
                aggiornaStatoConnessione('ok');
                mostraMessaggio('‚úÖ Admin connesso con successo', 'successo');
                
            } catch (error) {
                console.error('‚ùå Errore inizializzazione admin:', error);
                aggiornaStatoConnessione('ko');
                mostraMessaggio('‚ùå Errore di connessione al database', 'errore');
            }
        });
        
        // CONTROLLO ACCESSO ADMIN
        function controllaAccessoAdmin() {
            const passwordSalvata = sessionStorage.getItem('admin_accesso');
            if (passwordSalvata !== 'true') {
                const password = prompt("üîí Inserisci la password ADMIN:");
                if (password === "1246912.!!") {
                    sessionStorage.setItem('admin_accesso', 'true');
                    return true;
                } else {
                    alert("‚ùå Password errata! Accesso negato.");
                    return false;
                }
            }
            return true;
        }
        
        // CARICA DATI INIZIALI
        async function caricaDatiIniziali() {
            try {
                console.log('üì• Caricamento dati iniziali...');
                
                // Carica tutti i dati in parallelo
                const [squadre, giocatori, partite, finale] = await Promise.all([
                    database.getSquadre(),
                    database.getGiocatori(),
                    database.getPartite(),
                    database.getFinale()
                ]);
                
                datiTorneo.squadre = squadre || [];
                datiTorneo.giocatori = giocatori || [];
                datiTorneo.partite = partite || [];
                datiTorneo.finale = finale || null;
                
                console.log('‚úÖ Dati caricati:', {
                    squadre: datiTorneo.squadre.length,
                    giocatori: datiTorneo.giocatori.length,
                    partite: datiTorneo.partite.length,
                    finale: !!datiTorneo.finale
                });
                
            } catch (error) {
                console.error('‚ùå Errore caricamento dati:', error);
                throw error;
            }
        }
        
        // SETUP LISTENER TEMPO REALE
        function setupRealtimeListeners() {
            // Ascolta aggiornamenti dal database Supabase
            window.onDatabaseUpdate = function(type, data) {
                console.log(`üîÑ Aggiornamento in tempo reale: ${type}`);
                
                // Aggiorna i dati locali
                if (type === 'squadre') {
                    datiTorneo.squadre = data || [];
                    aggiornaDropdownSquadre();
                    aggiornaStatistiche();
                } else if (type === 'giocatori') {
                    datiTorneo.giocatori = data || [];
                    aggiornaDropdownSquadre();
                    aggiornaStatistiche();
                } else if (type === 'partite') {
                    datiTorneo.partite = data || [];
                } else if (type === 'finale') {
                    datiTorneo.finale = data || null;
                }
                
                // Aggiorna stato connessione
                aggiornaStatoConnessione('ok');
            };
        }
        
        // INIZIALIZZA INTERFACCIA
        function inizializzaInterfaccia() {
            // Popola dropdown squadre
            aggiornaDropdownSquadre();
            
            // Inizializza stelle voti
            inizializzaStelleVoto('normale');
            inizializzaStelleVoto('finale');
            
            // Carica statistiche
            aggiornaStatistiche();
            
            // Carica partite salvate se nella sezione corretta
            if (document.getElementById('gestionePartite').classList.contains('attiva')) {
                caricaPartiteSalvate();
            }
            
            // Aggiorna nomi squadre
            aggiornaNomiSquadre();
        }
        
        // AGGIORNA DROPDOWN SQUADRE
        function aggiornaDropdownSquadre() {
            const dropdowns = [
                'squadraGiocatore', 'squadraCasa', 'squadraOspite',
                'finaleSquadraCasa', 'finaleSquadraOspite'
            ];
            
            dropdowns.forEach(dropdownId => {
                const select = document.getElementById(dropdownId);
                if (!select) return;
                
                // Salva valore selezionato
                const valoreSalvato = select.value;
                
                // Pulisci opzioni
                select.innerHTML = '<option value="">Seleziona Squadra</option>';
                
                // Ordina squadre alfabeticamente
                const squadreOrdinate = [...datiTorneo.squadre].sort((a, b) => 
                    a.nome.localeCompare(b.nome)
                );
                
                // Aggiungi opzioni
                squadreOrdinate.forEach(squadra => {
                    const option = document.createElement('option');
                    option.value = squadra.nome;
                    option.textContent = squadra.nome;
                    select.appendChild(option);
                });
                
                // Ripristina valore selezionato se ancora valido
                if (valoreSalvato && squadreOrdinate.some(s => s.nome === valoreSalvato)) {
                    select.value = valoreSalvato;
                }
            });
        }
        
        // AGGIORNA NOMI SQUADRE NELLE LABEL
        function aggiornaNomiSquadre() {
            const squadraCasa = document.getElementById('squadraCasa').value;
            const squadraOspite = document.getElementById('squadraOspite').value;
            const finaleCasa = document.getElementById('finaleSquadraCasa').value;
            const finaleOspite = document.getElementById('finaleSquadraOspite').value;
            
            document.getElementById('nomeSquadraCasa').textContent = squadraCasa || '-';
            document.getElementById('nomeSquadraOspite').textContent = squadraOspite || '-';
            document.getElementById('finaleNomeSquadraCasa').textContent = finaleCasa || '-';
            document.getElementById('finaleNomeSquadraOspite').textContent = finaleOspite || '-';
            
            document.getElementById('nomeSquadraCasaLabel').textContent = squadraCasa || '-';
            document.getElementById('nomeSquadraOspiteLabel').textContent = squadraOspite || '-';
            document.getElementById('finaleNomeSquadraCasaLabel').textContent = finaleCasa || '-';
            document.getElementById('finaleNomeSquadraOspiteLabel').textContent = finaleOspite || '-';
        }
        
        // AGGIORNA STATISTICHE
        function aggiornaStatistiche() {
            document.getElementById('statSquadre').textContent = datiTorneo.squadre.length;
            document.getElementById('statGiocatori').textContent = datiTorneo.giocatori.length;
        }
        
        // INIZIALIZZA STELLE VOTO
        function inizializzaStelleVoto(tipo) {
            const prefisso = tipo === 'finale' ? 'finale-' : '';
            const container = document.getElementById(`${prefisso}voto-miglior-giocatore`);
            const containerCasa = document.getElementById(`${prefisso}voto-portiere-casa`);
            const containerOspite = document.getElementById(`${prefisso}voto-portiere-ospite`);
            
            [container, containerCasa, containerOspite].forEach(cont => {
                if (!cont) return;
                cont.innerHTML = '';
                for (let i = 1; i <= 10; i++) {
                    const stella = document.createElement('span');
                    stella.className = 'stella';
                    stella.textContent = '‚òÖ';
                    stella.dataset.voto = i;
                    stella.onclick = function() {
                        selezionaVoto(this, tipo);
                    };
                    cont.appendChild(stella);
                }
            });
        }
        
        // SELEZIONA VOTO CON STELLE
        function selezionaVoto(stella, tipo) {
            const prefisso = tipo === 'finale' ? 'finale-' : '';
            const container = stella.parentElement;
            const voto = parseInt(stella.dataset.voto);
            const idContainer = container.id;
            
            // Determina quale voto aggiornare
            let elementoVoto;
            if (idContainer.includes('miglior-giocatore')) {
                elementoVoto = document.getElementById(`${prefisso}voto-miglior-giocatore-attuale`);
            } else if (idContainer.includes('portiere-casa')) {
                elementoVoto = document.getElementById(`${prefisso}voto-portiere-casa-attuale`);
            } else if (idContainer.includes('portiere-ospite')) {
                elementoVoto = document.getElementById(`${prefisso}voto-portiere-ospite-attuale`);
            }
            
            if (elementoVoto) {
                elementoVoto.textContent = voto;
            }
            
            // Aggiorna stelle
            const stelle = container.querySelectorAll('.stella');
            stelle.forEach((s, index) => {
                if (index < voto) {
                    s.classList.add('selezionata');
                } else {
                    s.classList.remove('selezionata');
                }
            });
        }
        
        // FUNZIONI DI NAVIGAZIONE
        function mostraSezione(sezioneId) {
            // Nascondi tutte le sezioni
            document.querySelectorAll('.sezione').forEach(sezione => {
                sezione.classList.remove('attiva');
            });
            
            // Nascondi menu principale
            document.getElementById('menuPrincipale').style.display = 'none';
            
            // Mostra sezione selezionata
            const sezione = document.getElementById(sezioneId);
            sezione.classList.add('attiva');
            
            // Azioni specifiche per sezione
            if (sezioneId === 'gestionePartite') {
                caricaPartiteSalvate();
            } else if (sezioneId === 'finale' && datiTorneo.finale) {
                caricaFinaleEsistente();
            }
            
            // Scroll in alto
            window.scrollTo(0, 0);
        }
        
        function tornaMenu() {
            // Nascondi tutte le sezioni
            document.querySelectorAll('.sezione').forEach(sezione => {
                sezione.classList.remove('attiva');
            });
            
            // Mostra menu principale
            document.getElementById('menuPrincipale').style.display = 'grid';
            
            // Reset form partita
            resetFormPartita('normale');
            resetFormPartita('finale');
            
            // Scroll in alto
            window.scrollTo(0, 0);
        }
        
        function tornaHome() {
            if (confirm('Tornare alla home? Le modifiche non salvate andranno perse.')) {
                window.location.href = 'main.html';
            }
        }
        
        // RESET FORM PARTITA
        function resetFormPartita(tipo) {
            const prefisso = tipo === 'finale' ? 'finale' : '';
            const eventi = tipo === 'finale' ? eventiPartitaFinale : eventiPartitaNormale;
            
            // Reset valori
            if (prefisso) {
                document.getElementById(`${prefisso}SquadraCasa`).value = '';
                document.getElementById(`${prefisso}SquadraOspite`).value = '';
                document.getElementById(`${prefisso}GolCasa`).value = '0';
                document.getElementById(`${prefisso}GolOspite`).value = '0';
                document.getElementById(`${prefisso}MigliorGiocatore`).value = '';
            } else {
                document.getElementById('squadraCasa').value = '';
                document.getElementById('squadraOspite').value = '';
                document.getElementById('golCasa').value = '0';
                document.getElementById('golOspite').value = '0';
                document.getElementById('migliorGiocatore').value = '';
                document.getElementById('portiereCasa').value = '';
                document.getElementById('portiereOspite').value = '';
            }
            
            // Reset eventi
            eventi.length = 0;
            
            // Nascondi sezioni
            document.getElementById(`${prefisso ? 'finale' : ''}GiocatoriCasaContainer`).classList.add('hidden');
            document.getElementById(`${prefisso ? 'finale' : ''}GiocatoriOspiteContainer`).classList.add('hidden');
            document.getElementById(`${prefisso ? 'finale' : ''}SelezioneMiglioriContainer`).classList.add('hidden');
            document.getElementById(`${prefisso ? 'finale' : ''}EventiSalvatiContainer`).classList.add('hidden');
            
            // Reset stelle voti
            inizializzaStelleVoto(tipo);
            
            // Aggiorna nomi
            aggiornaNomiSquadre();
        }
        
        // CARICA GIOCATORI PER PARTITA
        function caricaGiocatoriPartita(tipo) {
            const prefisso = tipo === 'finale' ? 'finale' : '';
            const squadraCasaId = `${prefisso}SquadraCasa`;
            const squadraOspiteId = `${prefisso}SquadraOspite`;
            
            const squadraCasa = document.getElementById(squadraCasaId).value;
            const squadraOspite = document.getElementById(squadraOspiteId).value;
            
            // Controlla se squadre sono uguali
            if (squadraCasa && squadraOspite && squadraCasa === squadraOspite) {
                document.getElementById('avvisoSquadreUguali').style.display = 'block';
                document.getElementById(squadraOspiteId).value = '';
                return;
            } else {
                document.getElementById('avvisoSquadreUguali').style.display = 'none';
            }
            
            // Aggiorna nomi squadre
            aggiornaNomiSquadre();
            
            // Se entrambe le squadre sono selezionate, mostra giocatori
            if (squadraCasa && squadraOspite) {
                caricaListaGiocatori(squadraCasa, `${prefisso}GiocatoriCasa`, tipo);
                caricaListaGiocatori(squadraOspite, `${prefisso}GiocatoriOspite`, tipo);
                
                // Mostra container giocatori
                document.getElementById(`${prefisso}GiocatoriCasaContainer`).classList.remove('hidden');
                document.getElementById(`${prefisso}GiocatoriOspiteContainer`).classList.remove('hidden');
                
                // Popola dropdown miglior giocatore e portieri
                popolaDropdownMigliori(squadraCasa, squadraOspite, tipo);
                
                // Mostra sezione migliori
                document.getElementById(`${prefisso}SelezioneMiglioriContainer`).classList.remove('hidden');
            } else {
                // Nascondi container se non entrambe le squadre
                document.getElementById(`${prefisso}GiocatoriCasaContainer`).classList.add('hidden');
                document.getElementById(`${prefisso}GiocatoriOspiteContainer`).classList.add('hidden');
                document.getElementById(`${prefisso}SelezioneMiglioriContainer`).classList.add('hidden');
            }
        }
        
        // CARICA LISTA GIOCATORI
        function caricaListaGiocatori(nomeSquadra, containerId, tipo) {
            const container = document.getElementById(containerId);
            const giocatoriSquadra = datiTorneo.giocatori.filter(g => g.squadra === nomeSquadra);
            
            if (giocatoriSquadra.length === 0) {
                container.innerHTML = '<div class="avviso">Nessun giocatore registrato per questa squadra</div>';
                return;
            }
            
            // Ordina giocatori: portieri prima, poi per numero
            giocatoriSquadra.sort((a, b) => {
                if (a.ruolo === 'Portiere' && b.ruolo !== 'Portiere') return -1;
                if (a.ruolo !== 'Portiere' && b.ruolo === 'Portiere') return 1;
                return (a.numero || 99) - (b.numero || 99);
            });
            
            let html = '';
            giocatoriSquadra.forEach(giocatore => {
                html += `
                    <div class="giocatore-item" data-id="${giocatore.id}" data-squadra="${nomeSquadra}">
                        <div class="giocatore-header">
                            <div>
                                <strong>${giocatore.nome}</strong>
                                ${giocatore.numero ? `<span style="color: #666; margin-left: 10px;">#${giocatore.numero}</span>` : ''}
                                <span style="color: ${giocatore.ruolo === 'Portiere' ? '#4169E1' : '#32CD32'}; margin-left: 10px;">
                                    ${giocatore.ruolo}
                                </span>
                            </div>
                            <div style="color: #666; font-size: 0.9em;">
                                Gol: ${giocatore.gol || 0} | Ammon: ${giocatore.ammonizioni || 0} | Esp: ${giocatore.espulsioni || 0}
                            </div>
                        </div>
                        <div class="contatore-row">
                            <span class="contatore-label">‚öΩ Gol:</span>
                            <button class="contatore-btn btn-gol" onclick="modificaContatore('${giocatore.id}', 'gol', -1, '${tipo}')">-</button>
                            <span class="contatore-valore" id="gol-${giocatore.id}">0</span>
                            <button class="contatore-btn btn-gol" onclick="modificaContatore('${giocatore.id}', 'gol', 1, '${tipo}')">+</button>
                        </div>
                        <div class="contatore-row">
                            <span class="contatore-label">üü® Ammonizioni:</span>
                            <button class="contatore-btn btn-amm" onclick="modificaContatore('${giocatore.id}', 'amm', -1, '${tipo}')">-</button>
                            <span class="contatore-valore" id="amm-${giocatore.id}">0</span>
                            <button class="contatore-btn btn-amm" onclick="modificaContatore('${giocatore.id}', 'amm', 1, '${tipo}')">+</button>
                        </div>
                        <div class="contatore-row">
                            <span class="contatore-label">üü• Espulsioni:</span>
                            <button class="contatore-btn btn-esp" onclick="modificaContatore('${giocatore.id}', 'esp', -1, '${tipo}')">-</button>
                            <span class="contatore-valore" id="esp-${giocatore.id}">0</span>
                            <button class="contatore-btn btn-esp" onclick="modificaContatore('${giocatore.id}', 'esp', 1, '${tipo}')">+</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // MODIFICA CONTATORE GIOCATORE
        function modificaContatore(giocatoreId, tipo, modifica, partitaTipo) {
            const elemento = document.getElementById(`${tipo}-${giocatoreId}`);
            let valore = parseInt(elemento.textContent) || 0;
            
            // Applica modifica
            valore += modifica;
            
            // Non permettere valori negativi
            if (valore < 0) valore = 0;
            
            // Limiti ragionevoli
            if (tipo === 'gol' && valore > 20) valore = 20;
            if (tipo === 'amm' && valore > 5) valore = 5;
            if (tipo === 'esp' && valore > 2) valore = 2;
            
            // Aggiorna visuale
            elemento.textContent = valore;
            
            // Trova giocatore
            const giocatore = datiTorneo.giocatori.find(g => g.id === giocatoreId);
            if (!giocatore) return;
            
            // Trova evento esistente
            const eventi = partitaTipo === 'finale' ? eventiPartitaFinale : eventiPartitaNormale;
            let evento = eventi.find(e => e.giocatoreId === giocatoreId && e.tipo === tipo);
            
            if (valore === 0) {
                // Rimuovi evento se valore √® 0
                if (evento) {
                    const index = eventi.indexOf(evento);
                    eventi.splice(index, 1);
                }
            } else {
                if (evento) {
                    // Aggiorna evento esistente
                    evento.valore = valore;
                } else {
                    // Crea nuovo evento
                    evento = {
                        giocatoreId: giocatoreId,
                        giocatoreNome: giocatore.nome,
                        squadra: giocatore.squadra,
                        tipo: tipo,
                        valore: valore
                    };
                    eventi.push(evento);
                }
            }
            
            // Aggiorna riepilogo eventi
            aggiornaRiepilogoEventi(partitaTipo);
            
            // Controlla corrispondenza gol
            if (tipo === 'gol') {
                verificaCorrispondenzaGol(partitaTipo);
            }
        }
        
        // AGGIORNA RIEPILOGO EVENTI
        function aggiornaRiepilogoEventi(tipo) {
            const prefisso = tipo === 'finale' ? 'finale' : '';
            const eventi = tipo === 'finale' ? eventiPartitaFinale : eventiPartitaNormale;
            const container = document.getElementById(`${prefisso}EventiSalvati`);
            const containerParent = document.getElementById(`${prefisso}EventiSalvatiContainer`);
            
            if (eventi.length === 0) {
                container.innerHTML = 'Nessun evento registrato';
                containerParent.classList.add('hidden');
                return;
            }
            
            // Mostra container
            containerParent.classList.remove('hidden');
            
            // Raggruppa eventi per squadra
            const eventiPerSquadra = {};
            eventi.forEach(evento => {
                if (!eventiPerSquadra[evento.squadra]) {
                    eventiPerSquadra[evento.squadra] = [];
                }
                eventiPerSquadra[evento.squadra].push(evento);
            });
            
            let html = '';
            for (const squadra in eventiPerSquadra) {
                html += `<div><strong>${squadra}:</strong></div>`;
                eventiPerSquadra[squadra].forEach(evento => {
                    let icona = 'üìù';
                    if (evento.tipo === 'gol') icona = '‚öΩ';
                    else if (evento.tipo === 'amm') icona = 'üü®';
                    else if (evento.tipo === 'esp') icona = 'üü•';
                    
                    html += `<div class="evento-item">${icona} ${evento.giocatoreNome}: ${evento.valore} ${evento.tipo}</div>`;
                });
            }
            
            container.innerHTML = html;
            
            // Controlla corrispondenza gol
            verificaCorrispondenzaGol(tipo);
        }
        
        // VERIFICA CORRISPONDENZA GOL
        function verificaCorrispondenzaGol(tipo) {
            const prefisso = tipo === 'finale' ? 'finale' : '';
            const eventi = tipo === 'finale' ? eventiPartitaFinale : eventiPartitaNormale;
            
            // Calcola gol totali dagli eventi
            const golEventi = eventi
                .filter(e => e.tipo === 'gol')
                .reduce((sum, e) => sum + e.valore, 0);
            
            // Leggi gol dalla partita
            const golCasa = parseInt(document.getElementById(`${prefisso}GolCasa`).value) || 0;
            const golOspite = parseInt(document.getElementById(`${prefisso}GolOspite`).value) || 0;
            const golPartita = golCasa + golOspite;
            
            // Aggiorna avvisi
            const avvisoGol = document.getElementById('avvisoGol');
            const avvisoGolCorretto = document.getElementById('avvisoGolCorretto');
            
            if (golEventi !== golPartita) {
                avvisoGol.classList.remove('hidden');
                if (avvisoGolCorretto) avvisoGolCorretto.classList.add('hidden');
                avvisoGol.textContent = `‚ö†Ô∏è ATTENZIONE: Hai assegnato ${golEventi} gol ai giocatori, ma il risultato √® ${golPartita} gol!`;
            } else {
                avvisoGol.classList.add('hidden');
                if (avvisoGolCorretto) {
                    avvisoGolCorretto.classList.remove('hidden');
                    avvisoGolCorretto.textContent = `‚úì Perfetto! I ${golEventi} gol assegnati corrispondono al risultato.`;
                }
            }
        }
        
        // POPOLA DROPDOWN MIGLIORI E PORTIERI
        function popolaDropdownMigliori(squadraCasa, squadraOspite, tipo) {
            const prefisso = tipo === 'finale' ? 'finale' : '';
            
            // Dropdown miglior giocatore
            const selectMigliorGiocatore = document.getElementById(`${prefisso}MigliorGiocatore`);
            selectMigliorGiocatore.innerHTML = '<option value="">-- Seleziona miglior giocatore --</option>';
            
            // Dropdown portieri
            const selectPortiereCasa = document.getElementById(`${prefisso}PortiereCasa`);
            const selectPortiereOspite = document.getElementById(`${prefisso}PortiereOspite`);
            selectPortiereCasa.innerHTML = '<option value="">-- Seleziona Portiere --</option>';
            selectPortiereOspite.innerHTML = '<option value="">-- Seleziona Portiere --</option>';
            
            // Filtra giocatori per squadra
            const giocatoriCasa = datiTorneo.giocatori.filter(g => g.squadra === squadraCasa);
            const giocatoriOspite = datiTorneo.giocatori.filter(g => g.squadra === squadraOspite);
            
            // Popola miglior giocatore (solo giocatori di campo)
            [...giocatoriCasa, ...giocatoriOspite]
                .filter(g => g.ruolo === 'Giocatore')
                .forEach(giocatore => {
                    const option = document.createElement('option');
                    option.value = giocatore.id;
                    option.textContent = `${giocatore.nome} (${giocatore.squadra})`;
                    selectMigliorGiocatore.appendChild(option);
                });
            
            // Popola portieri
            giocatoriCasa
                .filter(g => g.ruolo === 'Portiere')
                .forEach(portiere => {
                    const option = document.createElement('option');
                    option.value = portiere.id;
                    option.textContent = `${portiere.nome} (#${portiere.numero || '?'})`;
                    selectPortiereCasa.appendChild(option);
                });
            
            giocatoriOspite
                .filter(g => g.ruolo === 'Portiere')
                .forEach(portiere => {
                    const option = document.createElement('option');
                    option.value = portiere.id;
                    option.textContent = `${portiere.nome} (#${portiere.numero || '?'})`;
                    selectPortiereOspite.appendChild(option);
                });
        }
        
        // AGGIORNA NOME PORTIERE
        function aggiornaNomePortiere(tipo) {
            let selectId, nomeId;
            
            switch(tipo) {
                case 'casa':
                    selectId = 'portiereCasa';
                    nomeId = 'nome-portiere-casa';
                    break;
                case 'ospite':
                    selectId = 'portiereOspite';
                    nomeId = 'nome-portiere-ospite';
                    break;
                case 'finale-casa':
                    selectId = 'finalePortiereCasa';
                    nomeId = 'finale-nome-portiere-casa';
                    break;
                case 'finale-ospite':
                    selectId = 'finalePortiereOspite';
                    nomeId = 'finale-nome-portiere-ospite';
                    break;
            }
            
            const select = document.getElementById(selectId);
            const elementoNome = document.getElementById(nomeId);
            
            if (select.value) {
                const portiere = datiTorneo.giocatori.find(g => g.id === select.value);
                if (portiere) {
                    elementoNome.textContent = `${portiere.nome} (#${portiere.numero || '?'})`;
                }
            } else {
                elementoNome.textContent = 'Nessun portiere selezionato';
            }
        }
        
        // SALVA PARTITA
        async function salvaPartita(tipo) {
            const prefisso = tipo === 'finale' ? 'finale' : '';
            const eventi = tipo === 'finale' ? eventiPartitaFinale : eventiPartitaNormale;
            
            // Validazioni
            if (!validazionePartita(tipo)) {
                return;
            }
            
            // Prepara dati partita
            const partitaData = {
                squadra_casa: document.getElementById(`${prefisso}SquadraCasa`).value,
                squadra_ospite: document.getElementById(`${prefisso}SquadraOspite`).value,
                gol_casa: parseInt(document.getElementById(`${prefisso}GolCasa`).value) || 0,
                gol_ospite: parseInt(document.getElementById(`${prefisso}GolOspite`).value) || 0,
                data: new Date().toISOString().split('T')[0],
                ora: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                eventi: eventi.map(e => ({
                    giocatoreId: e.giocatoreId,
                    giocatoreNome: e.giocatoreNome,
                    squadra: e.squadra,
                    tipo: e.tipo,
                    valore: e.valore
                }))
            };
            
            // Aggiungi miglior giocatore se selezionato
            const migliorGiocatoreId = document.getElementById(`${prefisso}MigliorGiocatore`).value;
            const votoMigliorGiocatore = parseInt(document.getElementById(`${prefisso}voto-miglior-giocatore-attuale`).textContent) || 0;
            
            if (migliorGiocatoreId && votoMigliorGiocatore > 0) {
                partitaData.miglior_giocatore = migliorGiocatoreId;
                partitaData.voto_miglior_giocatore = votoMigliorGiocatore;
            }
            
            // Aggiungi portieri e voti
            const portiereCasaId = document.getElementById(`${prefisso}PortiereCasa`).value;
            const portiereOspiteId = document.getElementById(`${prefisso}PortiereOspite`).value;
            const votoPortiereCasa = parseInt(document.getElementById(`${prefisso}voto-portiere-casa-attuale`).textContent) || 0;
            const votoPortiereOspite = parseInt(document.getElementById(`${prefisso}voto-portiere-ospite-attuale`).textContent) || 0;
            
            if (portiereCasaId) {
                partitaData.portiere_casa = portiereCasaId;
                if (votoPortiereCasa > 0) {
                    partitaData.voto_portiere_casa = votoPortiereCasa;
                }
            }
            
            if (portiereOspiteId) {
                partitaData.portiere_ospite = portiereOspiteId;
                if (votoPortiereOspite > 0) {
                    partitaData.voto_portiere_ospite = votoPortiereOspite;
                }
            }
            
            try {
                let risultato;
                if (tipo === 'finale') {
                    // Salva finale
                    risultato = await database.salvaFinale(partitaData);
                    mostraMessaggio('üèÜ Finale salvata con successo!', 'successo');
                } else {
                    // Salva partita normale
                    risultato = await database.aggiungiPartita(partitaData);
                    mostraMessaggio('‚öΩ Partita salvata con successo!', 'successo');
                }
                
                // Aggiorna statistiche giocatori
                await aggiornaStatisticheGiocatori(eventi, migliorGiocatoreId, portiereCasaId, portiereOspiteId, tipo);
                
                // Aggiorna statistiche squadre
                await aggiornaStatisticheSquadre(partitaData);
                
                // Reset form
                resetFormPartita(tipo);
                
                console.log('‚úÖ Partita salvata:', risultato);
                
            } catch (error) {
                console.error('‚ùå Errore salvataggio partita:', error);
                mostraMessaggio('‚ùå Errore nel salvataggio della partita', 'errore');
            }
        }
        
        // VALIDAZIONE PARTITA
        function validazionePartita(tipo) {
            const prefisso = tipo === 'finale' ? 'finale' : '';
            const eventi = tipo === 'finale' ? eventiPartitaFinale : eventiPartitaNormale;
            
            // Controlla squadre selezionate
            const squadraCasa = document.getElementById(`${prefisso}SquadraCasa`).value;
            const squadraOspite = document.getElementById(`${prefisso}SquadraOspite`).value;
            
            if (!squadraCasa || !squadraOspite) {
                mostraMessaggio('‚ùå Seleziona entrambe le squadre', 'errore');
                evidenziaObbligatorio(`${prefisso}SquadraCasa`);
                evidenziaObbligatorio(`${prefisso}SquadraOspite`);
                return false;
            }
            
            if (squadraCasa === squadraOspite) {
                mostraMessaggio('‚ùå Non puoi selezionare la stessa squadra per casa e ospite', 'errore');
                return false;
            }
            
            // Controlla gol
            const golCasa = parseInt(document.getElementById(`${prefisso}GolCasa`).value) || 0;
            const golOspite = parseInt(document.getElementById(`${prefisso}GolOspite`).value) || 0;
            
            if (golCasa < 0 || golOspite < 0) {
                mostraMessaggio('‚ùå I gol non possono essere negativi', 'errore');
                return false;
            }
            
            // Controlla corrispondenza gol assegnati
            const golEventi = eventi
                .filter(e => e.tipo === 'gol')
                .reduce((sum, e) => sum + e.valore, 0);
            
            if (golEventi !== (golCasa + golOspite)) {
                const conferma = confirm(`‚ö†Ô∏è Hai assegnato ${golEventi} gol ai giocatori, ma il risultato √® ${golCasa + golOspite} gol.\nVuoi salvare comunque?`);
                if (!conferma) return false;
            }
            
            // Controlla miglior giocatore (opzionale ma consigliato)
            const migliorGiocatoreId = document.getElementById(`${prefisso}MigliorGiocatore`).value;
            const votoMigliorGiocatore = parseInt(document.getElementById(`${prefisso}voto-miglior-giocatore-attuale`).textContent) || 0;
            
            if (migliorGiocatoreId && votoMigliorGiocatore === 0) {
                const conferma = confirm('‚ö†Ô∏è Hai selezionato un miglior giocatore ma non hai assegnato un voto.\nVuoi salvare comunque?');
                if (!conferma) return false;
            }
            
            return true;
        }
        
        // EVIDENZIA CAMPO OBBLIGATORIO
        function evidenziaObbligatorio(elementId) {
            const elemento = document.getElementById(elementId);
            elemento.classList.add('selezione-obbligatoria');
            
            setTimeout(() => {
                elemento.classList.remove('selezione-obbligatoria');
            }, 3000);
        }
        
        // AGGIORNA STATISTICHE GIOCATORI
        async function aggiornaStatisticheGiocatori(eventi, migliorGiocatoreId, portiereCasaId, portiereOspiteId, tipo) {
            try {
                // Aggiorna per ogni evento
                for (const evento of eventi) {
                    const giocatore = datiTorneo.giocatori.find(g => g.id === evento.giocatoreId);
                    if (giocatore) {
                        const updates = {};
                        
                        if (evento.tipo === 'gol') {
                            updates.gol = (giocatore.gol || 0) + evento.valore;
                        } else if (evento.tipo === 'amm') {
                            updates.ammonizioni = (giocatore.ammonizioni || 0) + evento.valore;
                        } else if (evento.tipo === 'esp') {
                            updates.espulsioni = (giocatore.espulsioni || 0) + evento.valore;
                        }
                        
                        if (Object.keys(updates).length > 0) {
                            await database.aggiornaGiocatore(giocatore.id, updates);
                        }
                    }
                }
                
                // Aggiorna miglior giocatore
                if (migliorGiocatoreId) {
                    const migliorGiocatore = datiTorneo.giocatori.find(g => g.id === migliorGiocatoreId);
                    if (migliorGiocatore) {
                        const voto = parseInt(document.getElementById(`${tipo === 'finale' ? 'finale-' : ''}voto-miglior-giocatore-attuale`).textContent) || 0;
                        
                        const updates = {
                            premi_miglior_giocatore: (migliorGiocatore.premi_miglior_giocatore || 0) + 1,
                            punteggio_totale: (migliorGiocatore.punteggio_totale || 0) + voto
                        };
                        
                        await database.aggiornaGiocatore(migliorGiocatore.id, updates);
                    }
                }
                
                // Aggiorna portieri
                if (portiereCasaId) {
                    const portiereCasa = datiTorneo.giocatori.find(g => g.id === portiereCasaId);
                    if (portiereCasa) {
                        const voto = parseInt(document.getElementById(`${tipo === 'finale' ? 'finale-' : ''}voto-portiere-casa-attuale`).textContent) || 0;
                        
                        if (voto > 0) {
                            const updates = {
                                premi_miglior_portiere: (portiereCasa.premi_miglior_portiere || 0) + 1,
                                punteggio_totale: (portiereCasa.punteggio_totale || 0) + voto
                            };
                            
                            await database.aggiornaGiocatore(portiereCasa.id, updates);
                        }
                    }
                }
                
                if (portiereOspiteId) {
                    const portiereOspite = datiTorneo.giocatori.find(g => g.id === portiereOspiteId);
                    if (portiereOspite) {
                        const voto = parseInt(document.getElementById(`${tipo === 'finale' ? 'finale-' : ''}voto-portiere-ospite-attuale`).textContent) || 0;
                        
                        if (voto > 0) {
                            const updates = {
                                premi_miglior_portiere: (portiereOspite.premi_miglior_portiere || 0) + 1,
                                punteggio_totale: (portiereOspite.punteggio_totale || 0) + voto
                            };
                            
                            await database.aggiornaGiocatore(portiereOspite.id, updates);
                        }
                    }
                }
                
                console.log('‚úÖ Statistiche giocatori aggiornate');
                
            } catch (error) {
                console.error('‚ùå Errore aggiornamento statistiche giocatori:', error);
                throw error;
            }
        }
        
        // AGGIORNA STATISTICHE SQUADRE
        async function aggiornaStatisticheSquadre(partitaData) {
            try {
                // Trova squadre nel database
                const squadraCasa = datiTorneo.squadre.find(s => s.nome === partitaData.squadra_casa);
                const squadraOspite = datiTorneo.squadre.find(s => s.nome === partitaData.squadra_ospite);
                
                if (!squadraCasa || !squadraOspite) {
                    console.warn('‚ö†Ô∏è Squadre non trovate per aggiornamento statistiche');
                    return;
                }
                
                // Calcola nuovi valori per squadra casa
                const updatesCasa = {
                    partite_giocate: (squadraCasa.partite_giocate || 0) + 1,
                    gol_fatti: (squadraCasa.gol_fatti || 0) + (partitaData.gol_casa || 0),
                    gol_subiti: (squadraCasa.gol_subiti || 0) + (partitaData.gol_ospite || 0)
                };
                
                // Calcola nuovi valori per squadra ospite
                const updatesOspite = {
                    partite_giocate: (squadraOspite.partite_giocate || 0) + 1,
                    gol_fatti: (squadraOspite.gol_fatti || 0) + (partitaData.gol_ospite || 0),
                    gol_subiti: (squadraOspite.gol_subiti || 0) + (partitaData.gol_casa || 0)
                };
                
                // Determina risultato
                if (partitaData.gol_casa > partitaData.gol_ospite) {
                    // Vittoria casa
                    updatesCasa.vittorie = (squadraCasa.vittorie || 0) + 1;
                    updatesCasa.punti = (squadraCasa.punti || 0) + 3;
                    updatesOspite.sconfitte = (squadraOspite.sconfitte || 0) + 1;
                } else if (partitaData.gol_casa < partitaData.gol_ospite) {
                    // Vittoria ospite
                    updatesOspite.vittorie = (squadraOspite.vittorie || 0) + 1;
                    updatesOspite.punti = (squadraOspite.punti || 0) + 3;
                    updatesCasa.sconfitte = (squadraCasa.sconfitte || 0) + 1;
                } else {
                    // Pareggio
                    updatesCasa.pareggi = (squadraCasa.pareggi || 0) + 1;
                    updatesCasa.punti = (squadraCasa.punti || 0) + 1;
                    updatesOspite.pareggi = (squadraOspite.pareggi || 0) + 1;
                    updatesOspite.punti = (squadraOspite.punti || 0) + 1;
                }
                
                // Aggiorna squadra casa
                await database.aggiornaSquadra(squadraCasa.id, updatesCasa);
                
                // Aggiorna squadra ospite
                await database.aggiornaSquadra(squadraOspite.id, updatesOspite);
                
                console.log('‚úÖ Statistiche squadre aggiornate');
                
            } catch (error) {
                console.error('‚ùå Errore aggiornamento statistiche squadre:', error);
                throw error;
            }
        }
        
        // AGGIUNGI SQUADRA
        async function aggiungiSquadra() {
            const nome = document.getElementById('nomeSquadra').value.trim();
            const allenatore = document.getElementById('allenatore').value.trim();
            const colori = document.getElementById('colori').value.trim();
            
            if (!nome) {
                mostraMessaggio('‚ùå Inserisci un nome per la squadra', 'errore');
                return;
            }
            
            // Controlla se squadra esiste gi√†
            if (datiTorneo.squadre.some(s => s.nome.toLowerCase() === nome.toLowerCase())) {
                mostraMessaggio('‚ùå Una squadra con questo nome esiste gi√†', 'errore');
                return;
            }
            
            try {
                const btn = document.getElementById('btnAggiungiSquadra');
                btn.disabled = true;
                btn.innerHTML = 'üîÑ Aggiungo...';
                
                const nuovaSquadra = {
                    nome: nome,
                    allenatore: allenatore || 'Non specificato',
                    colori: colori || 'Non specificati',
                    punti: 0,
                    partite_giocate: 0,
                    vittorie: 0,
                    pareggi: 0,
                    sconfitte: 0,
                    gol_fatti: 0,
                    gol_subiti: 0
                };
                
                await database.aggiungiSquadra(nuovaSquadra);
                
                mostraMessaggio(`‚úÖ Squadra "${nome}" aggiunta con successo!`, 'successo');
                
                // Reset form
                document.getElementById('nomeSquadra').value = '';
                document.getElementById('allenatore').value = '';
                document.getElementById('colori').value = '';
                
            } catch (error) {
                console.error('‚ùå Errore aggiunta squadra:', error);
                mostraMessaggio('‚ùå Errore nell\'aggiunta della squadra', 'errore');
            } finally {
                const btn = document.getElementById('btnAggiungiSquadra');
                btn.disabled = false;
                btn.innerHTML = 'AGGIUNGI SQUADRA';
            }
        }
        
        // AGGIUNGI GIOCATORE
        async function aggiungiGiocatore() {
            const squadra = document.getElementById('squadraGiocatore').value;
            const nome = document.getElementById('nomeGiocatore').value.trim();
            const numero = document.getElementById('numeroMaglia').value;
            const ruolo = document.getElementById('ruolo').value;
            
            if (!squadra || !nome) {
                mostraMessaggio('‚ùå Completa tutti i campi obbligatori', 'errore');
                return;
            }
            
            // Controlla se giocatore esiste gi√† (nome + squadra)
            const giocatoreEsistente = datiTorneo.giocatori.find(
                g => g.nome.toLowerCase() === nome.toLowerCase() && g.squadra === squadra
            );
            
            if (giocatoreEsistente) {
                mostraMessaggio('‚ùå Un giocatore con questo nome esiste gi√† in questa squadra', 'errore');
                return;
            }
            
            try {
                const btn = document.getElementById('btnAggiungiGiocatore');
                btn.disabled = true;
                btn.innerHTML = 'üîÑ Aggiungo...';
                
                const nuovoGiocatore = {
                    nome: nome,
                    squadra: squadra,
                    numero: numero ? parseInt(numero) : null,
                    ruolo: ruolo,
                    gol: 0,
                    ammonizioni: 0,
                    espulsioni: 0,
                    punteggio_totale: 0,
                    premi_miglior_giocatore: 0,
                    premi_miglior_portiere: 0
                };
                
                await database.aggiungiGiocatore(nuovoGiocatore);
                
                mostraMessaggio(`‚úÖ Giocatore "${nome}" aggiunto alla squadra ${squadra}!`, 'successo');
                
                // Reset form
                document.getElementById('nomeGiocatore').value = '';
                document.getElementById('numeroMaglia').value = '';
                document.getElementById('ruolo').value = 'Giocatore';
                
            } catch (error) {
                console.error('‚ùå Errore aggiunta giocatore:', error);
                mostraMessaggio('‚ùå Errore nell\'aggiunta del giocatore', 'errore');
            } finally {
                const btn = document.getElementById('btnAggiungiGiocatore');
                btn.disabled = false;
                btn.innerHTML = 'AGGIUNGI GIOCATORE';
            }
        }
        
        // MOSTRA OPZIONI ELIMINA
        function mostraOpzioniElimina() {
            const tipo = document.getElementById('tipoElimina').value;
            const opzioniContainer = document.getElementById('opzioniElimina');
            const btnElimina = document.getElementById('btnElimina');
            const avviso = document.getElementById('avvisoEliminazione');
            
            opzioniContainer.innerHTML = '';
            btnElimina.classList.add('hidden');
            avviso.classList.add('hidden');
            
            if (!tipo) return;
            
            if (tipo === 'tutto') {
                opzioniContainer.innerHTML = `
                    <div class="avviso errore">
                        ‚ö†Ô∏è STAI PER ELIMINARE TUTTI I DATI DEL TORNEO!<br>
                        Questa operazione eliminer√†: Squadre, Giocatori, Partite e Finale.
                    </div>
                    <input type="text" id="confermaElimina" placeholder="Scrivi 'ELIMINA TUTTO' per confermare">
                `;
                avviso.classList.remove('hidden');
                btnElimina.classList.remove('hidden');
                
            } else if (tipo === 'squadra') {
                if (datiTorneo.squadre.length === 0) {
                    opzioniContainer.innerHTML = '<div class="avviso">Nessuna squadra da eliminare</div>';
                    return;
                }
                
                let html = '<select id="squadraDaEliminare"><option value="">Seleziona Squadra</option>';
                datiTorneo.squadre.forEach(squadra => {
                    // Conta giocatori nella squadra
                    const numGiocatori = datiTorneo.giocatori.filter(g => g.squadra === squadra.nome).length;
                    html += `<option value="${squadra.id}">${squadra.nome} (${numGiocatori} giocatori)</option>`;
                });
                html += '</select>';
                
                opzioniContainer.innerHTML = html;
                btnElimina.classList.remove('hidden');
                
            } else if (tipo === 'giocatore') {
                if (datiTorneo.giocatori.length === 0) {
                    opzioniContainer.innerHTML = '<div class="avviso">Nessun giocatore da eliminare</div>';
                    return;
                }
                
                let html = '<select id="giocatoreDaEliminare"><option value="">Seleziona Giocatore</option>';
                datiTorneo.giocatori.forEach(giocatore => {
                    html += `<option value="${giocatore.id}">${giocatore.nome} (${giocatore.squadra})</option>`;
                });
                html += '</select>';
                
                opzioniContainer.innerHTML = html;
                btnElimina.classList.remove('hidden');
            }
        }
        
        // ESEGUI ELIMINAZIONE
        async function eseguiEliminazione() {
            const tipo = document.getElementById('tipoElimina').value;
            
            try {
                if (tipo === 'tutto') {
                    const conferma = document.getElementById('confermaElimina').value;
                    if (conferma !== 'ELIMINA TUTTO') {
                        mostraMessaggio('‚ùå Devi scrivere esattamente "ELIMINA TUTTO" per confermare', 'errore');
                        return;
                    }
                    
                    if (!confirm('‚ö†Ô∏è SEI SICURO DI VOLER ELIMINARE TUTTI I DATI?\nQuesta operazione √® IRREVERSIBILE!')) {
                        return;
                    }
                    
                    await database.eliminaTutto();
                    mostraMessaggio('‚úÖ Tutti i dati sono stati eliminati', 'successo');
                    
                } else if (tipo === 'squadra') {
                    const squadraId = document.getElementById('squadraDaEliminare').value;
                    if (!squadraId) {
                        mostraMessaggio('‚ùå Seleziona una squadra da eliminare', 'errore');
                        return;
                    }
                    
                    const squadra = datiTorneo.squadre.find(s => s.id === squadraId);
                    if (!squadra) return;
                    
                    if (!confirm(`‚ö†Ô∏è Eliminare la squadra "${squadra.nome}" e tutti i suoi giocatori?`)) {
                        return;
                    }
                    
                    // Prima elimina i giocatori della squadra
                    const giocatoriSquadra = datiTorneo.giocatori.filter(g => g.squadra === squadra.nome);
                    for (const giocatore of giocatoriSquadra) {
                        await database.eliminaGiocatore(giocatore.id);
                    }
                    
                    // Poi elimina la squadra
                    await database.eliminaSquadra(squadraId);
                    mostraMessaggio(`‚úÖ Squadra "${squadra.nome}" eliminata`, 'successo');
                    
                } else if (tipo === 'giocatore') {
                    const giocatoreId = document.getElementById('giocatoreDaEliminare').value;
                    if (!giocatoreId) {
                        mostraMessaggio('‚ùå Seleziona un giocatore da eliminare', 'errore');
                        return;
                    }
                    
                    const giocatore = datiTorneo.giocatori.find(g => g.id === giocatoreId);
                    if (!giocatore) return;
                    
                    if (!confirm(`‚ö†Ô∏è Eliminare il giocatore "${giocatore.nome}"?`)) {
                        return;
                    }
                    
                    await database.eliminaGiocatore(giocatoreId);
                    mostraMessaggio(`‚úÖ Giocatore "${giocatore.nome}" eliminato`, 'successo');
                }
                
                // Reset selezione
                document.getElementById('tipoElimina').value = '';
                document.getElementById('opzioniElimina').innerHTML = '';
                document.getElementById('btnElimina').classList.add('hidden');
                document.getElementById('avvisoEliminazione').classList.add('hidden');
                
            } catch (error) {
                console.error('‚ùå Errore eliminazione:', error);
                mostraMessaggio('‚ùå Errore durante l\'eliminazione', 'errore');
            }
        }
        
        // CARICA PARTITE SALVATE
        async function caricaPartiteSalvate() {
            try {
                const container = document.getElementById('listaPartite');
                const nessunaPartita = document.getElementById('nessunaPartita');
                
                if (datiTorneo.partite.length === 0 && !datiTorneo.finale) {
                    container.innerHTML = '';
                    nessunaPartita.classList.remove('hidden');
                    return;
                }
                
                nessunaPartita.classList.add('hidden');
                let html = '';
                
                // Partite normali
                if (datiTorneo.partite.length > 0) {
                    html += '<h3>‚öΩ PARTITE NORMALI</h3>';
                    
                    datiTorneo.partite.forEach((partita, index) => {
                        const dataFormattata = partita.data ? new Date(partita.data).toLocaleDateString('it-IT') : 'N/D';
                        const oraFormattata = partita.ora || '';
                        
                        html += `
                            <div class="partita-item" data-id="${partita.id}">
                                <div class="partita-header">
                                    <div>
                                        <strong>${partita.squadra_casa} ${partita.gol_casa || 0} - ${partita.gol_ospite || 0} ${partita.squadra_ospite}</strong>
                                        <div style="font-size: 0.9em; color: #666;">
                                            ${dataFormattata} ${oraFormattata}
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn-elimina" onclick="eliminaPartita('${partita.id}')">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div style="font-size: 0.9em; color: #555;">
                                    ${partita.miglior_giocatore ? 'üèÜ Miglior Giocatore: ' + trovaNomeGiocatore(partita.miglior_giocatore) : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Finale
                if (datiTorneo.finale) {
                    html += '<h3 style="margin-top: 30px; color: #FFD700;">üèÜ PARTITA FINALE</h3>';
                    
                    const finale = datiTorneo.finale;
                    const dataFormattata = finale.data ? new Date(finale.data).toLocaleDateString('it-IT') : 'N/D';
                    const oraFormattata = finale.ora || '';
                    
                    html += `
                        <div class="partita-item" style="border: 2px solid gold; background: #fffef0;">
                            <div class="partita-header">
                                <div>
                                    <strong>${finale.squadra_casa} ${finale.gol_casa || 0} - ${finale.gol_ospite || 0} ${finale.squadra_ospite}</strong>
                                    <div style="font-size: 0.9em; color: #666;">
                                        ${dataFormattata} ${oraFormattata}
                                    </div>
                                </div>
                                <div>
                                    <span style="background: gold; color: #333; padding: 3px 8px; border-radius: 3px; font-weight: bold;">FINALE</span>
                                </div>
                            </div>
                            <div style="font-size: 0.9em; color: #555;">
                                ${finale.miglior_giocatore ? 'üèÜ Miglior Giocatore: ' + trovaNomeGiocatore(finale.miglior_giocatore) : ''}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå Errore caricamento partite:', error);
                mostraMessaggio('‚ùå Errore nel caricamento delle partite', 'errore');
            }
        }
        
        // ELIMINA PARTITA
        async function eliminaPartita(partitaId) {
            if (!confirm('‚ö†Ô∏è Eliminare questa partita?\nLe statistiche dei giocatori NON verranno aggiornate.')) {
                return;
            }
            
            try {
                await database.eliminaPartita(partitaId);
                mostraMessaggio('‚úÖ Partita eliminata', 'successo');
                
                // Ricarica lista
                setTimeout(() => caricaPartiteSalvate(), 500);
                
            } catch (error) {
                console.error('‚ùå Errore eliminazione partita:', error);
                mostraMessaggio('‚ùå Errore nell\'eliminazione della partita', 'errore');
            }
        }
        
        // ELIMINA TUTTE LE PARTITE
        async function eliminaTuttePartite() {
            if (!confirm('‚ö†Ô∏è ELIMINARE TUTTE LE PARTITE NORMALI?\nQuesta operazione √® irreversibile!\nLa finale NON verr√† eliminata.')) {
                return;
            }
            
            try {
                // Elimina tutte le partite normali
                for (const partita of datiTorneo.partite) {
                    await database.eliminaPartita(partita.id);
                }
                
                mostraMessaggio('‚úÖ Tutte le partite normali eliminate', 'successo');
                
                // Ricarica lista
                setTimeout(() => caricaPartiteSalvate(), 1000);
                
            } catch (error) {
                console.error('‚ùå Errore eliminazione partite:', error);
                mostraMessaggio('‚ùå Errore nell\'eliminazione delle partite', 'errore');
            }
        }
        
        // ELIMINA FINALE
        async function eliminaFinale() {
            if (!confirm('‚ö†Ô∏è Eliminare la partita finale?\nLa sezione finale del sito risulter√† vuota.')) {
                return;
            }
            
            try {
                // Elimina la finale dal database
                await supabase.from('finale').delete().neq('id', 0);
                datiTorneo.finale = null;
                
                mostraMessaggio('‚úÖ Finale eliminata', 'successo');
                
                // Ricarica lista se siamo nella sezione gestione partite
                if (document.getElementById('gestionePartite').classList.contains('attiva')) {
                    setTimeout(() => caricaPartiteSalvate(), 500);
                }
                
            } catch (error) {
                console.error('‚ùå Errore eliminazione finale:', error);
                mostraMessaggio('‚ùå Errore nell\'eliminazione della finale', 'errore');
            }
        }
        
        // CARICA FINALE ESISTENTE
        function caricaFinaleEsistente() {
            if (!datiTorneo.finale) return;
            
            const finale = datiTorneo.finale;
            
            // Imposta valori nei form
            document.getElementById('finaleSquadraCasa').value = finale.squadra_casa;
            document.getElementById('finaleSquadraOspite').value = finale.squadra_ospite;
            document.getElementById('finaleGolCasa').value = finale.gol_casa || 0;
            document.getElementById('finaleGolOspite').value = finale.gol_ospite || 0;
            
            // Aggiorna nomi
            aggiornaNomiSquadre();
            
            // Carica giocatori
            caricaGiocatoriPartita('finale');
            
            // Imposta miglior giocatore se presente
            if (finale.miglior_giocatore) {
                document.getElementById('finaleMigliorGiocatore').value = finale.miglior_giocatore;
                if (finale.voto_miglior_giocatore) {
                    // Imposta stelle voto
                    const stelle = document.querySelectorAll('#finale-voto-miglior-giocatore .stella');
                    stelle.forEach((stella, index) => {
                        if (index < finale.voto_miglior_giocatore) {
                            stella.classList.add('selezionata');
                        }
                    });
                    document.getElementById('finale-voto-miglior-giocatore-attuale').textContent = finale.voto_miglior_giocatore;
                }
            }
            
            // Imposta portieri
            if (finale.portiere_casa) {
                document.getElementById('finalePortiereCasa').value = finale.portiere_casa;
                aggiornaNomePortiere('finale-casa');
                if (finale.voto_portiere_casa) {
                    const stelle = document.querySelectorAll('#finale-voto-portiere-casa .stella');
                    stelle.forEach((stella, index) => {
                        if (index < finale.voto_portiere_casa) {
                            stella.classList.add('selezionata');
                        }
                    });
                    document.getElementById('finale-voto-portiere-casa-attuale').textContent = finale.voto_portiere_casa;
                }
            }
            
            if (finale.portiere_ospite) {
                document.getElementById('finalePortiereOspite').value = finale.portiere_ospite;
                aggiornaNomePortiere('finale-ospite');
                if (finale.voto_portiere_ospite) {
                    const stelle = document.querySelectorAll('#finale-voto-portiere-ospite .stella');
                    stelle.forEach((stella, index) => {
                        if (index < finale.voto_portiere_ospite) {
                            stella.classList.add('selezionata');
                        }
                    });
                    document.getElementById('finale-voto-portiere-ospite-attuale').textContent = finale.voto_portiere_ospite;
                }
            }
            
            // Carica eventi se presenti
            if (finale.eventi && finale.eventi.length > 0) {
                eventiPartitaFinale = finale.eventi.map(e => ({
                    giocatoreId: e.giocatoreId,
                    giocatoreNome: e.giocatoreNome,
                    squadra: e.squadra,
                    tipo: e.tipo,
                    valore: e.valore
                }));
                
                // Aggiorna contatori sui giocatori
                eventiPartitaFinale.forEach(evento => {
                    const elemento = document.getElementById(`${evento.tipo}-${evento.giocatoreId}`);
                    if (elemento) {
                        elemento.textContent = evento.valore;
                    }
                });
                
                aggiornaRiepilogoEventi('finale');
            }
            
            // Disabilita pulsante salva (la finale esiste gi√†)
            document.getElementById('btnSalvaFinale').disabled = true;
            document.getElementById('btnSalvaFinale').textContent = 'üèÜ FINALE GI√Ä SALVATA';
            
            mostraMessaggio('‚ÑπÔ∏è Finale gi√† presente. Puoi visualizzarla o eliminarla.', 'info');
        }
        
        // CANCELLA EVENTI
        function cancellaEventi(tipo) {
            if (!confirm('‚ö†Ô∏è Cancellare tutti gli eventi registrati?')) {
                return;
            }
            
            const eventi = tipo === 'finale' ? eventiPartitaFinale : eventiPartitaNormale;
            eventi.length = 0;
            
            // Reset contatori visuali
            const prefisso = tipo === 'finale' ? 'finale' : '';
            const containerCasa = document.getElementById(`${prefisso}GiocatoriCasa`);
            const containerOspite = document.getElementById(`${prefisso}GiocatoriOspite`);
            
            [containerCasa, containerOspite].forEach(container => {
                if (container) {
                    container.querySelectorAll('.contatore-valore').forEach(el => {
                        el.textContent = '0';
                    });
                }
            });
            
            // Aggiorna riepilogo
            aggiornaRiepilogoEventi(tipo);
            
            mostraMessaggio('‚úÖ Eventi cancellati', 'successo');
        }
        
        // GENERA PARTITA CASUALE (per test)
        function generaPartitaCasuale() {
            if (datiTorneo.squadre.length < 2) {
                mostraMessaggio('‚ùå Servono almeno 2 squadre per generare una partita', 'errore');
                return;
            }
            
            // Seleziona due squadre casuali diverse
            let squadra1, squadra2;
            do {
                squadra1 = datiTorneo.squadre[Math.floor(Math.random() * datiTorneo.squadre.length)];
                squadra2 = datiTorneo.squadre[Math.floor(Math.random() * datiTorneo.squadre.length)];
            } while (squadra1.nome === squadra2.nome);
            
            // Imposta squadre
            document.getElementById('squadraCasa').value = squadra1.nome;
            document.getElementById('squadraOspite').value = squadra2.nome;
            
            // Genera risultato casuale (0-5)
            const golCasa = Math.floor(Math.random() * 6);
            const golOspite = Math.floor(Math.random() * 6);
            document.getElementById('golCasa').value = golCasa;
            document.getElementById('golOspite').value = golOspite;
            
            // Carica giocatori
            caricaGiocatoriPartita('normale');
            
            // Genera eventi casuali
            setTimeout(() => {
                // Seleziona casualmente alcuni giocatori e assegna eventi
                const giocatoriCasa = datiTorneo.giocatori.filter(g => g.squadra === squadra1.nome);
                const giocatoriOspite = datiTorneo.giocatori.filter(g => g.squadra === squadra2.nome);
                
                // Assegna gol
                let golAssegnati = 0;
                for (let i = 0; i < golCasa && i < giocatoriCasa.length; i++) {
                    const giocatore = giocatoriCasa[i];
                    modificaContatore(giocatore.id, 'gol', 1, 'normale');
                    golAssegnati++;
                }
                
                for (let i = 0; i < golOspite && i < giocatoriOspite.length; i++) {
                    const giocatore = giocatoriOspite[i];
                    modificaContatore(giocatore.id, 'gol', 1, 'normale');
                    golAssegnati++;
                }
                
                // Assegna qualche ammonizione casuale
                if (giocatoriCasa.length > 0) {
                    const giocatore = giocatoriCasa[Math.floor(Math.random() * giocatoriCasa.length)];
                    if (Math.random() > 0.7) {
                        modificaContatore(giocatore.id, 'amm', 1, 'normale');
                    }
                }
                
                if (giocatoriOspite.length > 0) {
                    const giocatore = giocatoriOspite[Math.floor(Math.random() * giocatoriOspite.length)];
                    if (Math.random() > 0.7) {
                        modificaContatore(giocatore.id, 'amm', 1, 'normale');
                    }
                }
                
                // Seleziona casualmente miglior giocatore
                const tuttiGiocatori = [...giocatoriCasa, ...giocatoriOspite].filter(g => g.ruolo === 'Giocatore');
                if (tuttiGiocatori.length > 0) {
                    const migliorGiocatore = tuttiGiocatori[Math.floor(Math.random() * tuttiGiocatori.length)];
                    document.getElementById('migliorGiocatore').value = migliorGiocatore.id;
                    
                    // Assegna voto casuale 6-10
                    const voto = 6 + Math.floor(Math.random() * 5);
                    const stelle = document.querySelectorAll('#voto-miglior-giocatore .stella');
                    stelle.forEach((stella, index) => {
                        if (index < voto) {
                            stella.classList.add('selezionata');
                        }
                    });
                    document.getElementById('voto-miglior-giocatore-attuale').textContent = voto;
                }
                
                // Seleziona portieri casuali
                const portieriCasa = giocatoriCasa.filter(g => g.ruolo === 'Portiere');
                const portieriOspite = giocatoriOspite.filter(g => g.ruolo === 'Portiere');
                
                if (portieriCasa.length > 0) {
                    const portiere = portieriCasa[0];
                    document.getElementById('portiereCasa').value = portiere.id;
                    aggiornaNomePortiere('casa');
                    
                    // Voto casuale 5-9
                    const voto = 5 + Math.floor(Math.random() * 5);
                    const stelle = document.querySelectorAll('#voto-portiere-casa .stella');
                    stelle.forEach((stella, index) => {
                        if (index < voto) {
                            stella.classList.add('selezionata');
                        }
                    });
                    document.getElementById('voto-portiere-casa-attuale').textContent = voto;
                }
                
                if (portieriOspite.length > 0) {
                    const portiere = portieriOspite[0];
                    document.getElementById('portiereOspite').value = portiere.id;
                    aggiornaNomePortiere('ospite');
                    
                    // Voto casuale 5-9
                    const voto = 5 + Math.floor(Math.random() * 5);
                    const stelle = document.querySelectorAll('#voto-portiere-ospite .stella');
                    stelle.forEach((stella, index) => {
                        if (index < voto) {
                            stella.classList.add('selezionata');
                        }
                    });
                    document.getElementById('voto-portiere-ospite-attuale').textContent = voto;
                }
                
                mostraMessaggio('üé≤ Partita casuale generata! Verifica i dati e salva.', 'info');
                
            }, 500); // Delay per caricamento giocatori
        }
        
        // TROVA NOME GIOCATORE PER ID
        function trovaNomeGiocatore(giocatoreId) {
            const giocatore = datiTorneo.giocatori.find(g => g.id === giocatoreId);
            return giocatore ? giocatore.nome : 'Giocatore non trovato';
        }
        
        // AGGIORNA STATO CONNESSIONE
        function aggiornaStatoConnessione(stato) {
            const statusElement = document.getElementById('connessioneStatus');
            const loadingElement = statusElement.querySelector('.loading');
            
            switch(stato) {
                case 'caricamento':
                    statusElement.className = 'connessione-status connessione-caricamento';
                    statusElement.innerHTML = '<div class="loading"></div> Connessione...';
                    break;
                    
                case 'ok':
                    statusElement.className = 'connessione-status connessione-ok';
                    statusElement.innerHTML = '‚úì Connesso in tempo reale';
                    break;
                    
                case 'ko':
                    statusElement.className = 'connessione-status connessione-ko';
                    statusElement.innerHTML = '‚úó Disconnesso';
                    break;
            }
        }
        
        // MOSTRA MESSAGGIO
        function mostraMessaggio(testo, tipo) {
            // Rimuovi messaggi precedenti
            const messaggiPrecedenti = document.querySelectorAll('.messaggio');
            messaggiPrecedenti.forEach(msg => msg.remove());
            
            // Crea nuovo messaggio
            const messaggio = document.createElement('div');
            messaggio.className = `messaggio ${tipo}`;
            messaggio.textContent = testo;
            document.body.appendChild(messaggio);
            
            // Rimuovi dopo 5 secondi
            setTimeout(() => {
                if (messaggio.parentNode) {
                    messaggio.parentNode.removeChild(messaggio);
                }
            }, 5000);
        }
        
        // CONTROLLO PERIODICO CONNESSIONE
        setInterval(async () => {
            try {
                const test = await database.getSquadre();
                if (Array.isArray(test)) {
                    aggiornaStatoConnessione('ok');
                } else {
                    aggiornaStatoConnessione('ko');
                }
            } catch (error) {
                aggiornaStatoConnessione('ko');
            }
        }, 30000);
        
        // ESPORTA FUNZIONI PER IL DOM
        window.mostraSezione = mostraSezione;
        window.tornaMenu = tornaMenu;
        window.tornaHome = tornaHome;
        window.aggiungiSquadra = aggiungiSquadra;
        window.aggiungiGiocatore = aggiungiGiocatore;
        window.mostraOpzioniElimina = mostraOpzioniElimina;
        window.eseguiEliminazione = eseguiEliminazione;
        window.caricaGiocatoriPartita = caricaGiocatoriPartita;
        window.modificaContatore = modificaContatore;
        window.aggiornaNomePortiere = aggiornaNomePortiere;
        window.salvaPartita = salvaPartita;
        window.cancellaEventi = cancellaEventi;
        window.caricaPartiteSalvate = caricaPartiteSalvate;
        window.eliminaPartita = eliminaPartita;
        window.eliminaTuttePartite = eliminaTuttePartite;
        window.eliminaFinale = eliminaFinale;
        window.generaPartitaCasuale = generaPartitaCasuale;
        
    </script>
</body>
</html>

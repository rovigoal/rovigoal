<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rovigoal - Area Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #f0f2f5; padding: 20px; }
        
        .btn-home {
            position: fixed; top: 20px; right: 20px; background: #1e3c72; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .btn-home:hover { background: #2a5298; }
        
        .header {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%); color: white; padding: 20px;
            border-radius: 10px; margin-bottom: 30px; text-align: center; position: relative;
        }
        
        .menu-admin {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
            max-width: 1000px; margin: 0 auto 40px;
        }
        
        .menu-btn {
            background: white; padding: 60px 20px; border-radius: 15px; text-align: center; font-size: 1.5em;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease; border: 3px solid transparent;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .menu-btn:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .menu-btn:nth-child(1) { background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%); color: white; }
        .menu-btn:nth-child(2) { background: linear-gradient(135deg, #32CD32 0%, #228B22 100%); color: white; }
        .menu-btn:nth-child(3) { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #333; }
        .menu-btn:nth-child(4) { background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%); color: white; }
        .menu-btn:nth-child(5) { background: linear-gradient(135deg, #FF0000 0%, #DC143C 100%); color: white; }
        .icona { font-size: 3em; display: block; margin-bottom: 15px; }
        
        .sezione {
            background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px; display: none; max-width: 1200px; margin: 0 auto 30px;
        }
        .sezione.attiva { display: block; }
        
        h2 { color: #333; margin-bottom: 20px; border-bottom: 2px solid #FF4500; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        
        .btn {
            background: linear-gradient(135deg, #FF4500 0%, #DC143C 100%); color: white; border: none;
            padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
            margin-top: 10px; transition: all 0.3s ease;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-full { width: 100%; }
        .btn-green { background: linear-gradient(135deg, #32CD32 0%, #228B22 100%); }
        .btn-red { background: linear-gradient(135deg, #FF0000 0%, #DC143C 100%); }
        
        .giocatori-partita { border: 2px solid #ddd; padding: 15px; border-radius: 8px; margin-top: 15px; background: #f9f9f9; }
        .giocatore-item { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        .giocatore-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .contatore-row { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
        .contatore-label { font-weight: bold; min-width: 120px; }
        .contatore-btn { 
            width: 35px; height: 35px; border-radius: 50%; border: none; 
            font-weight: bold; font-size: 18px; cursor: pointer; 
        }
        .contatore-valore { 
            min-width: 40px; text-align: center; font-weight: bold; 
            font-size: 1.2em; padding: 5px 10px; 
        }
        .btn-gol { background: #32CD32; color: white; }
        .btn-amm { background: #FFD700; color: #333; }
        .btn-esp { background: #DC143C; color: white; }
        
        .eventi-salvati { margin-top: 20px; padding: 15px; background: #e8f4ff; border-radius: 8px; border: 1px solid #b3d9ff; }
        .evento-item { padding: 8px; border-bottom: 1px solid #cce0ff; }
        .evento-item:last-child { border-bottom: none; }
        
        .selezione-migliori { 
            margin-top: 20px; padding: 20px; 
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%); 
            border-radius: 10px; border: 2px solid #4dabf7; 
        }
        .migliori-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        @media (max-width: 768px) { .migliori-row { grid-template-columns: 1fr; } }
        
        .voto-container { margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd; }
        .voto-input { width: 100%; padding: 8px; margin-top: 5px; }
        
        .lista-partite { margin-top: 30px; }
        .partita-admin { 
            background: #f9f9f9; padding: 15px; border-radius: 8px; 
            margin-bottom: 15px; border: 1px solid #ddd; 
        }
        .partita-header { display: flex; justify-content: space-between; align-items: center; }
        
        .opzioni-elimina { margin-top: 20px; padding: 15px; background: #fff3f3; border-radius: 8px; border: 2px solid #f44336; }
        .hidden { display: none; }
        
        /* STATO CONNESSIONE */
        .connessione-status {
            position: absolute; top: 10px; right: 10px; padding: 6px 12px;
            border-radius: 20px; font-size: 0.8em; font-weight: bold; z-index: 100;
            display: flex; align-items: center; gap: 6px;
        }
        .connessione-ok { background: #4CAF50; color: white; border: 2px solid #45a049; }
        .connessione-caricamento { background: #FFA500; color: white; border: 2px solid #FF8C00; }
        .connessione-ko { background: #f44336; color: white; border: 2px solid #d32f2f; }
        .loading {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,.3); border-radius: 50%;
            border-top-color: white; animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* NOTIFICA AGGIORNAMENTO */
        .notifica-aggiornamento {
            position: fixed; top: 10px; right: 10px; background: #4CAF50;
            color: white; padding: 10px 20px; border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999; display: none;
        }
    </style>
</head>
<body>
    <button class="btn-home" onclick="tornaHome()">Torna alla Home</button>
    
    <div class="header">
        <h1>Area Admin</h1>
        <div id="connessioneStatus" class="connessione-status connessione-caricamento">
            <div class="loading"></div> Caricamento...
        </div>
    </div>
    
    <div class="menu-admin" id="menuAdmin">
        <div class="menu-btn" onclick="mostraSezione('aggiungi-squadra')">
            <span class="icona">üèüÔ∏è</span>
            Aggiungi Squadra
        </div>
        <div class="menu-btn" onclick="mostraSezione('aggiungi-giocatore')">
            <span class="icona">üë§</span>
            Aggiungi Giocatore
        </div>
        <div class="menu-btn" onclick="mostraSezione('aggiungi-partita')">
            <span class="icona">‚öΩ</span>
            Aggiungi Partita
        </div>
        <div class="menu-btn" onclick="mostraSezione('aggiungi-finale')">
            <span class="icona">üèÜ</span>
            Aggiungi Finale
        </div>
        <div class="menu-btn" onclick="mostraSezione('elimina-dati')">
            <span class="icona">üóëÔ∏è</span>
            Elimina Dati
        </div>
    </div>
    
    <div id="aggiungi-squadra" class="sezione">
        <h2>Aggiungi Squadra</h2>
        <div class="form-group">
            <label for="nomeSquadra">Nome Squadra:</label>
            <input type="text" id="nomeSquadra">
        </div>
        <div class="form-group">
            <label for="allenatore">Allenatore:</label>
            <input type="text" id="allenatore">
        </div>
        <div class="form-group">
            <label for="colori">Colori:</label>
            <input type="text" id="colori">
        </div>
        <button class="btn btn-full btn-green" onclick="aggiungiSquadra()">Aggiungi Squadra</button>
        <button class="btn btn-full" onclick="tornaMenu()">Torna al Menu</button>
    </div>
    
    <div id="aggiungi-giocatore" class="sezione">
        <h2>Aggiungi Giocatore</h2>
        <div class="form-group">
            <label for="nomeGiocatore">Nome Giocatore:</label>
            <input type="text" id="nomeGiocatore">
        </div>
        <div class="form-group">
            <label for="ruoloGiocatore">Ruolo:</label>
            <select id="ruoloGiocatore">
                <option value="Portiere">Portiere</option>
                <option value="Difensore">Difensore</option>
                <option value="Centrocampista">Centrocampista</option>
                <option value="Attaccante">Attaccante</option>
            </select>
        </div>
        <div class="form-group">
            <label for="squadraGiocatore">Squadra:</label>
            <select id="squadraGiocatore"></select>
        </div>
        <button class="btn btn-full btn-green" onclick="aggiungiGiocatore()">Aggiungi Giocatore</button>
        <button class="btn btn-full" onclick="tornaMenu()">Torna al Menu</button>
    </div>
    
    <div id="aggiungi-partita" class="sezione">
        <h2>Aggiungi Partita</h2>
        <div class="form-group">
            <label for="squadraCasa">Squadra Casa:</label>
            <select id="squadraCasa"></select>
        </div>
        <div class="form-group">
            <label for="squadraOspite">Squadra Ospite:</label>
            <select id="squadraOspite"></select>
        </div>
        <div class="form-group">
            <label for="golCasa">Gol Casa:</label>
            <input type="number" id="golCasa" min="0">
        </div>
        <div class="form-group">
            <label for="golOspite">Gol Ospite:</label>
            <input type="number" id="golOspite" min="0">
        </div>
        
        <div class="giocatori-partita" id="giocatoriCasa">
            <h3>Giocatori Casa</h3>
            <!-- Popolato dinamicamente -->
        </div>
        <div class="giocatori-partita" id="giocatoriOspite">
            <h3>Giocatori Ospite</h3>
            <!-- Popolato dinamicamente -->
        </div>
        
        <div class="selezione-migliori">
            <h3>Migliori in Campo</h3>
            <div class="migliori-row">
                <div class="form-group">
                    <label for="migliorGiocatore">Miglior Giocatore:</label>
                    <select id="migliorGiocatore"></select>
                    <div class="voto-container">
                        <label for="votoGiocatore">Voto (1-10):</label>
                        <input type="number" id="votoGiocatore" min="1" max="10">
                    </div>
                </div>
                <div class="form-group">
                    <label for="migliorPortiere">Miglior Portiere:</label>
                    <select id="migliorPortiere"></select>
                    <div class="voto-container">
                        <label for="votoPortiere">Voto (1-10):</label>
                        <input type="number" id="votoPortiere" min="1" max="10">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="eventi-salvati" id="eventiSalvatiPartita">
            <h3>Eventi Salvati</h3>
            <!-- Popolato dinamicamente -->
        </div>
        
        <button class="btn btn-full btn-green" onclick="salvaPartita()">Salva Partita</button>
        <button class="btn btn-full btn-red" onclick="cancellaEventi('partita')">Cancella Eventi</button>
        <button class="btn btn-full" onclick="tornaMenu()">Torna al Menu</button>
        
        <div class="lista-partite" id="listaPartite">
            <h2>Partite Salvate</h2>
            <!-- Popolato dinamicamente -->
        </div>
    </div>
    
    <div id="aggiungi-finale" class="sezione">
        <h2>Aggiungi Finale</h2>
        <div class="form-group">
            <label for="squadraCasaFinale">Squadra Casa:</label>
            <select id="squadraCasaFinale"></select>
        </div>
        <div class="form-group">
            <label for="squadraOspiteFinale">Squadra Ospite:</label>
            <select id="squadraOspiteFinale"></select>
        </div>
        <div class="form-group">
            <label for="golCasaFinale">Gol Casa:</label>
            <input type="number" id="golCasaFinale" min="0">
        </div>
        <div class="form-group">
            <label for="golOspiteFinale">Gol Ospite:</label>
            <input type="number" id="golOspiteFinale" min="0">
        </div>
        
        <div class="giocatori-partita" id="giocatoriCasaFinale">
            <h3>Giocatori Casa</h3>
            <!-- Popolato dinamicamente -->
        </div>
        <div class="giocatori-partita" id="giocatoriOspiteFinale">
            <h3>Giocatori Ospite</h3>
            <!-- Popolato dinamicamente -->
        </div>
        
        <div class="selezione-migliori">
            <h3>Migliori in Campo</h3>
            <div class="migliori-row">
                <div class="form-group">
                    <label for="migliorGiocatoreFinale">Miglior Giocatore:</label>
                    <select id="migliorGiocatoreFinale"></select>
                    <div class="voto-container">
                        <label for="votoGiocatoreFinale">Voto (1-10):</label>
                        <input type="number" id="votoGiocatoreFinale" min="1" max="10">
                    </div>
                </div>
                <div class="form-group">
                    <label for="migliorPortiereFinale">Miglior Portiere:</label>
                    <select id="migliorPortiereFinale"></select>
                    <div class="voto-container">
                        <label for="votoPortiereFinale">Voto (1-10):</label>
                        <input type="number" id="votoPortiereFinale" min="1" max="10">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="eventi-salvati" id="eventiSalvatiFinale">
            <h3>Eventi Salvati</h3>
            <!-- Popolato dinamicamente -->
        </div>
        
        <button class="btn btn-full btn-green" onclick="salvaFinale()">Salva Finale</button>
        <button class="btn btn-full btn-red" onclick="cancellaEventi('finale')">Cancella Eventi</button>
        <button class="btn btn-full" onclick="tornaMenu()">Torna al Menu</button>
    </div>
    
    <div id="elimina-dati" class="sezione">
        <h2>Elimina Dati</h2>
        <div class="form-group">
            <label for="tipoElimina">Tipo da Eliminare:</label>
            <select id="tipoElimina" onchange="mostraOpzioniElimina()">
                <option value="">Seleziona...</option>
                <option value="giocatore">Giocatore</option>
                <option value="squadra">Squadra</option>
                <option value="tutto">Tutto</option>
            </select>
        </div>
        <div id="opzioniElimina" class="opzioni-elimina hidden"></div>
        <button id="btnElimina" class="btn btn-full btn-red hidden" onclick="eseguiEliminazione()">Elimina</button>
        <button class="btn btn-full" onclick="tornaMenu()">Torna al Menu</button>
    </div>
    
    <div id="notificaAggiornamento" class="notifica-aggiornamento"></div>

    <script type="module">
        import database from './database-supabase.js';

        let datiTorneo = {
            squadre: [],
            giocatori: [],
            partite: [],
            finale: null
        };
        let eventiTemporanei = { casa: [], ospite: [] }; // Per partite e finale

        // Inizializzazione
        async function initAdmin() {
            aggiornaStatoConnessione('caricamento');
            try {
                await caricaDati();
                popolaSelectSquadre();
                popolaSelectGiocatoriSquadra();
                aggiornaStatoConnessione('ok');
            } catch (error) {
                aggiornaStatoConnessione('ko');
                alert('Errore caricamento dati: ' + error.message);
            }

            // Listener realtime
            window.onDatabaseUpdate = (type) => {
                caricaDati();
                mostraNotificaAggiornamento(type);
            };

            // Controllo periodico connessione
            setInterval(checkConnessione, 30000);
        }

        async function caricaDati() {
            datiTorneo.squadre = await database.getSquadre();
            datiTorneo.giocatori = await database.getGiocatori();
            datiTorneo.partite = await database.getPartite();
            datiTorneo.finale = await database.getFinale();
            caricaPartiteSalvate();
        }

        function popolaSelectSquadre() {
            const selects = [
                document.getElementById('squadraGiocatore'),
                document.getElementById('squadraCasa'),
                document.getElementById('squadraOspite'),
                document.getElementById('squadraCasaFinale'),
                document.getElementById('squadraOspiteFinale')
            ];
            selects.forEach(select => {
                select.innerHTML = '<option value="">Seleziona Squadra...</option>';
                datiTorneo.squadre.forEach(squadra => {
                    const option = document.createElement('option');
                    option.value = squadra.nome;
                    option.textContent = squadra.nome;
                    select.appendChild(option);
                });
            });
        }

        function popolaSelectGiocatoriSquadra() {
            // Per migliori giocatore/portiere in partita e finale
            const selectsGiocatore = [document.getElementById('migliorGiocatore'), document.getElementById('migliorGiocatoreFinale')];
            const selectsPortiere = [document.getElementById('migliorPortiere'), document.getElementById('migliorPortiereFinale')];
            selectsGiocatore.forEach(select => {
                select.innerHTML = '<option value="">Seleziona...</option>';
            });
            selectsPortiere.forEach(select => {
                select.innerHTML = '<option value="">Seleziona...</option>';
            });
            datiTorneo.giocatori.forEach(giocatore => {
                const optionGioc = document.createElement('option');
                optionGioc.value = giocatore.id;
                optionGioc.textContent = `${giocatore.nome} (${giocatore.squadra})`;
                selectsGiocatore.forEach(select => select.appendChild(optionGioc.cloneNode(true)));

                if (giocatore.ruolo === 'Portiere') {
                    const optionPort = document.createElement('option');
                    optionPort.value = giocatore.id;
                    optionPort.textContent = `${giocatore.nome} (${giocatore.squadra})`;
                    selectsPortiere.forEach(select => select.appendChild(optionPort.cloneNode(true)));
                }
            });
        }

        function mostraSezione(id) {
            document.querySelectorAll('.sezione').forEach(sec => sec.classList.remove('attiva'));
            document.getElementById(id).classList.add('attiva');
            document.getElementById('menuAdmin').style.display = 'none';

            if (id === 'aggiungi-partita' || id === 'aggiungi-finale') {
                const casaSelect = id === 'aggiungi-partita' ? 'squadraCasa' : 'squadraCasaFinale';
                const ospiteSelect = id === 'aggiungi-partita' ? 'squadraOspite' : 'squadraOspiteFinale';
                document.getElementById(casaSelect).addEventListener('change', () => caricaGiocatoriPartita(id));
                document.getElementById(ospiteSelect).addEventListener('change', () => caricaGiocatoriPartita(id));
            }
        }

        function tornaMenu() {
            document.querySelectorAll('.sezione').forEach(sec => sec.classList.remove('attiva'));
            document.getElementById('menuAdmin').style.display = 'grid';
            resetForm();
        }

        function resetForm() {
            eventiTemporanei = { casa: [], ospite: [] };
            document.querySelectorAll('input, select').forEach(el => el.value = '');
            document.querySelectorAll('.giocatori-partita').forEach(el => el.innerHTML = '<h3>Giocatori</h3>');
            document.querySelectorAll('.eventi-salvati').forEach(el => el.innerHTML = '<h3>Eventi Salvati</h3>');
        }

        async function aggiungiSquadra() {
            const nome = document.getElementById('nomeSquadra').value.trim();
            const allenatore = document.getElementById('allenatore').value.trim();
            const colori = document.getElementById('colori').value.trim();

            if (!nome) return alert('Nome squadra obbligatorio!');

            try {
                await database.aggiungiSquadra({ nome, allenatore, colori, punti: 0, partite_giocate: 0, vittorie: 0, pareggi: 0, sconfitte: 0, gol_fatti: 0, gol_subiti: 0 });
                alert('Squadra aggiunta!');
                resetForm();
                await caricaDati();
                popolaSelectSquadre();
            } catch (error) {
                alert('Errore: ' + error.message);
            }
        }

        async function aggiungiGiocatore() {
            const nome = document.getElementById('nomeGiocatore').value.trim();
            const ruolo = document.getElementById('ruoloGiocatore').value;
            const squadra = document.getElementById('squadraGiocatore').value;

            if (!nome || !squadra) return alert('Nome e squadra obbligatori!');

            try {
                await database.aggiungiGiocatore({ nome, ruolo, squadra, gol: 0, ammonizioni: 0, espulsioni: 0, premi_miglior_giocatore: 0, premi_miglior_portiere: 0, punteggio_totale: 0 });
                alert('Giocatore aggiunto!');
                resetForm();
                await caricaDati();
                popolaSelectGiocatoriSquadra();
            } catch (error) {
                alert('Errore: ' + error.message);
            }
        }

        function caricaGiocatoriPartita(tipo) {
            const isPartita = tipo === 'aggiungi-partita';
            const casaId = isPartita ? 'giocatoriCasa' : 'giocatoriCasaFinale';
            const ospiteId = isPartita ? 'giocatoriOspite' : 'giocatoriOspiteFinale';
            const casaSelect = isPartita ? 'squadraCasa' : 'squadraCasaFinale';
            const ospiteSelect = isPartita ? 'squadraOspite' : 'squadraOspiteFinale';

            const squadraCasa = document.getElementById(casaSelect).value;
            const squadraOspite = document.getElementById(ospiteSelect).value;

            if (squadraCasa) {
                const giocatoriCasa = datiTorneo.giocatori.filter(g => g.squadra === squadraCasa);
                document.getElementById(casaId).innerHTML = `<h3>Giocatori ${squadraCasa}</h3>` + generaGiocatoriHTML(giocatoriCasa, 'casa', isPartita ? 'partita' : 'finale');
            }

            if (squadraOspite) {
                const giocatoriOspite = datiTorneo.giocatori.filter(g => g.squadra === squadraOspite);
                document.getElementById(ospiteId).innerHTML = `<h3>Giocatori ${squadraOspite}</h3>` + generaGiocatoriHTML(giocatoriOspite, 'ospite', isPartita ? 'partita' : 'finale');
            }
        }

        function generaGiocatoriHTML(giocatori, tipoSquadra, tipoEvento) {
            return giocatori.map(giocatore => `
                <div class="giocatore-item">
                    <div class="giocatore-header">
                        <span>${giocatore.nome} (${giocatore.ruolo})</span>
                    </div>
                    <div class="contatore-row">
                        <span class="contatore-label">Gol:</span>
                        <button class="contatore-btn btn-gol" onclick="modificaEvento('${tipoSquadra}', ${giocatore.id}, 'gol', -1, '${tipoEvento}')">-</button>
                        <span class="contatore-valore" id="gol-${tipoSquadra}-${giocatore.id}-${tipoEvento}">0</span>
                        <button class="contatore-btn btn-gol" onclick="modificaEvento('${tipoSquadra}', ${giocatore.id}, 'gol', 1, '${tipoEvento}')">+</button>
                    </div>
                    <div class="contatore-row">
                        <span class="contatore-label">Ammonizioni:</span>
                        <button class="contatore-btn btn-amm" onclick="modificaEvento('${tipoSquadra}', ${giocatore.id}, 'amm', -1, '${tipoEvento}')">-</button>
                        <span class="contatore-valore" id="amm-${tipoSquadra}-${giocatore.id}-${tipoEvento}">0</span>
                        <button class="contatore-btn btn-amm" onclick="modificaEvento('${tipoSquadra}', ${giocatore.id}, 'amm', 1, '${tipoEvento}')">+</button>
                    </div>
                    <div class="contatore-row">
                        <span class="contatore-label">Espulsioni:</span>
                        <button class="contatore-btn btn-esp" onclick="modificaEvento('${tipoSquadra}', ${giocatore.id}, 'esp', -1, '${tipoEvento}')">-</button>
                        <span class="contatore-valore" id="esp-${tipoSquadra}-${giocatore.id}-${tipoEvento}">0</span>
                        <button class="contatore-btn btn-esp" onclick="modificaEvento('${tipoSquadra}', ${giocatore.id}, 'esp', 1, '${tipoEvento}')">+</button>
                    </div>
                </div>
            `).join('');
        }

        function modificaEvento(tipoSquadra, giocatoreId, tipoEvento, delta, modo) {
            let eventiSquadra = eventiTemporanei[tipoSquadra];
            let evento = eventiSquadra.find(e => e.giocatoreId === giocatoreId && e.tipo === tipoEvento);

            if (!evento) {
                evento = { giocatoreId, tipo: tipoEvento, count: 0 };
                eventiSquadra.push(evento);
            }

            evento.count = Math.max(0, evento.count + delta);
            document.getElementById(`${tipoEvento}-${tipoSquadra}-${giocatoreId}-${modo}`).textContent = evento.count;

            aggiornaEventiSalvati(modo);
        }

        function aggiornaEventiSalvati(modo) {
            const eventiId = modo === 'partita' ? 'eventiSalvatiPartita' : 'eventiSalvatiFinale';
            const html = Object.entries(eventiTemporanei).flatMap(([squadra, eventi]) => 
                eventi.filter(e => e.count > 0).map(e => {
                    const giocatore = datiTorneo.giocatori.find(g => g.id === e.giocatoreId);
                    return `<div class="evento-item">${squadra.toUpperCase()}: ${giocatore.nome} - ${e.tipo.toUpperCase()} x${e.count}</div>`;
                })
            ).join('');
            document.getElementById(eventiId).innerHTML = `<h3>Eventi Salvati</h3>${html || '<p>Nessun evento</p>'}`;
        }

        function cancellaEventi(modo) {
            eventiTemporanei = { casa: [], ospite: [] };
            aggiornaEventiSalvati(modo);
            document.querySelectorAll('.contatore-valore').forEach(el => el.textContent = '0');
        }

        async function salvaPartita() {
            const squadraCasa = document.getElementById('squadraCasa').value;
            const squadraOspite = document.getElementById('squadraOspite').value;
            const golCasa = parseInt(document.getElementById('golCasa').value) || 0;
            const golOspite = parseInt(document.getElementById('golOspite').value) || 0;
            const migliorGiocatoreId = parseInt(document.getElementById('migliorGiocatore').value) || null;
            const votoGiocatore = parseInt(document.getElementById('votoGiocatore').value) || null;
            const migliorPortiereId = parseInt(document.getElementById('migliorPortiere').value) || null;
            const votoPortiere = parseInt(document.getElementById('votoPortiere').value) || null;

            if (!squadraCasa || !squadraOspite) return alert('Seleziona entrambe le squadre!');

            const eventi = [...eventiTemporanei.casa, ...eventiTemporanei.ospite].filter(e => e.count > 0).map(e => ({
                giocatoreId: e.giocatoreId,
                tipo: e.tipo,
                quantita: e.count
            }));

            try {
                const partita = {
                    squadra_casa: squadraCasa,
                    squadra_ospite: squadraOspite,
                    gol_casa: golCasa,
                    gol_ospite: golOspite,
                    eventi: eventi,
                    miglior_giocatore_id: migliorGiocatoreId,
                    voto_miglior_giocatore: votoGiocatore,
                    miglior_portiere_id: migliorPortiereId,
                    voto_miglior_portiere: votoPortiere
                };
                await database.aggiungiPartita(partita);
                await aggiornaStatisticheDopoPartita(partita);
                alert('Partita salvata!');
                resetForm();
                await caricaDati();
            } catch (error) {
                alert('Errore: ' + error.message);
            }
        }

        async function salvaFinale() {
            const squadraCasa = document.getElementById('squadraCasaFinale').value;
            const squadraOspite = document.getElementById('squadraOspiteFinale').value;
            const golCasa = parseInt(document.getElementById('golCasaFinale').value) || 0;
            const golOspite = parseInt(document.getElementById('golOspiteFinale').value) || 0;
            const migliorGiocatoreId = parseInt(document.getElementById('migliorGiocatoreFinale').value) || null;
            const votoGiocatore = parseInt(document.getElementById('votoGiocatoreFinale').value) || null;
            const migliorPortiereId = parseInt(document.getElementById('migliorPortiereFinale').value) || null;
            const votoPortiere = parseInt(document.getElementById('votoPortiereFinale').value) || null;

            if (!squadraCasa || !squadraOspite) return alert('Seleziona entrambe le squadre!');

            const eventi = [...eventiTemporanei.casa, ...eventiTemporanei.ospite].filter(e => e.count > 0).map(e => ({
                giocatoreId: e.giocatoreId,
                tipo: e.tipo,
                quantita: e.count
            }));

            try {
                const finale = {
                    squadra_casa: squadraCasa,
                    squadra_ospite: squadraOspite,
                    gol_casa: golCasa,
                    gol_ospite: golOspite,
                    eventi: eventi,
                    miglior_giocatore_id: migliorGiocatoreId,
                    voto_miglior_giocatore: votoGiocatore,
                    miglior_portiere_id: migliorPortiereId,
                    voto_miglior_portiere: votoPortiere
                };
                await database.salvaFinale(finale);
                await aggiornaStatisticheDopoPartita(finale, true); // true per finale
                alert('Finale salvata!');
                resetForm();
                await caricaDati();
            } catch (error) {
                alert('Errore: ' + error.message);
            }
        }

        async function aggiornaStatisticheDopoPartita(partita, isFinale = false) {
            // Aggiorna squadre
            const squadraCasa = datiTorneo.squadre.find(s => s.nome === partita.squadra_casa);
            const squadraOspite = datiTorneo.squadre.find(s => s.nome === partita.squadra_ospite);

            const updatesCasa = {
                partite_giocate: (squadraCasa.partite_giocate || 0) + 1,
                gol_fatti: (squadraCasa.gol_fatti || 0) + partita.gol_casa,
                gol_subiti: (squadraCasa.gol_subiti || 0) + partita.gol_ospite
            };
            const updatesOspite = {
                partite_giocate: (squadraOspite.partite_giocate || 0) + 1,
                gol_fatti: (squadraOspite.gol_fatti || 0) + partita.gol_ospite,
                gol_subiti: (squadraOspite.gol_subiti || 0) + partita.gol_casa
            };

            if (partita.gol_casa > partita.gol_ospite) {
                updatesCasa.vittorie = (squadraCasa.vittorie || 0) + 1;
                updatesCasa.punti = (squadraCasa.punti || 0) + 3;
                updatesOspite.sconfitte = (squadraOspite.sconfitte || 0) + 1;
            } else if (partita.gol_casa < partita.gol_ospite) {
                updatesOspite.vittorie = (squadraOspite.vittorie || 0) + 1;
                updatesOspite.punti = (squadraOspite.punti || 0) + 3;
                updatesCasa.sconfitte = (squadraCasa.sconfitte || 0) + 1;
            } else {
                updatesCasa.pareggi = (squadraCasa.pareggi || 0) + 1;
                updatesCasa.punti = (squadraCasa.punti || 0) + 1;
                updatesOspite.pareggi = (squadraOspite.pareggi || 0) + 1;
                updatesOspite.punti = (squadraOspite.punti || 0) + 1;
            }

            await database.aggiornaSquadra(squadraCasa.id, updatesCasa);
            await database.aggiornaSquadra(squadraOspite.id, updatesOspite);

            // Aggiorna giocatori per eventi
            for (const evento of partita.eventi) {
                const giocatore = datiTorneo.giocatori.find(g => g.id === evento.giocatoreId);
                const updatesGioc = {};
                if (evento.tipo === 'gol') updatesGioc.gol = (giocatore.gol || 0) + evento.quantita;
                if (evento.tipo === 'amm') updatesGioc.ammonizioni = (giocatore.ammonizioni || 0) + evento.quantita;
                if (evento.tipo === 'esp') updatesGioc.espulsioni = (giocatore.espulsioni || 0) + evento.quantita;
                await database.aggiornaGiocatore(giocatore.id, updatesGioc);
            }

            // Aggiorna migliori
            if (partita.miglior_giocatore_id) {
                const gioc = datiTorneo.giocatori.find(g => g.id === partita.miglior_giocatore_id);
                await database.aggiornaGiocatore(partita.miglior_giocatore_id, {
                    premi_miglior_giocatore: (gioc.premi_miglior_giocatore || 0) + 1,
                    punteggio_totale: (gioc.punteggio_totale || 0) + partita.voto_miglior_giocatore
                });
            }
            if (partita.miglior_portiere_id) {
                const port = datiTorneo.giocatori.find(g => g.id === partita.miglior_portiere_id);
                await database.aggiornaGiocatore(partita.miglior_portiere_id, {
                    premi_miglior_portiere: (port.premi_miglior_portiere || 0) + 1,
                    punteggio_totale: (port.punteggio_totale || 0) + partita.voto_miglior_portiere
                });
            }
        }

        function caricaPartiteSalvate() {
            const lista = document.getElementById('listaPartite');
            lista.innerHTML = '<h2>Partite Salvate</h2>';
            datiTorneo.partite.forEach(partita => {
                const div = document.createElement('div');
                div.classList.add('partita-admin');
                div.innerHTML = `
                    <div class="partita-header">
                        <span>${partita.squadra_casa} ${partita.gol_casa} - ${partita.gol_ospite} ${partita.squadra_ospite}</span>
                        <button class="btn btn-red" onclick="eliminaPartita(${partita.id})">Elimina</button>
                    </div>
                `;
                lista.appendChild(div);
            });
        }

        async function eliminaPartita(id) {
            if (confirm('Eliminare questa partita?')) {
                try {
                    await database.eliminaPartita(id);
                    alert('Partita eliminata!');
                    await caricaDati();
                } catch (error) {
                    alert('Errore: ' + error.message);
                }
            }
        }

        function mostraOpzioniElimina() {
            const tipo = document.getElementById('tipoElimina').value;
            const container = document.getElementById('opzioniElimina');
            const btnElimina = document.getElementById('btnElimina');
            container.classList.add('hidden');
            btnElimina.classList.add('hidden');

            if (!tipo) return;

            let html = '';
            if (tipo === 'giocatore') {
                html = `
                    <label for="giocatoreDaEliminare">Seleziona Giocatore:</label>
                    <select id="giocatoreDaEliminare">
                        <option value="">Seleziona...</option>
                        ${datiTorneo.giocatori.map(g => `<option value="${g.id}">${g.nome} (${g.squadra})</option>`).join('')}
                    </select>
                `;
            } else if (tipo === 'squadra') {
                html = `
                    <label for="squadraDaEliminare">Seleziona Squadra:</label>
                    <select id="squadraDaEliminare">
                        <option value="">Seleziona...</option>
                        ${datiTorneo.squadre.map(s => `<option value="${s.id}">${s.nome}</option>`).join('')}
                    </select>
                    <p><strong>Nota:</strong> Eliminer√† anche tutti i giocatori della squadra.</p>
                `;
            } else if (tipo === 'tutto') {
                html = `
                    <p><strong>‚ö†Ô∏è PERICOLO</strong></p>
                    <p>Questa operazione canceller√† TUTTO!</p>
                    <label><input type="checkbox" id="confermaEliminaTutto"> Confermo</label>
                `;
            }

            container.innerHTML = html;
            container.classList.remove('hidden');
            btnElimina.classList.remove('hidden');
        }

        async function eseguiEliminazione() {
            const tipo = document.getElementById('tipoElimina').value;

            if (tipo === 'giocatore') {
                const id = parseInt(document.getElementById('giocatoreDaEliminare').value);
                if (!id) return alert('Seleziona un giocatore!');
                if (confirm('Eliminare questo giocatore?')) {
                    try {
                        await database.eliminaGiocatore(id);
                        alert('Giocatore eliminato!');
                        await caricaDati();
                        mostraOpzioniElimina();
                    } catch (error) {
                        alert('Errore: ' + error.message);
                    }
                }
            } else if (tipo === 'squadra') {
                const id = parseInt(document.getElementById('squadraDaEliminare').value);
                if (!id) return alert('Seleziona una squadra!');
                const squadra = datiTorneo.squadre.find(s => s.id === id);
                const giocatori = datiTorneo.giocatori.filter(g => g.squadra === squadra.nome);
                if (confirm(`Eliminare squadra "${squadra.nome}" e ${giocatori.length} giocatori?`)) {
                    try {
                        for (const g of giocatori) await database.eliminaGiocatore(g.id);
                        await database.eliminaSquadra(id);
                        alert('Squadra eliminata!');
                        await caricaDati();
                        mostraOpzioniElimina();
                    } catch (error) {
                        alert('Errore: ' + error.message);
                    }
                }
            } else if (tipo === 'tutto') {
                const conferma = document.getElementById('confermaEliminaTutto').checked;
                if (!conferma) return alert('Conferma obbligatoria!');
                if (confirm('Sicuro? Tutto verr√† cancellato!')) {
                    try {
                        await database.eliminaTutto();
                        alert('Tutto eliminato!');
                        await caricaDati();
                        mostraOpzioniElimina();
                    } catch (error) {
                        alert('Errore: ' + error.message);
                    }
                }
            }
        }

        function aggiornaStatoConnessione(stato) {
            const el = document.getElementById('connessioneStatus');
            if (stato === 'caricamento') {
                el.className = 'connessione-status connessione-caricamento';
                el.innerHTML = '<div class="loading"></div> Caricamento...';
            } else if (stato === 'ok') {
                el.className = 'connessione-status connessione-ok';
                el.innerHTML = '‚úì Connesso';
            } else if (stato === 'ko') {
                el.className = 'connessione-status connessione-ko';
                el.innerHTML = '‚úó Disconnesso';
            }
        }

        async function checkConnessione() {
            try {
                await database.getSquadre();
                aggiornaStatoConnessione('ok');
            } catch {
                aggiornaStatoConnessione('ko');
            }
        }

        function mostraNotificaAggiornamento(tipo) {
            const notifica = document.getElementById('notificaAggiornamento');
            notifica.textContent = `üîÑ ${tipo} aggiornati!`;
            notifica.style.display = 'block';
            setTimeout(() => notifica.style.display = 'none', 3000);
        }

        function tornaHome() {
            localStorage.removeItem('admin_accesso');
            window.location.href = 'main.html';
        }

        // Controllo accesso
        if (localStorage.getItem('rovigoal_entrato') !== 'true') {
            window.location.href = 'index.html';
        } else if (localStorage.getItem('admin_accesso') !== 'true') {
            const pw = prompt('Password ADMIN:');
            if (pw !== '1246912.!!') {
                alert('Accesso negato!');
                window.location.href = 'main.html';
            } else {
                localStorage.setItem('admin_accesso', 'true');
            }
        }

        // Inizia
        initAdmin();
    </script>
</body>
</html>

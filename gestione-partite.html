<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rovigoal - Gestione Partite</title>
    <style>
        /* RESET E BASICS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        /* HEADER */
        .header {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 3px solid gold;
            position: relative;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        /* CONTAINER */
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* STEP NAVIGATION */
        .step-nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        
        .step.active {
            opacity: 1;
        }
        
        .step-number {
            width: 35px;
            height: 35px;
            background: #1e3c72;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .step.active .step-number {
            background: #FFA500;
            transform: scale(1.1);
        }
        
        .step-label {
            font-size: 0.75em;
            font-weight: bold;
        }
        
        /* STEP CONTENT */
        .step-content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .step-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* FORM ELEMENTS */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
            font-size: 0.9em;
        }
        
        input, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #1e3c72;
            background: white;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }
        
        /* DATE TIME ROW */
        .datetime-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* SQUADRE SELECTION */
        .squadre-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .vs {
            grid-column: span 2;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
            color: #FFA500;
            margin: 10px 0;
        }
        
        /* GOL INPUT */
        .gol-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
        }
        
        .gol-input {
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 3px solid #e9ecef;
        }
        
        .gol-separator {
            font-size: 2em;
            font-weight: bold;
            color: #1e3c72;
        }
        
        /* EVENTI */
        .eventi-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 15px;
        }
        
        .evento-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .evento-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .evento-icon {
            font-size: 1.5em;
        }
        
        .evento-testo {
            font-size: 0.9em;
        }
        
        .evento-giocatore {
            font-weight: bold;
        }
        
        .btn-remove {
            background: #dc143c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        /* FORM AGGIUNGI EVENTO */
        .form-aggiungi-evento {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .evento-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }
        
        /* BUTTONS */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-danger {
            background: #dc143c;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* NAVIGATION BUTTONS */
        .nav-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-nav {
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-prev {
            background: #6c757d;
            color: white;
        }
        
        .btn-next {
            background: #1e3c72;
            color: white;
        }
        
        .btn-submit {
            background: #28a745;
            color: white;
            grid-column: span 2;
        }
        
        /* ALERTS */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* STATUS */
        .status-bar {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        /* CONNESSIONE STATUS */
        .connessione-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .connessione-ok {
            background: #4CAF50;
            color: white;
            border: 2px solid #45a049;
        }
        
        .connessione-caricamento {
            background: #FFA500;
            color: white;
            border: 2px solid #FF8C00;
        }
        
        .connessione-ko {
            background: #f44336;
            color: white;
            border: 2px solid #d32f2f;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* SPECIAL CLASSES */
        .highlight {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .small-note {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* RISULTATO DISPLAY */
        .risultato-display {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: #e7f5ff;
            border: 2px solid #1c7ed6;
        }
        
        .risultato-display h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }
        
        /* WARNING BOX */
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            display: none;
        }
        
        /* FORM ERROR */
        .error-border {
            border-color: #dc143c !important;
            background: #fff5f5 !important;
        }
        
        /* REQUIRED FIELD */
        .required-field::after {
            content: " *";
            color: #dc143c;
        }
        
        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .step-nav {
                padding: 10px;
            }
            
            .step-label {
                font-size: 0.7em;
            }
            
            .step-content {
                padding: 20px;
            }
            
            .datetime-row,
            .squadre-row {
                grid-template-columns: 1fr;
            }
            
            .vs {
                grid-column: span 1;
                margin: 5px 0;
            }
            
            .gol-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .gol-separator {
                display: none;
            }
            
            .evento-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .nav-buttons {
                grid-template-columns: 1fr;
            }
            
            .btn-submit {
                grid-column: span 1;
            }
            
            input, select {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- STATUS BAR -->
    <div class="status-bar" id="statusBar">
        ‚úì Connesso
    </div>
    
    <div class="header">
        <h1>üìÖ CREA PARTITA</h1>
        <p>Guida passo-passo per registrare una partita</p>
        
        <!-- STATO CONNESSIONE -->
        <div id="connessioneStatus" class="connessione-status connessione-caricamento">
            <div class="loading"></div> Caricamento...
        </div>
    </div>
    
    <div class="container">
        <!-- STEP NAVIGATION -->
        <div class="step-nav">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">INFO BASE</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">RISULTATO</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">EVENTI</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">PREMI</div>
            </div>
        </div>
        
        <!-- ALERTS -->
        <div id="alertSuccess" class="alert alert-success" style="display: none;"></div>
        <div id="alertError" class="alert alert-error" style="display: none;"></div>
        <div id="alertWarning" class="alert alert-warning" style="display: none;"></div>
        
        <!-- STEP 1: INFO BASE -->
        <div class="step-content active" id="step1">
            <h2>üìù Informazioni Partita</h2>
            
            <div class="form-group">
                <label for="partitaData" class="required-field">Data Partita</label>
                <input type="date" id="partitaData" value="">
            </div>
            
            <div class="form-group">
                <label for="partitaOra" class="required-field">Orario</label>
                <input type="time" id="partitaOra" value="15:00">
            </div>
            
            <div class="form-group">
                <label class="required-field">Squadre</label>
                <div class="squadre-row">
                    <select id="squadraCasa">
                        <option value="">Squadra Casa</option>
                    </select>
                    
                    <div class="vs">VS</div>
                    
                    <select id="squadraOspite">
                        <option value="">Squadra Ospite</option>
                    </select>
                </div>
                <div class="small-note">Seleziona due squadre diverse</div>
            </div>
            
            <div class="highlight">
                <strong>üí° Suggerimento:</strong> Inserisci prima le informazioni base della partita.
                La data e le squadre sono obbligatorie.
            </div>
        </div>
        
        <!-- STEP 2: RISULTATO -->
        <div class="step-content" id="step2">
            <h2>‚öΩ Risultato Finale</h2>
            
            <div class="form-group">
                <label class="required-field">Punteggio</label>
                <div class="gol-row">
                    <input type="number" id="golCasa" min="0" value="0" class="gol-input">
                    <div class="gol-separator">-</div>
                    <input type="number" id="golOspite" min="0" value="0" class="gol-input">
                </div>
            </div>
            
            <div id="vincitoreDisplay" class="risultato-display">
                <h3 id="risultatoTesto">Pareggio 0-0</h3>
                <div id="vincitoreInfo">Entrambe le squadre pareggiano</div>
            </div>
            
            <div class="highlight">
                <strong>üìä Nota:</strong> I gol inseriti qui determinano il risultato ufficiale.
                I gol dei singoli giocatori li aggiungeremo nel prossimo passo.
            </div>
        </div>
        
        <!-- STEP 3: EVENTI -->
        <div class="step-content" id="step3">
            <h2>üéØ Eventi Partita</h2>
            <p style="color: #666; margin-bottom: 20px;">Aggiungi gol, ammonizioni, espulsioni</p>
            
            <!-- WARNING MESSAGGIO -->
            <div id="warningEventi" class="warning-box">
                <strong>‚ö†Ô∏è Attenzione:</strong> Il totale gol degli eventi (<span id="totaleEventiGol">0</span>) non corrisponde al risultato finale (<span id="risultatoFinale">0-0</span>). 
                Controlla gli eventi inseriti prima di procedere.
            </div>
            
            <!-- EVENTI AGGIUNTI -->
            <div class="eventi-container" id="eventiContainer">
                <div style="text-align: center; padding: 30px; color: #666;">
                    <p>Nessun evento aggiunto</p>
                    <p style="font-size: 0.9em;">Usa il form qui sotto per aggiungere il primo evento</p>
                </div>
            </div>
            
            <!-- FORM AGGIUNGI EVENTO -->
            <div class="form-aggiungi-evento">
                <h4 style="margin-bottom: 15px;">‚ûï Aggiungi Evento</h4>
                
                <div class="evento-row">
                    <select id="eventoTipo">
                        <option value="">Tipo evento</option>
                        <option value="gol">‚öΩ Gol</option>
                        <option value="ammonizione">üü® Ammonizione</option>
                        <option value="espulsione">üü• Espulsione</option>
                    </select>
                    
                    <select id="eventoSquadra">
                        <option value="">Squadra</option>
                        <option value="casa">Casa</option>
                        <option value="ospite">Ospite</option>
                    </select>
                    
                    <select id="eventoGiocatore">
                        <option value="">Giocatore</option>
                    </select>
                    
                    <button class="btn btn-primary" onclick="aggiungiEvento()">
                        <span>‚ûï</span> Aggiungi
                    </button>
                </div>
                
                <div id="errorEvento" style="color: #dc143c; margin-top: 10px; display: none; font-size: 0.9em;">
                    Compila tutti i campi per aggiungere un evento!
                </div>
            </div>
            
            <div class="highlight">
                <strong>‚ö†Ô∏è Importante:</strong> I gol qui aggiunti DEVONO corrispondere al risultato finale.
                Controlla il totale gol prima di procedere.
            </div>
        </div>
        
        <!-- STEP 4: PREMI -->
        <div class="step-content" id="step4">
            <h2>‚≠ê Premi Partita</h2>
            <p style="color: #666; margin-bottom: 20px;">Assegna i premi ai migliori giocatori</p>
            
            <div class="form-group">
                <label for="migliorGiocatore" class="required-field">üèÜ Miglior Giocatore</label>
                <select id="migliorGiocatore">
                    <option value="">Seleziona giocatore...</option>
                </select>
                <div class="small-note">Pu√≤ essere di qualsiasi squadra</div>
            </div>
            
            <div class="form-group">
                <label for="votoMigliorGiocatore" class="required-field">Voto (1-10)</label>
                <input type="number" id="votoMigliorGiocatore" min="1" max="10" placeholder="Es: 8" value="">
            </div>
            
            <div class="form-group">
                <label for="portiereCasa" class="required-field">ü•Ö Portiere Casa</label>
                <select id="portiereCasa">
                    <option value="">Seleziona portiere...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="votoPortiereCasa" class="required-field">Voto Portiere Casa (1-10)</label>
                <input type="number" id="votoPortiereCasa" min="1" max="10" placeholder="Es: 7" value="">
            </div>
            
            <div class="form-group">
                <label for="portiereOspite" class="required-field">ü•Ö Portiere Ospite</label>
                <select id="portiereOspite">
                    <option value="">Seleziona portiere...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="votoPortiereOspite" class="required-field">Voto Portiere Ospite (1-10)</label>
                <input type="number" id="votoPortiereOspite" min="1" max="10" placeholder="Es: 7" value="">
            </div>
            
            <div class="highlight">
                <strong>üèÖ Premi:</strong> I voti assegnati qui determinano le classifiche
                dei migliori giocatori e portieri nelle statistiche.
                <br><br>
                <strong>Tutti i campi sono obbligatori!</strong>
            </div>
        </div>
        
        <!-- NAVIGATION BUTTONS -->
        <div class="nav-buttons">
            <button class="btn-nav btn-prev" onclick="prevStep()">
                <span>‚Üê</span> INDIETRO
            </button>
            <button class="btn-nav btn-next" onclick="nextStep()">
                AVANTI <span>‚Üí</span>
            </button>
            <button class="btn-nav btn-submit" onclick="salvaPartita()" style="display: none;">
                ‚úÖ SALVA PARTITA
            </button>
        </div>
        
        <!-- PULSANTE ELIMINA PARTITE (se siamo in modalit√† modifica) -->
        <button class="btn-nav btn-danger" onclick="tornaAllaListaPartite()" style="width: 100%; margin-top: 15px; display: none;" id="btnEliminaPartita">
            üóëÔ∏è ELIMINA QUESTA PARTITA
        </button>
        
        <!-- BACK BUTTON -->
        <button class="btn-nav" onclick="tornaIndietro()" style="width: 100%; margin-top: 15px; background: #6c757d;">
            ‚Üê TORNA ALL'ADMIN
        </button>
    </div>
    
    <script type="module">
        import database from './database-supabase.js';
        
        // VARIABILI GLOBALI
        let squadre = [];
        let giocatori = [];
        let partitaData = {
            eventi: []
        };
        let currentStep = 1;
        let totaleGolCasa = 0;
        let totaleGolOspite = 0;
        let partitaId = null;
        let isModifica = false; // Flag per sapere se stiamo modificando una partita esistente
        
        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                aggiornaStatoConnessione('caricamento');
                
                // Controlla accesso admin
                if (sessionStorage.getItem('admin_accesso') !== 'true') {
                    alert('Accesso non autorizzato!');
                    window.location.href = 'main.html';
                    return;
                }
                
                // Controlla se siamo in modalit√† modifica (da URL)
                const urlParams = new URLSearchParams(window.location.search);
                const idPartitaDaModificare = urlParams.get('modifica');
                if (idPartitaDaModificare) {
                    isModifica = true;
                    await caricaPartitaPerModifica(idPartitaDaModificare);
                }
                
                // Carica dati
                await caricaDati();
                
                // Setup event listeners
                document.getElementById('golCasa').addEventListener('input', aggiornaVincitore);
                document.getElementById('golOspite').addEventListener('input', aggiornaVincitore);
                document.getElementById('squadraCasa').addEventListener('change', aggiornaGiocatoriSelect);
                document.getElementById('squadraOspite').addEventListener('change', aggiornaGiocatoriSelect);
                document.getElementById('eventoSquadra').addEventListener('change', aggiornaGiocatoriEvento);
                
                // Aggiungi validazione in tempo reale per i premi
                document.getElementById('migliorGiocatore').addEventListener('change', validaCampiPremi);
                document.getElementById('votoMigliorGiocatore').addEventListener('input', validaCampiPremi);
                document.getElementById('portiereCasa').addEventListener('change', validaCampiPremi);
                document.getElementById('votoPortiereCasa').addEventListener('input', validaCampiPremi);
                document.getElementById('portiereOspite').addEventListener('change', validaCampiPremi);
                document.getElementById('votoPortiereOspite').addEventListener('input', validaCampiPremi);
                
                // Imposta data odierna di default
                if (!isModifica) {
                    const oggi = new Date().toISOString().split('T')[0];
                    document.getElementById('partitaData').value = oggi;
                }
                
                aggiornaStatoConnessione('ok');
                
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                aggiornaStatoConnessione('ko');
                mostraAlert('Errore nel caricamento dei dati. Riprova pi√π tardi.', 'error');
            }
        });
        
        // CARICA PARTITA PER MODIFICA
        async function caricaPartitaPerModifica(idPartita) {
            try {
                // Carica tutte le partite
                const partite = await database.getPartite();
                const partita = partite.find(p => p.id === idPartita);
                
                if (!partita) {
                    mostraAlert('Partita non trovata!', 'error');
                    return;
                }
                
                partitaId = partita.id;
                
                // Popola i campi con i dati della partita
                document.getElementById('partitaData').value = partita.data || '';
                document.getElementById('partitaOra').value = partita.ora || '15:00';
                document.getElementById('squadraCasa').value = partita.squadra_casa || '';
                document.getElementById('squadraOspite').value = partita.squadra_ospite || '';
                document.getElementById('golCasa').value = partita.gol_casa || 0;
                document.getElementById('golOspite').value = partita.gol_ospite || 0;
                
                // Carica eventi se presenti
                if (partita.eventi && Array.isArray(partita.eventi)) {
                    partitaData.eventi = partita.eventi;
                }
                
                // Popola premi
                document.getElementById('migliorGiocatore').value = partita.miglior_giocatore || '';
                document.getElementById('votoMigliorGiocatore').value = partita.voto_miglior_giocatore || '';
                document.getElementById('portiereCasa').value = partita.portiere_casa || '';
                document.getElementById('votoPortiereCasa').value = partita.voto_portiere_casa || '';
                document.getElementById('portiereOspite').value = partita.portiere_ospite || '';
                document.getElementById('votoPortiereOspite').value = partita.voto_portiere_ospite || '';
                
                // Mostra pulsante elimina
                document.getElementById('btnEliminaPartita').style.display = 'block';
                
                mostraAlert('Caricata partita esistente. Puoi modificare i dati.', 'warning');
                
            } catch (error) {
                console.error('Errore caricamento partita per modifica:', error);
                mostraAlert('Errore nel caricamento della partita da modificare.', 'error');
            }
        }
        
        // CARICA DATI
        async function caricaDati() {
            try {
                // Carica squadre e giocatori in parallelo
                [squadre, giocatori] = await Promise.all([
                    database.getSquadre(),
                    database.getGiocatori()
                ]);
                
                // Aggiorna select squadre
                aggiornaSelectSquadre();
                
                // Aggiorna select giocatori per eventi
                aggiornaGiocatoriEvento();
                
                // Aggiorna select giocatori per premi
                if (!isModifica) {
                    aggiornaGiocatoriSelect();
                } else {
                    // Se siamo in modifica, aspetta che le select squadre siano popolate
                    setTimeout(() => {
                        aggiornaGiocatoriSelect();
                        // Aggiorna eventi visuale
                        aggiornaListaEventi();
                        calcolaTotaleGolEventi();
                    }, 500);
                }
                
                console.log('Dati caricati:', {
                    squadre: squadre.length,
                    giocatori: giocatori.length
                });
                
            } catch (error) {
                console.error('Errore caricamento dati:', error);
                throw error;
            }
        }
        
        // AGGIORNA SELECT SQUADRE
        function aggiornaSelectSquadre() {
            const selectCasa = document.getElementById('squadraCasa');
            const selectOspite = document.getElementById('squadraOspite');
            
            // Salva valori selezionati
            const valoreCasa = selectCasa.value;
            const valoreOspite = selectOspite.value;
            
            // Pulisci opzioni
            while (selectCasa.options.length > 1) selectCasa.remove(1);
            while (selectOspite.options.length > 1) selectOspite.remove(1);
            
            // Aggiungi squadre
            squadre.forEach(squadra => {
                const option = document.createElement('option');
                option.value = squadra.nome;
                option.textContent = squadra.nome;
                selectCasa.appendChild(option.cloneNode(true));
                selectOspite.appendChild(option);
            });
            
            // Ripristina valori selezionati
            if (valoreCasa) selectCasa.value = valoreCasa;
            if (valoreOspite) selectOspite.value = valoreOspite;
        }
        
        // AGGIORNA GIOCATORI PER EVENTI
        function aggiornaGiocatoriEvento() {
            const selectGiocatore = document.getElementById('eventoGiocatore');
            const squadraSelezionata = document.getElementById('eventoSquadra').value;
            const squadraCasa = document.getElementById('squadraCasa').value;
            const squadraOspite = document.getElementById('squadraOspite').value;
            
            // Salva valore selezionato
            const valoreSelezionato = selectGiocatore.value;
            
            // Pulisci opzioni
            while (selectGiocatore.options.length > 1) selectGiocatore.remove(1);
            
            let giocatoriFiltrati = [];
            
            if (squadraSelezionata === 'casa' && squadraCasa) {
                giocatoriFiltrati = giocatori.filter(g => g.squadra === squadraCasa);
            } else if (squadraSelezionata === 'ospite' && squadraOspite) {
                giocatoriFiltrati = giocatori.filter(g => g.squadra === squadraOspite);
            } else {
                // Se nessuna squadra selezionata, mostra tutti i giocatori
                giocatoriFiltrati = giocatori;
            }
            
            // Aggiungi giocatori
            giocatoriFiltrati.forEach(giocatore => {
                const option = document.createElement('option');
                option.value = giocatore.id;
                option.textContent = `${giocatore.nome} ${giocatore.numero ? `(#${giocatore.numero})` : ''}`;
                selectGiocatore.appendChild(option);
            });
            
            // Ripristina valore selezionato se possibile
            if (valoreSelezionato && giocatoriFiltrati.some(g => g.id === valoreSelezionato)) {
                selectGiocatore.value = valoreSelezionato;
            }
        }
        
        // AGGIORNA GIOCATORI PER SELECT (premi)
        function aggiornaGiocatoriSelect() {
            const selectMigliorGiocatore = document.getElementById('migliorGiocatore');
            const selectPortiereCasa = document.getElementById('portiereCasa');
            const selectPortiereOspite = document.getElementById('portiereOspite');
            
            // Salva valori selezionati
            const valoreMiglior = selectMigliorGiocatore.value;
            const valorePortiereCasa = selectPortiereCasa.value;
            const valorePortiereOspite = selectPortiereOspite.value;
            
            // Pulisci tutte le select
            while (selectMigliorGiocatore.options.length > 1) selectMigliorGiocatore.remove(1);
            while (selectPortiereCasa.options.length > 1) selectPortiereCasa.remove(1);
            while (selectPortiereOspite.options.length > 1) selectPortiereOspite.remove(1);
            
            const squadraCasa = document.getElementById('squadraCasa').value;
            const squadraOspite = document.getElementById('squadraOspite').value;
            
            // Aggiungi tutti i giocatori per miglior giocatore
            giocatori.forEach(giocatore => {
                const option = document.createElement('option');
                option.value = giocatore.id;
                option.textContent = `${giocatore.nome} (${giocatore.squadra})`;
                selectMigliorGiocatore.appendChild(option);
            });
            
            // Aggiungi portieri casa
            giocatori.filter(g => g.squadra === squadraCasa && g.ruolo === 'Portiere')
                .forEach(portiere => {
                    const option = document.createElement('option');
                    option.value = portiere.id;
                    option.textContent = portiere.nome;
                    selectPortiereCasa.appendChild(option);
                });
            
            // Aggiungi portieri ospite
            giocatori.filter(g => g.squadra === squadraOspite && g.ruolo === 'Portiere')
                .forEach(portiere => {
                    const option = document.createElement('option');
                    option.value = portiere.id;
                    option.textContent = portiere.nome;
                    selectPortiereOspite.appendChild(option);
                });
            
            // Ripristina valori selezionati
            if (valoreMiglior) selectMigliorGiocatore.value = valoreMiglior;
            if (valorePortiereCasa) selectPortiereCasa.value = valorePortiereCasa;
            if (valorePortiereOspite) selectPortiereOspite.value = valorePortiereOspite;
        }
        
        // AGGIORNA VINCITORE
        function aggiornaVincitore() {
            const golCasa = parseInt(document.getElementById('golCasa').value) || 0;
            const golOspite = parseInt(document.getElementById('golOspite').value) || 0;
            const squadraCasa = document.getElementById('squadraCasa').value;
            const squadraOspite = document.getElementById('squadraOspite').value;
            
            let risultatoTesto = '';
            let vincitoreInfo = '';
            
            if (golCasa > golOspite) {
                risultatoTesto = `Vittoria ${squadraCasa} ${golCasa}-${golOspite}`;
                vincitoreInfo = `${squadraCasa} vince la partita`;
            } else if (golOspite > golCasa) {
                risultatoTesto = `Vittoria ${squadraOspite} ${golOspite}-${golCasa}`;
                vincitoreInfo = `${squadraOspite} vince la partita`;
            } else {
                risultatoTesto = `Pareggio ${golCasa}-${golOspite}`;
                vincitoreInfo = 'Le squadre pareggiano';
            }
            
            document.getElementById('risultatoTesto').textContent = risultatoTesto;
            document.getElementById('vincitoreInfo').textContent = vincitoreInfo;
            
            // Aggiorna anche il warning
            aggiornaWarningGol();
        }
        
        // CALCOLA TOTALE GOL DAGLI EVENTI
        function calcolaTotaleGolEventi() {
            totaleGolCasa = 0;
            totaleGolOspite = 0;
            
            partitaData.eventi.forEach(evento => {
                if (evento.tipo === 'gol') {
                    if (evento.squadra === 'casa') {
                        totaleGolCasa++;
                    } else if (evento.squadra === 'ospite') {
                        totaleGolOspite++;
                    }
                }
            });
            
            // Aggiorna warning
            aggiornaWarningGol();
            
            return { totaleGolCasa, totaleGolOspite };
        }
        
        // AGGIORNA WARNING GOL
        function aggiornaWarningGol() {
            const golCasaInput = parseInt(document.getElementById('golCasa').value) || 0;
            const golOspiteInput = parseInt(document.getElementById('golOspite').value) || 0;
            
            const { totaleGolCasa, totaleGolOspite } = calcolaTotaleGolEventi();
            
            // Aggiorna testo warning
            document.getElementById('totaleEventiGol').textContent = `${totaleGolCasa}-${totaleGolOspite}`;
            document.getElementById('risultatoFinale').textContent = `${golCasaInput}-${golOspiteInput}`;
            
            const warningBox = document.getElementById('warningEventi');
            
            if (totaleGolCasa !== golCasaInput || totaleGolOspite !== golOspiteInput) {
                warningBox.style.display = 'block';
                document.getElementById('eventiContainer').style.borderColor = '#dc143c';
                document.getElementById('eventiContainer').style.backgroundColor = '#fff5f5';
            } else {
                warningBox.style.display = 'none';
                document.getElementById('eventiContainer').style.borderColor = '#28a745';
                document.getElementById('eventiContainer').style.backgroundColor = '#f8f9fa';
            }
        }
        
        // AGGIUNGI EVENTO
        function aggiungiEvento() {
            const tipo = document.getElementById('eventoTipo').value;
            const squadra = document.getElementById('eventoSquadra').value;
            const giocatoreId = document.getElementById('eventoGiocatore').value;
            
            const errorDiv = document.getElementById('errorEvento');
            
            // Validazione
            let error = false;
            if (!tipo) {
                document.getElementById('eventoTipo').classList.add('error-border');
                error = true;
            } else {
                document.getElementById('eventoTipo').classList.remove('error-border');
            }
            
            if (!squadra) {
                document.getElementById('eventoSquadra').classList.add('error-border');
                error = true;
            } else {
                document.getElementById('eventoSquadra').classList.remove('error-border');
            }
            
            if (!giocatoreId) {
                document.getElementById('eventoGiocatore').classList.add('error-border');
                error = true;
            } else {
                document.getElementById('eventoGiocatore').classList.remove('error-border');
            }
            
            if (error) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Compila tutti i campi per aggiungere un evento!';
                return;
            }
            
            errorDiv.style.display = 'none';
            
            // Trova il giocatore
            const giocatore = giocatori.find(g => g.id === giocatoreId);
            if (!giocatore) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Giocatore non trovato! Aggiorna la pagina e riprova.';
                return;
            }
            
            // Verifica che il giocatore appartenga alla squadra corretta
            const squadraCasa = document.getElementById('squadraCasa').value;
            const squadraOspite = document.getElementById('squadraOspite').value;
            
            const squadraGiocatore = squadra === 'casa' ? squadraCasa : squadraOspite;
            
            if (giocatore.squadra !== squadraGiocatore) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = `Il giocatore ${giocatore.nome} non appartiene alla squadra ${squadraGiocatore}!`;
                return;
            }
            
            // Crea evento
            const evento = {
                id: Date.now().toString(),
                tipo: tipo,
                squadra: squadra,
                giocatoreId: giocatoreId,
                giocatoreNome: giocatore.nome,
                timestamp: new Date().toISOString()
            };
            
            // Aggiungi all'array eventi
            partitaData.eventi.push(evento);
            
            // Aggiorna lista visuale
            aggiornaListaEventi();
            
            // Reset form
            document.getElementById('eventoTipo').value = '';
            document.getElementById('eventoSquadra').value = '';
            document.getElementById('eventoGiocatore').value = '';
            
            // Aggiorna totale gol e warning
            calcolaTotaleGolEventi();
            
            mostraAlert('Evento aggiunto con successo!', 'success');
        }
        
        // AGGIORNA LISTA EVENTI VISUALE
        function aggiornaListaEventi() {
            const container = document.getElementById('eventiContainer');
            
            if (partitaData.eventi.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #666;">
                        <p>Nessun evento aggiunto</p>
                        <p style="font-size: 0.9em;">Usa il form qui sotto per aggiungere il primo evento</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            partitaData.eventi.forEach((evento, index) => {
                let icona = 'üìù';
                let testo = '';
                let colore = '#666';
                
                switch(evento.tipo) {
                    case 'gol':
                        icona = '‚öΩ';
                        testo = `Gol di ${evento.giocatoreNome}`;
                        colore = '#228B22';
                        break;
                    case 'ammonizione':
                        icona = 'üü®';
                        testo = `Ammonizione per ${evento.giocatoreNome}`;
                        colore = '#FFA500';
                        break;
                    case 'espulsione':
                        icona = 'üü•';
                        testo = `Espulsione di ${evento.giocatoreNome}`;
                        colore = '#DC143C';
                        break;
                }
                
                const squadraTesto = evento.squadra === 'casa' ? 'Casa' : 'Ospite';
                
                html += `
                    <div class="evento-item">
                        <div class="evento-info">
                            <div class="evento-icon" style="color: ${colore};">${icona}</div>
                            <div class="evento-testo">
                                <strong>${testo}</strong><br>
                                <small>Squadra: ${squadraTesto}</small>
                            </div>
                        </div>
                        <button class="btn-remove" onclick="rimuoviEvento(${index})">
                            ‚ùå
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // RIMUOVI EVENTO
        function rimuoviEvento(index) {
            if (confirm('Sei sicuro di voler rimuovere questo evento?')) {
                partitaData.eventi.splice(index, 1);
                aggiornaListaEventi();
                calcolaTotaleGolEventi();
                mostraAlert('Evento rimosso!', 'success');
            }
        }
        
        // VALIDA CAMPI PREMI
        function validaCampiPremi() {
            const campi = [
                { id: 'migliorGiocatore', value: document.getElementById('migliorGiocatore').value },
                { id: 'votoMigliorGiocatore', value: document.getElementById('votoMigliorGiocatore').value },
                { id: 'portiereCasa', value: document.getElementById('portiereCasa').value },
                { id: 'votoPortiereCasa', value: document.getElementById('votoPortiereCasa').value },
                { id: 'portiereOspite', value: document.getElementById('portiereOspite').value },
                { id: 'votoPortiereOspite', value: document.getElementById('votoPortiereOspite').value }
            ];
            
            let tuttiValidi = true;
            
            campi.forEach(campo => {
                const elemento = document.getElementById(campo.id);
                if (!campo.value || campo.value === '') {
                    elemento.classList.add('error-border');
                    tuttiValidi = false;
                } else {
                    elemento.classList.remove('error-border');
                    
                    // Validazione speciale per voti
                    if (campo.id.includes('voto')) {
                        const voto = parseInt(campo.value);
                        if (isNaN(voto) || voto < 1 || voto > 10) {
                            elemento.classList.add('error-border');
                            tuttiValidi = false;
                        }
                    }
                }
            });
            
            return tuttiValidi;
        }
        
        // NAVIGAZIONE STEP
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                cambiaStep(currentStep);
            }
        }
        
        function nextStep() {
            // Validazione step corrente
            if (!validaStep(currentStep)) {
                return;
            }
            
            if (currentStep < 4) {
                currentStep++;
                cambiaStep(currentStep);
            }
        }
        
        function cambiaStep(step) {
            // Nascondi tutti i step
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Rimuovi active da tutti i step indicator
            document.querySelectorAll('.step').forEach(stepEl => {
                stepEl.classList.remove('active');
            });
            
            // Mostra step corrente
            document.getElementById(`step${step}`).classList.add('active');
            
            // Attiva step indicator
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            
            // Mostra/nascondi pulsanti
            const btnSubmit = document.querySelector('.btn-submit');
            if (step === 4) {
                btnSubmit.style.display = 'flex';
            } else {
                btnSubmit.style.display = 'none';
            }
        }
        
        // VALIDA STEP
        function validaStep(step) {
            switch(step) {
                case 1:
                    const data = document.getElementById('partitaData').value;
                    const squadraCasa = document.getElementById('squadraCasa').value;
                    const squadraOspite = document.getElementById('squadraOspite').value;
                    
                    let errorStep1 = false;
                    
                    if (!data) {
                        document.getElementById('partitaData').classList.add('error-border');
                        mostraAlert('Inserisci la data della partita!', 'error');
                        errorStep1 = true;
                    } else {
                        document.getElementById('partitaData').classList.remove('error-border');
                    }
                    
                    if (!squadraCasa) {
                        document.getElementById('squadraCasa').classList.add('error-border');
                        mostraAlert('Seleziona la squadra casa!', 'error');
                        errorStep1 = true;
                    } else {
                        document.getElementById('squadraCasa').classList.remove('error-border');
                    }
                    
                    if (!squadraOspite) {
                        document.getElementById('squadraOspite').classList.add('error-border');
                        mostraAlert('Seleziona la squadra ospite!', 'error');
                        errorStep1 = true;
                    } else {
                        document.getElementById('squadraOspite').classList.remove('error-border');
                    }
                    
                    if (squadraCasa && squadraOspite && squadraCasa === squadraOspite) {
                        mostraAlert('Le squadre devono essere diverse!', 'error');
                        errorStep1 = true;
                    }
                    
                    return !errorStep1;
                    
                case 2:
    const golCasa = parseInt(document.getElementById('golCasa').value) || 0;
    const golOspite = parseInt(document.getElementById('golOspite').value) || 0;
    
    // Validazione base: i gol devono essere numeri
    if (isNaN(golCasa) || isNaN(golOspite)) {
        mostraAlert('Inserisci un punteggio valido per entrambe le squadre!', 'error');
        return false;
    }
    
    // Controlla che i gol non siano negativi
    if (golCasa < 0 || golOspite < 0) {
        mostraAlert('Il punteggio non pu√≤ essere negativo!', 'error');
        return false;
    }
    
    // Controlla che i gol degli eventi corrispondano (SOLO se ci sono eventi)
    if (partitaData.eventi.length > 0) {
        const { totaleGolCasa, totaleGolOspite } = calcolaTotaleGolEventi();
        
        if (totaleGolCasa !== golCasa || totaleGolOspite !== golOspite) {
            const conferma = confirm(`‚ö†Ô∏è ATTENZIONE!\n\nI gol degli eventi (${totaleGolCasa}-${totaleGolOspite}) non corrispondono al risultato finale (${golCasa}-${golOspite}).\n\nVuoi continuare comunque?`);
            
            if (!conferma) {
                // Torna al step 3 per correggere
                setTimeout(() => {
                    currentStep = 3;
                    cambiaStep(3);
                }, 100);
                return false;
            }
        }
    }
    
    return true;
                    
                case 3:
                    // Il step 3 non blocca il passaggio, ma mostra warning
                    return true;
                    
                case 4:
                    // Validazione stretta per premi
                    if (!validaCampiPremi()) {
                        mostraAlert('Compila tutti i campi dei premi correttamente! I voti devono essere tra 1 e 10.', 'error');
                        return false;
                    }
                    return true;
                    
                default:
                    return true;
            }
        }
        
        // SALVA PARTITA
        async function salvaPartita() {
            try {
                // Validazione finale
                if (!validaStep(4)) {
                    return;
                }
                
                aggiornaStatoConnessione('caricamento');
                
                // Raccogli tutti i dati
                const dataPartita = document.getElementById('partitaData').value;
                const oraPartita = document.getElementById('partitaOra').value;
                const squadraCasa = document.getElementById('squadraCasa').value;
                const squadraOspite = document.getElementById('squadraOspite').value;
                const golCasa = parseInt(document.getElementById('golCasa').value) || 0;
                const golOspite = parseInt(document.getElementById('golOspite').value) || 0;
                const migliorGiocatore = document.getElementById('migliorGiocatore').value;
                const votoMigliorGiocatore = parseInt(document.getElementById('votoMigliorGiocatore').value) || 0;
                const portiereCasa = document.getElementById('portiereCasa').value;
                const portiereOspite = document.getElementById('portiereOspite').value;
                const votoPortiereCasa = parseInt(document.getElementById('votoPortiereCasa').value) || 0;
                const votoPortiereOspite = parseInt(document.getElementById('votoPortiereOspite').value) || 0;
                
                // Crea oggetto partita per Supabase
                const partitaSupabase = {
                    data: dataPartita,
                    ora: oraPartita,
                    squadra_casa: squadraCasa,
                    squadra_ospite: squadraOspite,
                    gol_casa: golCasa,
                    gol_ospite: golOspite,
                    eventi: partitaData.eventi,
                    miglior_giocatore: migliorGiocatore || null,
                    voto_miglior_giocatore: votoMigliorGiocatore || null,
                    portiere_casa: portiereCasa || null,
                    portiere_ospite: portiereOspite || null,
                    voto_portiere_casa: votoPortiereCasa || null,
                    voto_portiere_ospite: votoPortiereOspite || null
                };
                
                console.log('Salvataggio partita:', partitaSupabase);
                
                let partitaSalvata;
                
                if (isModifica && partitaId) {
                    // Modalit√† modifica
                    partitaSalvata = await database.aggiornaPartita(partitaId, partitaSupabase);
                    mostraAlert('Partita aggiornata con successo! Statistiche aggiornate.', 'success');
                } else {
                    // Modalit√† nuova partita
                    partitaSalvata = await database.aggiungiPartita(partitaSupabase);
                    partitaId = partitaSalvata.id;
                    mostraAlert('Partita salvata con successo! Statistiche aggiornate.', 'success');
                }
                
                // AGGIORNA STATISTICHE GIOCATORI
                for (const evento of partitaData.eventi) {
                    const giocatore = giocatori.find(g => g.id === evento.giocatoreId);
                    if (giocatore) {
                        let datiAggiornati = {};
                        
                        switch(evento.tipo) {
                            case 'gol':
                                datiAggiornati.gol = (giocatore.gol || 0) + 1;
                                break;
                            case 'ammonizione':
                                datiAggiornati.ammonizioni = (giocatore.ammonizioni || 0) + 1;
                                break;
                            case 'espulsione':
                                datiAggiornati.espulsioni = (giocatore.espulsioni || 0) + 1;
                                break;
                        }
                        
                        if (Object.keys(datiAggiornati).length > 0) {
                            await database.aggiornaGiocatore(giocatore.id, datiAggiornati);
                        }
                    }
                }
                
                // AGGIORNA PREMI GIOCATORI
                if (migliorGiocatore && votoMigliorGiocatore > 0) {
                    const giocatoreMiglior = giocatori.find(g => g.id === migliorGiocatore);
                    if (giocatoreMiglior) {
                        const datiAggiornati = {
                            punteggio_totale: (giocatoreMiglior.punteggio_totale || 0) + votoMigliorGiocatore,
                            premi_miglior_giocatore: (giocatoreMiglior.premi_miglior_giocatore || 0) + 1
                        };
                        await database.aggiornaGiocatore(migliorGiocatore, datiAggiornati);
                    }
                }
                
                if (portiereCasa && votoPortiereCasa > 0) {
                    const portiereCasaObj = giocatori.find(g => g.id === portiereCasa);
                    if (portiereCasaObj) {
                        const datiAggiornati = {
                            punteggio_totale: (portiereCasaObj.punteggio_totale || 0) + votoPortiereCasa,
                            premi_miglior_portiere: (portiereCasaObj.premi_miglior_portiere || 0) + 1
                        };
                        await database.aggiornaGiocatore(portiereCasa, datiAggiornati);
                    }
                }
                
                if (portiereOspite && votoPortiereOspite > 0) {
                    const portiereOspiteObj = giocatori.find(g => g.id === portiereOspite);
                    if (portiereOspiteObj) {
                        const datiAggiornati = {
                            punteggio_totale: (portiereOspiteObj.punteggio_totale || 0) + votoPortiereOspite,
                            premi_miglior_portiere: (portiereOspiteObj.premi_miglior_portiere || 0) + 1
                        };
                        await database.aggiornaGiocatore(portiereOspite, datiAggiornati);
                    }
                }
                
                // AGGIORNA CLASSIFICA SQUADRE
                let risultatoCasa, risultatoOspite;
                
                if (golCasa > golOspite) {
                    risultatoCasa = 'vittoria';
                    risultatoOspite = 'sconfitta';
                } else if (golOspite > golCasa) {
                    risultatoCasa = 'sconfitta';
                    risultatoOspite = 'vittoria';
                } else {
                    risultatoCasa = 'pareggio';
                    risultatoOspite = 'pareggio';
                }
                
                // Funzione per aggiornare classifica squadre
                async function aggiornaClassificaSquadra(squadraNome, risultato, golFatti, golSubiti) {
                    try {
                        const squadra = squadre.find(s => s.nome === squadraNome);
                        if (!squadra) return;
                        
                        const datiAggiornati = {
                            partite_giocate: (squadra.partite_giocate || 0) + 1,
                            gol_fatti: (squadra.gol_fatti || 0) + golFatti,
                            gol_subiti: (squadra.gol_subiti || 0) + golSubiti
                        };
                        
                        if (risultato === 'vittoria') {
                            datiAggiornati.vittorie = (squadra.vittorie || 0) + 1;
                            datiAggiornati.punti = (squadra.punti || 0) + 3;
                        } else if (risultato === 'pareggio') {
                            datiAggiornati.pareggi = (squadra.pareggi || 0) + 1;
                            datiAggiornati.punti = (squadra.punti || 0) + 1;
                        } else if (risultato === 'sconfitta') {
                            datiAggiornati.sconfitte = (squadra.sconfitte || 0) + 1;
                        }
                        
                        await database.aggiornaSquadra(squadra.id, datiAggiornati);
                        
                    } catch (error) {
                        console.error(`Errore aggiornamento squadra ${squadraNome}:`, error);
                    }
                }
                
                // Aggiorna entrambe le squadre
                await aggiornaClassificaSquadra(squadraCasa, risultatoCasa, golCasa, golOspite);
                await aggiornaClassificaSquadra(squadraOspite, risultatoOspite, golOspite, golCasa);
                
                aggiornaStatoConnessione('ok');
                
                // Reset form dopo 3 secondi
                setTimeout(() => {
                    if (!isModifica) {
                        resetForm();
                    } else {
                        // Se siamo in modifica, mostra messaggio e rimani sulla pagina
                        mostraAlert('Partita aggiornata! Puoi continuare a modificare o tornare indietro.', 'success');
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Errore salvataggio partita:', error);
                aggiornaStatoConnessione('ko');
                mostraAlert('Errore nel salvataggio della partita: ' + error.message, 'error');
            }
        }
        
        // ELIMINA PARTITA
        async function eliminaPartita() {
            if (!partitaId) {
                mostraAlert('Nessuna partita da eliminare!', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ATTENZIONE!\n\nSei sicuro di voler eliminare questa partita?\n\nTutte le statistiche collegate (gol, ammonizioni, premi, punti classifica) verranno rimosse!\n\nQuesta operazione √® IRREVERSIBILE!')) {
                return;
            }
            
            try {
                aggiornaStatoConnessione('caricamento');
                
                // Qui dovresti implementare la logica per eliminare la partita
                // E ripristinare le statistiche dei giocatori e delle squadre
                
                // Per ora, mostra un messaggio
                mostraAlert('Funzione di eliminazione partita da implementare completamente.', 'warning');
                
                aggiornaStatoConnessione('ok');
                
            } catch (error) {
                console.error('Errore eliminazione partita:', error);
                mostraAlert('Errore nell\'eliminazione della partita: ' + error.message, 'error');
            }
        }
        
        // RESET FORM
        function resetForm() {
            // Reset campi
            document.getElementById('partitaData').value = new Date().toISOString().split('T')[0];
            document.getElementById('partitaOra').value = '15:00';
            document.getElementById('squadraCasa').value = '';
            document.getElementById('squadraOspite').value = '';
            document.getElementById('golCasa').value = '0';
            document.getElementById('golOspite').value = '0';
            document.getElementById('migliorGiocatore').value = '';
            document.getElementById('votoMigliorGiocatore').value = '';
            document.getElementById('portiereCasa').value = '';
            document.getElementById('votoPortiereCasa').value = '';
            document.getElementById('portiereOspite').value = '';
            document.getElementById('votoPortiereOspite').value = '';
            
            // Reset eventi
            partitaData.eventi = [];
            aggiornaListaEventi();
            
            // Torna al primo step
            currentStep = 1;
            cambiaStep(1);
            
            // Aggiorna giocatori
            aggiornaGiocatoriSelect();
            aggiornaGiocatoriEvento();
            
            // Nascondi pulsante elimina
            document.getElementById('btnEliminaPartita').style.display = 'none';
            
            // Reset modifica flag
            isModifica = false;
            partitaId = null;
        }
        
        // TORNA ALLA LISTA PARTITE (per gestione elimina/modifica)
        function tornaAllaListaPartite() {
            window.location.href = 'lista-partite.html'; // Dovresti creare questa pagina
        }
        
        // FUNZIONI AUSILIARIE
        function mostraAlert(messaggio, tipo = 'success') {
            const alertId = tipo === 'success' ? 'alertSuccess' : (tipo === 'warning' ? 'alertWarning' : 'alertError');
            const alertEl = document.getElementById(alertId);
            
            alertEl.innerHTML = messaggio;
            alertEl.style.display = 'block';
            
            // Scrolla all'alert
            alertEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Nascondi dopo 5 secondi
            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 5000);
        }
        
        function aggiornaStatoConnessione(stato) {
            const statusElement = document.getElementById('connessioneStatus');
            
            switch(stato) {
                case 'caricamento':
                    statusElement.className = 'connessione-status connessione-caricamento';
                    statusElement.innerHTML = '<div class="loading"></div> Caricamento...';
                    break;
                    
                case 'ok':
                    statusElement.className = 'connessione-status connessione-ok';
                    statusElement.innerHTML = '‚úì Connesso';
                    break;
                    
                case 'ko':
                    statusElement.className = 'connessione-status connessione-ko';
                    statusElement.innerHTML = '‚úó Errore';
                    break;
            }
        }
        
        // NAVIGAZIONE
        function tornaIndietro() {
            window.location.href = 'admin.html';
        }
        
        // ESPORTA FUNZIONI
        window.prevStep = prevStep;
        window.nextStep = nextStep;
        window.aggiungiEvento = aggiungiEvento;
        window.rimuoviEvento = rimuoviEvento;
        window.salvaPartita = salvaPartita;
        window.eliminaPartita = eliminaPartita;
        window.tornaIndietro = tornaIndietro;
        window.tornaAllaListaPartite = tornaAllaListaPartite;
        
    </script>
</body>
</html>
